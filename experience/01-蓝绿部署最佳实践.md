# 蓝绿部署最佳实践

**来源**：`docs/服务重启最佳实践.md`  
**适用场景**：生产环境服务更新、配置更新、代码部署

---

## 🎯 核心原则

**永远不要直接重启生产环境，使用蓝绿部署策略实现零停机更新。**

---

## 🔄 标准重启流程

### 场景：用户正在使用 Blue 环境，需要更新配置或代码

```bash
# ========== 阶段 1：准备 ==========
# 1. 确认当前生产环境
docker ps | grep "npc-backend"

# 如果看到 npc-backend-green 在运行 → 当前生产是 Green
# 如果看到 npc-backend（没有-green）在运行 → 当前生产是 Blue

# ========== 阶段 2：更新备用环境 ==========
# 2. 修改配置或代码
nano .env
# 或
git pull origin main

# 3. 重启备用环境（用户不受影响）
# 如果当前生产是 Blue，重启 Green
docker restart npc-backend-green npc-frontend-green

# 如果当前生产是 Green，重启 Blue
docker-compose restart backend frontend

# 4. 等待服务启动（10-30秒）
sleep 15

# 5. 测试备用环境
# 如果重启的是 Green
curl http://localhost:8001/api/v1/health

# 如果重启的是 Blue
curl http://localhost:8000/api/v1/health

# ========== 阶段 3：切换流量 ==========
# 6. 切换流量到更新后的环境（1秒，几乎无感知）
# 如果更新的是 Green
./switch-to-green.sh

# 如果更新的是 Blue
./switch-to-blue.sh

# ========== 阶段 4：更新另一个环境（可选） ==========
# 7. 现在用户访问更新后的环境，可以更新另一个环境了
# 如果刚才更新的是 Green，现在更新 Blue
docker-compose restart backend frontend

# 如果刚才更新的是 Blue，现在更新 Green
docker restart npc-backend-green npc-frontend-green

# 8. 测试另一个环境
curl http://localhost:8000/api/v1/health
# 或
curl http://localhost:8001/api/v1/health
```

---

## ⏱️ 时间对比

| 方式 | 中断时间 | 用户体验 |
|------|---------|---------|
| **直接重启生产** | 6-12秒 | ❌ 用户无法访问 |
| **蓝绿部署策略** | <1秒 | ✅ 几乎无感知 |

---

## 🛡️ 安全检查清单

### 重启前检查：
- [ ] 确认当前生产环境（Blue 还是 Green）
- [ ] 备份配置文件（如果修改了 .env）
- [ ] 确认备用环境可以正常启动
- [ ] 准备回滚方案（如果出问题）

### 重启后检查：
- [ ] 健康检查通过
- [ ] 核心功能正常
- [ ] 日志无错误
- [ ] 用户反馈正常

---

## 🚨 紧急情况处理

如果更新后出现问题：

```bash
# 快速回滚到另一个环境
# 如果 Green 有问题，回滚到 Blue
./switch-to-blue.sh

# 如果 Blue 有问题，回滚到 Green
./switch-to-green.sh

# 回滚时间：<1秒 ✅
```

---

## 💡 最佳实践总结

1. **永远使用蓝绿部署策略**
   - 先更新备用环境
   - 测试通过后切换流量
   - 用户几乎无感知

2. **避免直接重启生产环境**
   - 除非紧急情况
   - 选择低峰期
   - 提前通知用户（如果有用户群）

3. **保持两个环境同步**
   - 更新后确保两个环境都正常
   - 方便快速切换和回滚

4. **监控和验证**
   - 重启后立即验证
   - 观察日志和用户反馈
   - 准备回滚方案

---

## 🔍 快速判断当前生产环境

```bash
# 方法一：检查 Nginx 配置
docker exec npc-nginx cat /etc/nginx/conf.d/default.conf | grep "server npc-backend"

# 如果看到 "npc-backend-green" → 当前生产是 Green
# 如果看到 "backend:8000" → 当前生产是 Blue

# 方法二：检查容器运行状态
docker ps | grep "npc-backend-green"
# 如果运行 → 可能是生产环境（需要确认 Nginx 配置）
```

---

