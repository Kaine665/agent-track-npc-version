# 开发进度记录

> 本文档用于记录开发进度，方便与 AI 助手同步消息。
> 每次完成任务后，请更新本文档。
>
> **重要规范**：AI 助手在记录日志时，必须先通过工具获取当天时间，确保日期准确。

---

## 项目状态

**当前版本**：v1.5（开发中）  
**V1.0.0 版本**：✅ **已完成**（2025-11-22，生产环境运行中）

---

## V1.0.0 版本总结（已完成）

### 核心功能

- ✅ 用户认证（登录/注册，基础实现）
- ✅ NPC 管理（创建、列表、详情）
- ✅ AI 对话（支持多 LLM 提供商，短轮询方案）
- ✅ 对话历史（历史记录、会话列表）
- ✅ Markdown 渲染（代码高亮、表格等）
- ✅ 移动端自适应
- ✅ Docker 部署（生产环境）
- ✅ SPA 路由支持

### 技术架构

- **后端**：Node.js + Express.js + MySQL
- **前端**：React 18 + Vite + Ant Design
- **数据库**：MySQL（已迁移完成）
- **部署**：Docker + Docker Compose + Nginx

### 开发里程碑

- 2025-11-19：项目启动，确定技术栈
- 2025-11-20：前后端项目初始化，NPC API 完成
- 2025-11-21：对话系统完成，数据库迁移完成
- 2025-11-22：前端对接完成，移动端优化，v1.0.0 版本发布

---

## V1.5 版本开发进度（进行中）

### 版本目标

完善基础功能、增强安全性、提升用户体验

### 功能清单

#### P0 优先级（必须实现）

- [x] ✅ 密码功能（简化版：账号密码双重匹配，不使用JWT）
- [x] ✅ JWT Token 认证（2025-11-24）
- [ ] ⏳ API 限流（简单版：内存存储）
- [x] ✅ NPC 编辑和删除（2025-11-24）
- [ ] ⏳ 对话搜索功能（不做筛选）
- [x] ✅ 对话交互增强（基础功能）
  - [x] ✅ 一键复制整段回答
  - [x] ✅ 复制代码块（单独复制按钮）
  - [x] ✅ 复制单次AI回复（在每条AI消息下方）
  - [x] ✅ 数据导出功能（文本、Word、Markdown格式）
  - [x] ✅ 重新生成回答（2025-01-22）
  - [x] ✅ 编辑问题并重新生成（2025-01-22）
  - [x] ✅ 收起/展开回答（默认展开，收起时只显示2行）（2025-11-24）

#### P1 优先级（强烈建议）

- [x] ✅ 用户反馈功能（2025-01-XX）
- [x] ✅ 数据导入导出功能
- [x] ✅ 错误日志和监控（简单版：winston + 文件）
- [x] ✅ 数据备份机制（简单版：mysqldump）

---

## V1.5 已完成任务

### NPC 编辑和删除功能

- [x] **任务：NPC 编辑和删除功能**（2025-11-24）
  - [x] 数据库迁移
    - [x] 创建迁移脚本：`migrations/005_add_soft_delete_to_agents.sql`
    - [x] 添加 `deleted` 和 `deleted_at` 字段
    - [x] 创建索引优化查询性能
  - [x] 后端实现
    - [x] Repository层：添加 `update` 方法，更新 `findByUserId` 和 `findById` 支持软删除
    - [x] Service层：添加 `updateAgent` 方法（权限验证、字段验证、名称唯一性检查）
    - [x] Service层：添加 `deleteAgent` 方法（支持软删除和硬删除）
    - [x] 路由层：添加 `PUT /api/v1/agents/:id` 更新路由
    - [x] 路由层：添加 `DELETE /api/v1/agents/:id` 删除路由
  - [x] 前端实现
    - [x] API适配层：在 `adapter.js`、`httpAdapter.js`、`mockAdapter.js` 中添加 `update` 和 `delete` 方法
    - [x] 创建 `AgentEditModal` 编辑模态框组件
    - [x] 更新 `AgentCard` 组件：添加操作菜单（编辑/删除按钮）
    - [x] 更新 `AgentList` 页面：集成编辑和删除功能，添加删除确认对话框
  - [x] 功能特性
    - [x] 编辑功能：支持修改名称、人设描述、AI模型，包含完整的表单验证和权限验证
    - [x] 删除功能：默认软删除（数据保留），可选硬删除（物理删除），包含删除确认
    - [x] 用户体验：操作按钮集成在卡片右上角，编辑模态框表单预填充，操作成功后自动刷新列表
  - [x] 验收：NPC编辑和删除功能测试通过 ✅

### 用户反馈功能

- [x] **任务：用户反馈功能**（2025-01-XX）
  - [x] 后端实现
    - [x] 数据库表结构（feedbacks表，包含类型、状态、用户环境信息等字段）
    - [x] FeedbackRepository（数据访问层，支持创建、查询、分页、筛选）
    - [x] FeedbackService（业务逻辑层，包含验证、权限检查）
    - [x] 反馈路由（POST提交、GET列表、GET详情）
    - [x] 自动获取用户环境信息（浏览器、平台、语言等）
  - [x] 前端实现
    - [x] 反馈表单页面（类型选择、标题、内容输入）
    - [x] 历史反馈抽屉（查看历史反馈列表）
    - [x] API适配器（HTTP和Mock实现）
    - [x] 路由注册和导航入口
  - [x] 验收：用户反馈功能测试通过 ✅

### 密码登录功能

- [x] **任务：密码登录和忘记密码功能**（2025-11-24）
  - [x] 后端实现
    - [x] 修改登录逻辑：密码必填，账号密码双重匹配验证
    - [x] 修改注册逻辑：密码可选，不填则默认设置为123456
    - [x] 实现忘记密码功能：`POST /api/v1/users/forgot-password`
    - [x] 添加 `UserRepository.updatePassword()` 方法
    - [x] 添加 `UserService.forgotPassword()` 方法（包含账号存在性验证）
  - [x] 前端实现
    - [x] 修改登录弹窗：密码字段改为必填
    - [x] 修改注册页面：密码字段改为可选，提示默认密码
    - [x] 创建忘记密码弹窗组件（`ForgotPasswordModal.jsx`）
    - [x] 在登录弹窗中添加"忘记密码？"链接
    - [x] 在API适配器中添加 `forgotPassword` 方法（HTTP和Mock）
  - [x] 数据库迁移
    - [x] 创建迁移脚本：`migrations/003_set_default_password.sql`
    - [x] 创建执行脚本：`scripts/set-default-password.js`
    - [x] 功能：为数据库中密码为空或NULL的用户设置默认密码123456
  - [x] 验收：密码登录、忘记密码功能测试通过 ✅

### JWT Token 认证功能

- [x] **任务：JWT Token 认证功能**（2025-11-24）
  - [x] 后端实现
    - [x] 安装依赖：`jsonwebtoken`
    - [x] 创建JWT工具类（`utils/jwt.js`）：生成Access Token、Refresh Token、验证Token
    - [x] 创建认证中间件（`middleware/auth.js`）：强制认证和可选认证中间件
    - [x] 更新登录接口：返回Token和用户信息
    - [x] 更新受保护的路由：agents、messages、sessions、history路由添加认证中间件
    - [x] 兼容性处理：支持从Token或查询参数获取userId（向后兼容）
  - [x] 前端实现
    - [x] 更新API适配层：添加Token存储和管理方法（`setToken`, `loadToken`）
    - [x] 请求拦截器：自动添加`Authorization: Bearer <token>`头
    - [x] Token过期处理：401错误时自动清除Token并跳转
    - [x] 更新认证上下文：登录时保存Token，初始化时恢复Token，退出时清除Token
  - [x] 配置更新
    - [x] 更新环境变量示例：添加`JWT_SECRET`配置说明
  - [x] 功能特性
    - [x] Access Token有效期：7天
    - [x] Refresh Token有效期：30天（已实现但未使用）
    - [x] Token自动携带：所有受保护接口自动携带Token
    - [x] Token过期处理：自动清除并跳转登录
  - [x] 验收：JWT认证功能测试通过 ✅

### 对话交互增强功能

- [x] **任务 1：复制单次AI回复功能**（2025-01-24）
  - [x] 创建剪贴板工具函数（`utils/clipboard.js`）
    - [x] 实现 `copyToClipboard()` 函数（支持 Clipboard API 和降级方案）
    - [x] 实现 `formatConversation()` 函数（格式化整个对话，备用）
  - [x] 在 MessageBubble 组件中添加复制按钮
    - [x] 为每条AI消息添加复制按钮（消息气泡下方）
    - [x] 实现复制单条消息内容功能
    - [x] 添加复制状态反馈（显示"已复制"）
    - [x] 优化按钮样式（小号文字按钮，带图标）
  - [x] 验收：每条AI消息下方都有复制按钮，点击可复制单次回复 ✅

- [x] **任务 2：数据导出功能**（2025-11-24）
  - [x] 创建导出工具模块（`utils/export/`）
    - [x] 实现文本（TXT）导出（`exportTXT.js`）
    - [x] 实现 Markdown（MD）导出（`exportMarkdown.js`）
    - [x] 实现 Word（DOCX）导出（`exportWord.js`，使用 docx 库）
    - [x] 实现 PDF 导出（`exportPDF.js`，使用 html2pdf.js，代码保留但前端不显示）
    - [x] 实现长图片导出（`exportImage.js`，使用 html2canvas，代码保留但前端不显示）
    - [x] 创建统一导出入口（`index.js`）
  - [x] 在 Chat 页面集成导出功能
    - [x] 在 Header 右侧添加导出按钮（下载图标）
    - [x] 实现下拉菜单（文本、Word、Markdown）
    - [x] 添加加载提示和错误处理
    - [x] 优化移动端样式
  - [x] 更新依赖包（`package.json`）
    - [x] 添加 `docx`、`file-saver`、`html2canvas`、`html2pdf.js`
  - [x] 验收：导出功能正常工作，支持文本、Word、Markdown 三种格式 ✅

---

## V1.0.0 已完成任务（历史记录，已浓缩）
**V1.0.0 详细开发记录**：已完成所有核心功能，包括前后端初始化、NPC管理、对话系统、用户认证、数据库迁移、Markdown渲染、移动端自适应等。详细记录见文档历史版本。

---

## V1.5 已完成任务（新增）

### 对话交互增强功能（完整实现）

- [x] **任务：重新生成回答和编辑问题功能**（2025-01-22）
  - [x] MessageBubble组件增强
    - [x] AI消息添加"重新生成"按钮（带加载状态）
    - [x] 用户消息添加"编辑"按钮
    - [x] 实现内联编辑功能（TextArea编辑，支持Enter保存、Esc取消）
  - [x] Chat页面逻辑实现
    - [x] 重新生成逻辑：找到对应的用户消息，删除旧AI回复，重新调用API
    - [x] 编辑逻辑：删除该用户消息及其后的所有AI回复，使用新内容重新发送
    - [x] 状态管理：regeneratingMessageId、editingMessageId状态管理
    - [x] 轮询集成：重新生成和编辑后自动触发轮询获取新回复
  - [x] 用户体验优化
    - [x] 按钮加载状态显示
    - [x] 错误处理和提示
    - [x] 操作完成后自动清除状态
  - [x] 验收：重新生成和编辑功能测试通过 ✅

---

## 遇到的问题

> **注意**：所有问题已迁移到 [实现问题记录.md](./实现问题记录.md) 文档中统一管理。
> 
> 已迁移的问题：
> - PROB-007：前端发送消息后，AI 回复不显示
> - PROB-008：刷新 Agent 页面后出现"NPC 不存在或无权访问"错误
> - PROB-009：AgentList 页面首次加载时显示 Mock 状态提示
> - PROB-010：AgentList 页面首次加载时不显示已存在的 agents
> - PROB-011：HTTP 适配器解析非 JSON 响应时出错
>
> 详细内容请查看：[实现问题记录.md](./实现问题记录.md)

---

## V1.5 下一步计划

### 对话交互增强功能（进行中）

- [ ] **任务 2：重新生成回答功能**
  - [ ] 在 MessageBubble 组件中添加"重新生成"按钮
  - [ ] 实现重新生成逻辑（使用相同问题重新调用API）
  - [ ] 添加加载状态和错误处理
  - [ ] 测试重新生成功能

- [ ] **任务 3：编辑问题功能**
  - [ ] 在用户消息上添加"编辑"按钮
  - [ ] 实现内联编辑功能
  - [ ] 实现保存并重新生成逻辑
  - [ ] 测试编辑功能

- [x] **任务 4：收起/展开回答功能**（2025-11-24）
  - [x] 检测回答长度，判断是否需要显示收起按钮
  - [x] 实现收起/展开切换逻辑
  - [x] 添加过渡动画
  - [x] 处理 Markdown 和代码块特殊情况
  - [x] 测试各种内容长度和格式

**详细计划**：请查看 [V1.5 版本规划](./产品文档/v1.5/README.md)

---

## 技术栈选择

- **前端框架**：React
- **后端框架**：Node.js + Express.js（已确定）
- **数据库**：MySQL
- **IDE**：Cursor + Trae
- **测试工具**：Insomnia
- **容器化**：Docker
- **Node.js 版本**：已安装（最新版）

---

## 备注

- 开发环境：Windows 11
- 开发环境配置指南：已创建 `开发环境配置指南.md`
- 项目结构演进指南：已创建并扩展 `项目结构演进指南.md`
  - 包含前后端完整结构演进（后端阶段 0-6，前端阶段 7-12）
  - 添加快速查找索引（按功能、任务、页面查找）
  - 添加完整映射总览表（功能 → 阶段 → 任务 → 文档）
  - 每个阶段都有详细的文档链接
- 已安装软件：Node.js（最新版）、MySQL（已安装但暂不配置连接）
- 待安装软件：Insomnia（可选，用于 API 测试）
- Docker：暂缓安装，初期开发不需要，稍后再安装用于部署和容器化
- **开发策略调整**：
  - 先使用内存数据存储实现后端 API 功能
  - 完成核心功能后再配置数据库连接
  - 这样可以先验证 API 逻辑和接口设计，再迁移到数据库
- **阶段 1 实现细节**：
  - 存储结构：方案 C（独立存储 + 用户关系索引）
  - ID 生成：`agent_${timestamp}_${random}`
  - 模型验证：从环境变量 MODELS 读取（格式：模型名:提供商,模型名:提供商）
  - 数据持久化：开发阶段每次重启清空（内存存储）
  - **userNameIndex 处理**：
    - 保留代码但不使用：虽然已实现 userNameIndex，但当前阶段不使用
    - 原因：单个用户的 Agent 数量不会太多，遍历 agentsByUser 的性能开销可接受
    - 当前实现：使用 agentsByUser 遍历检查名称唯一性（O(n) 查询）
    - 未来扩展：如果用户 Agent 数量增加，可以启用 userNameIndex 以获得 O(1) 查询性能
- **阶段 4 实现细节**：
  - **MessageService 设计决策**：
    - 先同步创建用户消息 Event（保证历史事件完整）
    - 然后异步调用 LLM（在等待期间可以做其他事情）
    - LLM 返回后，同步创建 Agent 回复 Event
  - **Session 单会话模式**：
    - 同一参与者组合（用户 + Agent）只有一个 Session
    - 用户 A 再次和 Agent B 对话，会复用同一个 Session
    - 未来扩展：支持主题自动拆分，将一个 Session 拆分成多个子 Session
- **测试结果**：
  - ✅ 创建 NPC API 测试通过
  - ✅ 获取列表 API 测试通过
  - ✅ 名称唯一性验证测试通过
  - ✅ 字段验证测试通过
  - ✅ 多用户支持测试通过
- **前端实现细节**：
  - **API 适配层架构**：
    - 使用适配器模式，前端维护统一的 API 接口
    - Mock 适配器使用前端 API 格式，HTTP 适配器调用后端 API 并适配格式
    - 通过环境变量 `VITE_API_MODE` 切换 Mock/HTTP 模式
  - **组件封装**：
    - 基于 Ant Design 封装业务组件（Button、Input、Card、Loading）
    - 保持组件接口简洁，符合项目规范
  - **页面实现**：
    - NPC 列表页：横行布局，创建按钮置顶
    - 创建 NPC 页：完整表单验证，错误处理
    - 对话页：消息气泡、历史加载、实时发送、自动滚动
  - **Mock 数据**：
    - 使用内存数据模拟后端 API
    - 支持延迟模拟、错误模拟
    - 数据格式符合 API 设计文档
  - **HTTP 适配器**：
    - 实现统一的 request 方法，处理所有 HTTP 请求
    - 自动适配后端数据格式到前端统一格式
    - 完善的错误处理（网络错误、HTTP 错误、业务错误）
    - 支持通过环境变量切换 Mock/HTTP 模式
  - **API 测试**：
    - 创建了专门的测试页面（/test）
    - 支持测试所有 API 接口
    - 显示详细的测试结果和错误信息
  - **用户认证功能**：
    - 后端：实现了用户登录和注册 API，使用内存存储（后续迁移到数据库）
    - 前端：实现了完整的用户认证 UI，包括登录弹窗、注册页面、状态管理
    - 数据隔离：每个用户只能看到自己创建的 NPC，通过 user.id 过滤数据
    - 持久化：登录状态保存在 localStorage，刷新页面不丢失
    - 用户体验：未登录时显示友好提示，登录后自动加载数据
  - **移动端自适应**：
    - 使用 CSS Modules 实现样式隔离和响应式设计
    - 响应式断点：桌面端（>768px）、平板端（768px-480px）、移动端（<480px）
    - 优化内容：所有页面和组件的布局、字体、间距、头像大小等
    - AgentList：移动端隐藏用户名和注册按钮，优化创建按钮大小
    - Chat：移动端优化输入框和按钮，调整消息气泡宽度
    - CreateAgent：移动端优化表单布局和间距
    - AgentCard：移动端缩小头像和字体，优化卡片内边距
    - MessageBubble：移动端调整气泡宽度和字体大小，优化 Markdown 渲染
- 其他说明：待补充

---

## 更新日志

### V1.5 版本更新日志

| 日期       | 更新内容                                                                             |
| ---------- | ------------------------------------------------------------------------------------ |
| 2025-11-24 | 实现JWT Token认证功能：JWT工具类、认证中间件、登录返回Token、受保护路由添加认证、前端Token管理、Token过期自动处理 ✅ |
| 2025-11-24 | 实现密码登录和忘记密码功能：账号密码双重匹配验证，忘记密码重置功能，数据库迁移脚本 ✅ |
| 2025-01-24 | 实现复制单次AI回复功能：在每条AI消息下方添加复制按钮，支持复制单条消息内容 ✅         |
| 2025-11-24 | 实现数据导出功能：支持导出为文本、Word、Markdown格式，在Chat页面Header添加导出入口 ✅ |
| 2025-01-XX | 实现用户反馈功能：反馈提交、历史反馈查看、自动获取用户环境信息、反馈分类和状态管理 ✅ |
| 2025-11-24 | 实现NPC编辑和删除功能：支持编辑NPC信息（名称、人设、模型），支持软删除和硬删除，包含完整的权限验证和表单验证 ✅ |
| 2025-11-24 | 实现收起/展开回答功能：AI回复超过2行时自动显示收起/展开按钮，使用CSS line-clamp实现2行限制，添加平滑过渡动画 ✅ |
| 2025-01-22 | 实现重新生成回答和编辑问题功能：AI消息添加重新生成按钮，用户消息添加编辑按钮，支持内联编辑和重新生成，自动删除旧回复并获取新回复 ✅ |

### V1.0.0 版本更新日志（历史记录）

| 日期       | 更新内容                                                                             |
| ---------- | ------------------------------------------------------------------------------------ |
| 2025-11-19 | 项目启动，确定技术栈：React + Node.js + MySQL + Docker                               |
| 2025-11-20 | 前后端项目初始化，NPC API 完成                                                       |
| 2025-11-21 | 对话系统完成，数据库迁移完成                                                         |
| 2025-11-22 | 前端对接完成，移动端优化，**v1.0.0 版本发布** ✅                                     |
