# 📊 日志系统使用说明

> 现在你有了完整的日志查看和监控系统，不再需要猜测问题！

## 🎯 快速开始

### 第一步：上传脚本到服务器

如果你在本地开发，需要将这些脚本上传到服务器：

```bash
# 使用 scp 上传（在本地执行）
scp scripts/*.sh user@your-server:/path/to/project/scripts/

# 或者使用 Git 推送
git add scripts/
git commit -m "添加日志查看脚本"
git push
# 然后在服务器上 git pull
```

### 第二步：给脚本添加执行权限（在服务器上）

```bash
cd /path/to/your/project
chmod +x scripts/*.sh
```

---

## 🚀 常用命令（按优先级）

### 1️⃣ 快速检查（最重要！）

**什么时候用**：遇到任何问题时，先运行这个

```bash
./scripts/quick-check.sh
```

**会告诉你**：
- ✅ 哪些服务在运行
- ✅ API Key 是否配置
- ✅ 后端/前端是否正常
- ✅ 最近的错误是什么

---

### 2️⃣ 查看后端日志（AI 响应问题）

**什么时候用**：AI 没有响应时

```bash
./scripts/view-logs.sh backend
```

**然后**：
1. 保持这个窗口打开
2. 在浏览器发送一条消息
3. 观察日志输出，看有什么错误

---

### 3️⃣ 查看前端日志（404 问题）

**什么时候用**：页面刷新后 404

```bash
./scripts/view-logs.sh frontend
```

---

### 4️⃣ 实时监控（持续观察）

**什么时候用**：想持续观察系统状态

```bash
./scripts/monitor.sh
```

**会显示**：
- 容器状态（每 5 秒更新）
- 服务健康状态
- 最近的日志

按 `Ctrl+C` 退出

---

## 📋 实际使用场景

### 场景 1：AI 没有响应

```bash
# 步骤 1：快速检查
./scripts/quick-check.sh

# 步骤 2：查看后端日志（实时）
./scripts/view-logs.sh backend

# 步骤 3：在浏览器发送消息，观察日志
# 如果看到错误，告诉我错误信息
```

### 场景 2：页面刷新 404

```bash
# 步骤 1：查看前端日志
./scripts/view-logs.sh frontend

# 步骤 2：查看 Nginx 日志
./scripts/view-logs.sh nginx

# 步骤 3：检查健康状态
./scripts/check-health.sh
```

### 场景 3：不知道哪里出问题了

```bash
# 步骤 1：快速检查（最重要！）
./scripts/quick-check.sh

# 步骤 2：根据检查结果，查看对应的日志
# 如果后端有问题：./scripts/view-logs.sh backend
# 如果前端有问题：./scripts/view-logs.sh frontend
```

---

## 🔍 日志解读

### 正常日志示例

```
[MessageService] Starting LLM processing for session: session_xxx
[MessageService] Calling LLM API for session: session_xxx
[LLMService] Using API Key 1/1 for openrouter
[MessageService] LLM API returned reply for session: session_xxx
[MessageService] ✅ Agent reply created successfully for session: session_xxx
```

**说明**：一切正常，AI 回复已创建

---

### 错误日志示例

#### 错误 1：API Key 未配置

```
[LLMService] 缺少 openrouter API Key，请设置环境变量 OPENROUTER_API_KEY
```

**解决方案**：
1. 检查 `.env` 文件是否有 `OPENROUTER_API_KEY=xxx`
2. 重启后端：`sudo docker-compose restart backend`

---

#### 错误 2：API Key 无效

```
[LLMService] API Key 1/1 failed (401): User not found., trying next...
```

**解决方案**：
1. API Key 无效或过期，需要更新
2. 更新 `.env` 文件中的 API Key
3. 重启后端：`sudo docker-compose restart backend`

---

#### 错误 3：速率限制

```
[LLMService] API Key 1/1 failed (429): Rate limit exceeded, trying next...
```

**解决方案**：
1. API Key 达到速率限制
2. 等待一段时间后重试
3. 或配置多个 API Key：`OPENROUTER_API_KEY=key1,key2,key3`

---

#### 错误 4：超时

```
[MessageService] ❌ Failed to process LLM reply: LLM_API_TIMEOUT
```

**解决方案**：
1. LLM API 响应慢
2. 检查网络连接
3. 可以等待重试（系统会自动重试）

---

## 💡 实用技巧

### 技巧 1：只看错误日志

```bash
docker logs npc-backend 2>&1 | grep -i error
```

### 技巧 2：只看 LLM 相关日志

```bash
docker logs npc-backend 2>&1 | grep -i "LLM\|MessageService"
```

### 技巧 3：保存日志到文件

```bash
# 保存后端日志
docker logs npc-backend > backend.log 2>&1

# 然后可以用文本编辑器打开查看
```

### 技巧 4：查看最近 100 行日志

```bash
docker logs --tail 100 npc-backend
```

---

## 🆘 如果脚本无法运行

### 问题 1：权限不足

```bash
# 添加执行权限
chmod +x scripts/*.sh
```

### 问题 2：找不到脚本

```bash
# 确保在项目根目录
cd /path/to/your/project

# 检查脚本是否存在
ls -l scripts/
```

### 问题 3：Docker 命令无法执行

```bash
# 检查 Docker 是否运行
docker ps

# 检查 Docker Compose
docker-compose --version
```

---

## 📞 需要帮助时

如果遇到问题，请提供：

1. **快速检查结果**：
   ```bash
   ./scripts/quick-check.sh > check-result.txt
   ```

2. **后端日志**（最近 50 行）：
   ```bash
   docker logs --tail 50 npc-backend > backend-log.txt
   ```

3. **错误截图**或**错误信息**

---

## ✅ 总结

现在你有了一套完整的日志系统：

1. **快速检查** → 一键了解所有问题
2. **日志查看** → 实时查看服务日志
3. **健康检查** → 详细检查服务状态
4. **实时监控** → 持续观察系统状态

**不再需要猜测，所有问题都有日志可查！** 🎉

