# AI NPC 单人世界（V1）产品文档

项目代号：npc-v1

---

# 1. 产品定义（Product Definition）

一句话描述：  
用户可以创建并选择不同的 AI NPC（AI 小人），与其在一个聊天窗口中对话。  
所有 NPC 均基于 LLM 能力，拥有独立的人设与对话历史。

本版本目标：

- 用户可创建多个 NPC
- 每个 NPC 拥有独立的人设、功能和模型选择
- 用户可与任意 NPC 进行一对一对话
- 所有对话记录永久保存在事件记录中
- 前端只有两个人偶：用户本人和当前选中的 NPC
- 不涉及多 NPC 互相对话（未来版本考虑）

---

# 2. 用户场景（Use Cases）

## 2.1 场景 A：创建 NPC

用户希望创建不同风格的 AI NPC，如学习教练、心理导师、通用助手、情绪陪伴 AI 等。  
用户通过表单输入：名字、类型（通用/特定）、人设、模型。  
系统创建 NPC 并加入 NPC 列表。

## 2.2 场景 B：选择 NPC 进行一对一对话

用户进入某个 NPC 的对话页面。  
左边是用户的头像，右边是 NPC 的头像。  
中间是对话气泡列表，底部是输入框。

## 2.3 场景 C：对话历史永久保存

系统记录用户与 NPC 所有对话事件。  
用户可以随时回顾完整历史。

---

# 3. 产品结构（Information Architecture）

用户  
 ├── NPC 列表  
 │ ├── NPC 卡片（头像、名字、类型）  
 │ └── 创建 NPC  
 └── NPC 对话页  
 ├── 聊天记录（事件记录）  
 ├── 输入框  
 └── NPC 信息（名称、人设简介）

---

# 4. 功能需求（Functional Requirements）

## 4.1 NPC 管理系统

### F1：创建 NPC

用户填写：

- 名称
- 类型（通用 / 特定）
- 人设（system prompt）
- 使用模型（如 GPT-4.1）
- 头像（可选）

系统保存 Agent 记录并返回 agentId。

### F2：编辑 NPC（可选 v2）

允许修改人设、模型、头像。

### F3：NPC 列表展示

显示所有用户创建的 NPC，点击进入对话。

---

## 4.2 NPC 对话系统

### F4：发送对话请求

POST /api/message  
Request:

```
{
userId: string,
agentId: string,
text: string
}
```

流程：

1. 写 Event（用户发言）
2. 读取 NPC 配置
3. 获取最近 N 条历史事件（上下文）
4. 拼 LLM prompt
5. 调用 API
6. 写 Event（NPC 回复）
7. 返回回复内容

### F5：获取历史记录

GET /api/history?agentId=xxx&userId=yyy

返回对应 session 的事件列表。

---

## 4.3 事件记录系统（Event Log）

### F6：事件存储

统一记录所有事件：

- 用户发言
- NPC 回复

事件结构：

```
{
id: string,
sessionId: string,
 from: 'user' | 'agent',
fromId: string,
to: 'user' | 'agent',
toId: string,
content: string,
timestamp: number
}
```

---

# 5. 数据结构（Data Model）

## 5.1 Agent（NPC）

```
{
id: string,
name: string,
type: 'general' | 'special',
model: string,
systemPrompt: string,
avatarUrl?: string,
createdAt: number
}
```

## 5.2 Event（事件）

```
{
id: string,
sessionId: string,
from: 'user' | 'agent',
fromId: string,
to: 'user' | 'agent',
toId: string,
content: string,
timestamp: number
}
```

---

# 6. 系统流程（Flow Diagram）

## 6.1 新建 NPC 流程

用户 → 填写 NPC 表单 → 后端创建 Agent → 返回 agentId → NPC 列表刷新

## 6.2 对话流程

用户输入文字  
↓  
写入 Event（用户）  
↓  
构建 Prompt（system + 最近 N 条 events）  
↓  
模型生成回复  
↓  
写入 Event（NPC）  
↓  
返回前端渲染

---

# 7. 前端 UI（简洁版）

## NPC 列表页

[ NPC1 ] 学习教练  
[ NPC2 ] 心理导师  
[ NPC3 ] 通用助手  
( + ) 创建新 NPC

## NPC 对话页

[ 我 avatar ] [ NPC avatar ]

---

我：今天有什么学习建议？  
NPC：我们先从计划开始吧。

---

[input box]

---

# 8. 非功能需求（NFR）

- 对话响应时间 < 2 秒（取决于模型速度）
- 事件记录要永久存储
- 界面简洁、直观
- 易于未来扩展多 NPC、记忆系统、多 Agent

---

# 9. V1 范围（MVP Scope）

包含：

- NPC 创建
- NPC 列表
- 一对一对话
- 调用模型 API
- Event Log

不包含：

- NPC 互相对话
- 世界状态
- 中期/长期记忆
- 多 Agent 调度
- 总线
- 场景地图

---

# 10. 后续规划（Roadmap）

- 加 NPC 记忆系统（short/mid/long）
- 加 NPC 工具调用（搜索、知识库）
- 多 NPC 世界（用户与多个角色共存在一个 UI 场景）
- 可交互社区（另一个独立项目）
- 行为可视化（事件链路图、思维树）
- 总线化架构（A2A 调度、可视化）

---

# End.
