# 05-数据模型

**文档版本**：v1.1  
**最后更新**：2025-11-21  
**相关文档**：[功能需求](./03-功能需求.md) | [API设计](./04-API设计.md)

---

## 1. 数据模型总览

### 1.1 核心实体

| 实体 | 说明 | 表名 |
|------|------|------|
| User | 用户信息 | `users` |
| Agent | AI NPC 配置信息 | `agents` |
| Event | 对话事件记录 | `events` |

### 1.2 实体关系

```
User (用户)
  ├── 1:N ──> Agent (NPC)
  └── 1:N ──> Event (事件)

Agent (NPC)
  └── 1:N ──> Event (事件)

Event (事件)
  ├── N:1 ──> User (用户)
  └── N:1 ──> Agent (NPC)
```

---

## 2. Agent（NPC）数据模型

### 2.1 实体说明

Agent 表示用户创建的 AI NPC，包含 NPC 的基本信息、人设配置和使用的模型。

### 2.2 数据表结构

**表名**：`agents`

| 字段名 | 类型 | 约束 | 说明 | 示例 |
|--------|------|------|------|------|
| id | string | PK, NOT NULL | 唯一标识符 | "agent_456" |
| user_id | string | NOT NULL, INDEX | 用户 ID | "user_123" |
| name | string(50) | NOT NULL | NPC 名称 | "学习教练" |
| type | enum | NOT NULL | NPC 类型：general/special | "special" |
| model | string(50) | NOT NULL | LLM 模型名称 | "gpt-4.1" |
| system_prompt | text | NOT NULL | NPC 人设描述（system prompt） | "你是一位专业的学习教练..." |
| avatar_url | string(500) | NULL | 头像 URL | "https://example.com/avatar.png" |
| created_at | bigint | NOT NULL, INDEX | 创建时间戳（毫秒） | 1703001234567 |
| updated_at | bigint | NOT NULL | 更新时间戳（毫秒） | 1703001234567 |

### 2.3 字段详细说明

#### id（主键）
- **类型**：string
- **生成规则**：`agent_{timestamp}_{random}` 或使用 UUID
- **示例**：`agent_1703001234567_abc123` 或 `agent_550e8400-e29b-41d4-a716-446655440000`

#### user_id（用户 ID）
- **类型**：string
- **说明**：创建该 NPC 的用户 ID
- **索引**：建立索引，用于快速查询用户的 NPC 列表

#### name（NPC 名称）
- **类型**：string(50)
- **约束**：
  - 不能为空
  - 长度：1-50 字符
  - 同一用户的 NPC 名称不能重复（不区分大小写）
- **验证规则**：前端和后端都需要验证

#### type（NPC 类型）
- **类型**：enum('general', 'special')
- **说明**：
  - `general`：通用助手，适用于多种场景
  - `special`：特定功能 NPC，专注于某个领域

#### model（LLM 模型）
- **类型**：string(50)
- **说明**：使用的 LLM 模型名称
- **可选值**：需要在系统配置中定义支持的模型列表
- **示例**：`gpt-4.1`, `gpt-3.5-turbo`, `claude-3-opus`

#### system_prompt（人设描述）
- **类型**：text
- **约束**：
  - 不能为空
  - 长度：10-5000 字符
- **说明**：NPC 的 system prompt，用于定义 NPC 的人设和行为

#### avatar_url（头像 URL）
- **类型**：string(500)
- **约束**：可选字段，可以为 NULL
- **说明**：NPC 头像的 URL 地址
- **验证**：如果提供，需要验证 URL 格式

#### created_at / updated_at（时间戳）
- **类型**：bigint（毫秒时间戳）
- **说明**：记录创建和更新时间
- **索引**：created_at 建立索引，用于排序

### 2.4 索引设计

```sql
-- 主键索引（自动创建）
PRIMARY KEY (id)

-- 用户 ID 索引（查询用户的 NPC 列表）
CREATE INDEX idx_agents_user_id ON agents(user_id);

-- 创建时间索引（排序）
CREATE INDEX idx_agents_created_at ON agents(created_at);

-- 复合索引（查询用户的 NPC 列表并按时间排序）
CREATE INDEX idx_agents_user_created ON agents(user_id, created_at DESC);
```

### 2.5 唯一约束

```sql
-- 同一用户的 NPC 名称不能重复（不区分大小写）
-- 注意：需要在应用层实现，因为数据库的 UNIQUE 约束区分大小写
-- 可以在应用层查询时使用 LOWER(name) 进行比较
```

### 2.6 数据示例

```json
{
  "id": "agent_456",
  "user_id": "user_123",
  "name": "学习教练",
  "type": "special",
  "model": "gpt-4.1",
  "system_prompt": "你是一位专业的学习教练，擅长制定学习计划、解答学习问题、提供学习建议。你总是以鼓励和支持的方式与用户交流，帮助用户建立良好的学习习惯。",
  "avatar_url": "https://example.com/avatars/learning-coach.png",
  "created_at": 1703001234567,
  "updated_at": 1703001234567
}
```

---

## 3. Event（事件）数据模型

### 3.1 实体说明

Event 表示用户与 NPC 之间的对话事件，包括用户发言和 NPC 回复。所有对话都通过事件记录，为对话历史和上下文提供数据基础。

### 3.2 数据表结构

**表名**：`events`

| 字段名 | 类型 | 约束 | 说明 | 示例 |
|--------|------|------|------|------|
| id | string | PK, NOT NULL | 唯一标识符 | "event_789" |
| session_id | string | NOT NULL, INDEX | 会话 ID（user_id_agent_id） | "user_123_agent_456" |
| user_id | string | NOT NULL, INDEX | 用户 ID | "user_123" |
| agent_id | string | NOT NULL, INDEX | NPC ID | "agent_456" |
| from_type | enum | NOT NULL | 发送者类型：user/agent | "user" |
| from_id | string | NOT NULL | 发送者 ID | "user_123" |
| to_type | enum | NOT NULL | 接收者类型：user/agent | "agent" |
| to_id | string | NOT NULL | 接收者 ID | "agent_456" |
| content | text | NOT NULL | 消息内容 | "今天有什么学习建议？" |
| timestamp | bigint | NOT NULL, INDEX | 时间戳（毫秒） | 1703001234567 |

### 3.3 字段详细说明

#### id（主键）
- **类型**：string
- **生成规则**：`event_{timestamp}_{random}` 或使用 UUID
- **示例**：`event_1703001234567_xyz789`

#### session_id（会话 ID）
- **类型**：string
- **生成规则**：`{user_id}_{agent_id}`
- **示例**：`user_123_agent_456`
- **说明**：用于快速查询某个会话的所有事件
- **索引**：建立索引，提高查询性能

#### user_id / agent_id（用户和 NPC ID）
- **类型**：string
- **说明**：用户 ID 和 NPC ID，用于关联查询
- **索引**：分别建立索引

#### from_type / to_type（发送者和接收者类型）
- **类型**：enum('user', 'agent')
- **说明**：
  - `from_type`：发送者类型
  - `to_type`：接收者类型
- **业务规则**：
  - 如果 `from_type = 'user'`，则 `to_type = 'agent'`
  - 如果 `from_type = 'agent'`，则 `to_type = 'user'`

#### from_id / to_id（发送者和接收者 ID）
- **类型**：string
- **说明**：
  - `from_id`：发送者 ID（user_id 或 agent_id）
  - `to_id`：接收者 ID（user_id 或 agent_id）

#### content（消息内容）
- **类型**：text
- **约束**：
  - 不能为空
  - 长度：1-50000 字符（预留足够空间）
- **说明**：消息的原始内容，完整存储不做修改

#### timestamp（时间戳）
- **类型**：bigint（毫秒时间戳）
- **说明**：事件发生的时间，使用服务器时间
- **索引**：建立索引，用于排序和范围查询

### 3.4 索引设计

```sql
-- 主键索引（自动创建）
PRIMARY KEY (id)

-- 会话 ID 索引（查询会话的所有事件）
CREATE INDEX idx_events_session_id ON events(session_id);

-- 时间戳索引（排序和范围查询）
CREATE INDEX idx_events_timestamp ON events(timestamp);

-- 复合索引（查询会话的事件并按时间排序）
CREATE INDEX idx_events_session_timestamp ON events(session_id, timestamp ASC);

-- 用户 ID 索引（查询用户的所有事件）
CREATE INDEX idx_events_user_id ON events(user_id);

-- NPC ID 索引（查询 NPC 的所有事件）
CREATE INDEX idx_events_agent_id ON events(agent_id);

-- 复合索引（查询用户与 NPC 的事件并按时间排序）
CREATE INDEX idx_events_user_agent_timestamp ON events(user_id, agent_id, timestamp ASC);
```

### 3.5 数据示例

**用户发言事件**：
```json
{
  "id": "event_111",
  "session_id": "user_123_agent_456",
  "user_id": "user_123",
  "agent_id": "agent_456",
  "from_type": "user",
  "from_id": "user_123",
  "to_type": "agent",
  "to_id": "agent_456",
  "content": "今天有什么学习建议？",
  "timestamp": 1703001234567
}
```

**NPC 回复事件**：
```json
{
  "id": "event_112",
  "session_id": "user_123_agent_456",
  "user_id": "user_123",
  "agent_id": "agent_456",
  "from_type": "agent",
  "from_id": "agent_456",
  "to_type": "user",
  "to_id": "user_123",
  "content": "我们先从制定学习计划开始吧。首先，你需要明确今天的学习目标...",
  "timestamp": 1703001234568
}
```

---

## 4. User（用户）数据模型

### 4.1 实体说明

User 表示系统用户，包含用户的基本信息和认证信息。V1 版本实现了基础的登录和注册功能。

### 4.2 数据表结构

**表名**：`users`

| 字段名 | 类型 | 约束 | 说明 | 示例 |
|--------|------|------|------|------|
| id | string | PK, NOT NULL | 唯一标识符（User ID） | "user_123" |
| username | string(50) | UNIQUE, NOT NULL | 用户昵称（显示名称） | "TestUser" |
| password | string(255) | NOT NULL | 密码（V1 版本明文存储，V1.5 改为哈希） | "password" |
| created_at | bigint | NOT NULL, INDEX | 创建时间戳（毫秒） | 1703001234567 |
| updated_at | bigint | NOT NULL | 更新时间戳（毫秒） | 1703001234567 |

**注意**：
- V1 版本密码使用明文存储（简化实现）
- V1.5 版本将改为密码哈希存储（使用 bcrypt）
- V1.5 版本将添加邮箱字段用于完整用户认证

### 4.3 字段详细说明

#### id（主键）
- **类型**：string
- **生成规则**：用户自定义或系统生成（V1 版本允许用户自定义）
- **示例**：`user_123` 或 `user_550e8400-e29b-41d4-a716-446655440000`
- **约束**：必须唯一，不能重复

#### username（用户昵称）
- **类型**：string(50)
- **约束**：
  - 不能为空
  - 长度：1-50 字符
  - 必须唯一，不能重复
- **说明**：用户的显示名称，用于前端展示

#### password（密码）
- **类型**：string(255)
- **约束**：
  - 不能为空
  - 长度：至少 6 字符（V1 版本简化验证）
- **说明**：
  - V1 版本：明文存储（简化实现，仅用于开发测试）
  - V1.5 版本：改为密码哈希存储（使用 bcrypt）

#### created_at / updated_at（时间戳）
- **类型**：bigint（毫秒时间戳）
- **说明**：记录创建和更新时间
- **索引**：created_at 建立索引，用于排序

### 4.4 索引设计

```sql
-- 主键索引（自动创建）
PRIMARY KEY (id)

-- 用户名唯一索引
CREATE UNIQUE INDEX idx_users_username ON users(username);

-- 创建时间索引（排序）
CREATE INDEX idx_users_created_at ON users(created_at);
```

### 4.5 唯一约束

```sql
-- 用户名必须唯一
CREATE UNIQUE INDEX idx_users_username ON users(username);

-- User ID 必须唯一（主键约束）
PRIMARY KEY (id)
```

### 4.6 数据示例

```json
{
  "id": "user_123",
  "username": "TestUser",
  "password": "password",
  "createdAt": 1703001234567,
  "updatedAt": 1703001234567
}
```

**注意**：返回用户信息时，不应包含 password 字段。

---

## 5. 数据库设计

### 5.1 数据库选型

**推荐方案**：
- **PostgreSQL**：关系型数据库，支持 JSON 类型，性能优秀
- **MySQL 8.0+**：备选方案，功能完善
- **SQLite**：开发/测试环境使用，轻量级

### 5.2 数据库命名规范

- **表名**：小写，复数形式，使用下划线分隔（如 `agents`, `events`）
- **字段名**：小写，使用下划线分隔（如 `user_id`, `created_at`）
- **索引名**：`idx_{table}_{field}` 或 `idx_{table}_{field1}_{field2}`

### 5.3 数据类型选择

| 字段类型 | 数据库类型 | 说明 |
|---------|-----------|------|
| string(50) | VARCHAR(50) | 短字符串 |
| string(500) | VARCHAR(500) | 中等字符串 |
| text | TEXT | 长文本 |
| enum | ENUM 或 VARCHAR | 枚举类型 |
| bigint | BIGINT | 时间戳（毫秒） |

### 5.4 数据库初始化 SQL

```sql
-- 创建 users 表
CREATE TABLE users (
  id VARCHAR(100) PRIMARY KEY,
  username VARCHAR(50) NOT NULL,
  password VARCHAR(255) NOT NULL,
  created_at BIGINT NOT NULL,
  updated_at BIGINT NOT NULL,
  UNIQUE INDEX idx_users_username (username),
  INDEX idx_users_created_at (created_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- 创建 agents 表
CREATE TABLE agents (
  id VARCHAR(100) PRIMARY KEY,
  user_id VARCHAR(100) NOT NULL,
  name VARCHAR(50) NOT NULL,
  type ENUM('general', 'special') NOT NULL,
  model VARCHAR(50) NOT NULL,
  system_prompt TEXT NOT NULL,
  avatar_url VARCHAR(500),
  created_at BIGINT NOT NULL,
  updated_at BIGINT NOT NULL,
  INDEX idx_agents_user_id (user_id),
  INDEX idx_agents_created_at (created_at),
  INDEX idx_agents_user_created (user_id, created_at DESC)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- 创建 events 表
CREATE TABLE events (
  id VARCHAR(100) PRIMARY KEY,
  session_id VARCHAR(200) NOT NULL,
  user_id VARCHAR(100) NOT NULL,
  agent_id VARCHAR(100) NOT NULL,
  from_type ENUM('user', 'agent') NOT NULL,
  from_id VARCHAR(100) NOT NULL,
  to_type ENUM('user', 'agent') NOT NULL,
  to_id VARCHAR(100) NOT NULL,
  content TEXT NOT NULL,
  timestamp BIGINT NOT NULL,
  INDEX idx_events_session_id (session_id),
  INDEX idx_events_timestamp (timestamp),
  INDEX idx_events_session_timestamp (session_id, timestamp ASC),
  INDEX idx_events_user_id (user_id),
  INDEX idx_events_agent_id (agent_id),
  INDEX idx_events_user_agent_timestamp (user_id, agent_id, timestamp ASC)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
```

---

## 6. 数据关系图（ER 图）

```
┌─────────────┐
│    User     │
│─────────────│
│ id (PK)     │
│ username    │
│ password    │
│ created_at  │
│ updated_at  │
└──────┬──────┘
       │
       │ 1:N
       │
       ├─────────────────┐
       │                 │
       │                 │
┌──────▼──────┐    ┌─────▼──────┐
│   Agent     │    │   Event    │
│─────────────│    │────────────│
│ id (PK)     │    │ id (PK)    │
│ user_id (FK)│    │ session_id │
│ name        │    │ user_id(FK)│
│ type        │    │ agent_id(FK│
│ model       │    │ from_type  │
│ system_     │    │ from_id    │
│   prompt    │    │ to_type    │
│ avatar_url  │    │ to_id      │
│ created_at  │    │ content    │
│ updated_at  │    │ timestamp  │
└──────┬──────┘    └────────────┘
       │
       │ 1:N
       │
       │
┌──────▼──────┐
│   Event     │
│  (同上)     │
└─────────────┘
```

---

## 7. 数据校验规则

### 7.1 User 数据校验

| 字段 | 校验规则 |
|------|---------|
| id | 不能为空，长度 1-100 字符，必须唯一 |
| username | 不能为空，长度 1-50 字符，必须唯一 |
| password | 不能为空，长度至少 6 字符（V1 版本简化验证） |
| created_at / updated_at | 必须是有效的时间戳（毫秒） |

### 7.2 Agent 数据校验

| 字段 | 校验规则 |
|------|---------|
| id | 不能为空，格式：`agent_*` 或 UUID |
| user_id | 不能为空，长度 1-100 字符 |
| name | 不能为空，长度 1-50 字符，同一用户不能重复 |
| type | 必须是 'general' 或 'special' |
| model | 必须在支持的模型列表中 |
| system_prompt | 不能为空，长度 10-5000 字符 |
| avatar_url | 可选，如果提供必须是有效的 URL |
| created_at / updated_at | 必须是有效的时间戳（毫秒） |

### 7.3 Event 数据校验

| 字段 | 校验规则 |
|------|---------|
| id | 不能为空，格式：`event_*` 或 UUID |
| session_id | 不能为空，格式：`{user_id}_{agent_id}` |
| user_id | 不能为空，必须与 session_id 中的 user_id 一致 |
| agent_id | 不能为空，必须与 session_id 中的 agent_id 一致 |
| from_type | 必须是 'user' 或 'agent' |
| to_type | 必须是 'user' 或 'agent'，且与 from_type 相反 |
| from_id | 不能为空，如果 from_type='user' 则等于 user_id，否则等于 agent_id |
| to_id | 不能为空，如果 to_type='user' 则等于 user_id，否则等于 agent_id |
| content | 不能为空，长度 1-50000 字符 |
| timestamp | 必须是有效的时间戳（毫秒） |

---

## 8. 数据迁移策略

### 8.1 版本管理

- 使用数据库迁移工具（如 Flyway、Liquibase）管理数据库版本
- 每个迁移文件包含版本号和描述

### 8.2 迁移示例

```sql
-- V1.0.0__create_agents_and_events_tables.sql
-- 创建 agents 和 events 表

-- V1.1.0__add_index_to_events.sql
-- 添加额外的索引优化查询性能

-- V1.2.0__create_users_table.sql
-- 创建 users 表（用户认证功能）

-- V1.5.0__update_users_password_hash.sql
-- 将密码从明文改为哈希存储（V1.5 安全增强）
```

---

## 9. 数据备份和恢复

### 9.1 备份策略

- **全量备份**：每天凌晨执行一次全量备份
- **增量备份**：每小时执行一次增量备份
- **备份保留**：保留最近 30 天的备份

### 9.2 恢复策略

- **数据恢复**：从最近的备份恢复数据
- **灾难恢复**：建立主从复制，支持快速切换

---

## 10. 性能优化建议

### 10.1 查询优化

1. **使用索引**：在常用查询字段上建立索引
2. **避免全表扫描**：使用 WHERE 条件限制查询范围
3. **分页查询**：对于大量数据，使用 LIMIT 和 OFFSET 分页

### 10.2 数据分区（未来考虑）

如果 events 表数据量很大（> 1000 万条），可以考虑按时间分区：
- 按月分区
- 按 session_id 哈希分区

### 10.3 缓存策略

- **NPC 列表缓存**：缓存用户的 NPC 列表，TTL 5 分钟
- **对话历史缓存**：缓存最近的对话历史，TTL 10 分钟
- **Agent 配置缓存**：缓存 Agent 配置，TTL 1 小时

---

## 11. 数据安全

### 11.1 数据加密

- **敏感数据**：
  - V1 版本：密码明文存储（简化实现，仅用于开发测试）
  - V1.5 版本：密码使用 bcrypt 哈希存储
- **传输加密**：使用 HTTPS 传输数据

### 11.2 数据隔离

- **用户数据隔离**：确保用户只能访问自己的数据
- **SQL 注入防护**：使用参数化查询，避免 SQL 注入

### 11.3 数据隐私

- **内容存储**：对话内容完整存储，不做修改
- **数据删除**：用户删除数据时，物理删除或标记删除（根据合规要求）

---

## 12. 相关文档

- [功能需求](./03-功能需求.md) - 功能需求详细说明
- [API设计](./04-API设计.md) - API 接口设计
- [系统架构](./06-系统架构.md) - 系统架构设计（待生成）

---

**文档维护**：数据结构变更时，需同步更新本文档、API 文档和数据库迁移脚本。

