# 08-非功能需求

**文档版本**：v1.0  
**最后更新**：2024-12-19  
**相关文档**：[产品概述](./01-产品概述.md) | [系统架构](./06-系统架构.md)

---

## 1. 性能需求

### 1.1 响应时间

| 操作 | 目标响应时间 | 可接受响应时间 | 说明 |
|------|------------|--------------|------|
| 页面加载 | < 1 秒 | < 2 秒 | 首屏加载时间 |
| API 响应（非 LLM） | < 200ms | < 500ms | 普通 API 响应时间 |
| 创建 NPC | < 500ms | < 1 秒 | 不包括网络传输时间 |
| 获取 NPC 列表 | < 300ms | < 500ms | 20 个 NPC 以内 |
| 获取对话历史 | < 100ms | < 300ms | 1000 条记录以内 |
| 发送消息（含 LLM） | < 3 秒 | < 5 秒 | P95 响应时间，取决于 LLM API |
| LLM API 调用 | < 2 秒 | < 3 秒 | P95 响应时间 |

### 1.2 吞吐量

| 指标 | 目标值 | 说明 |
|------|--------|------|
| API QPS | ≥ 100 | 单实例处理能力 |
| 并发用户数 | ≥ 500 | 同时在线用户数 |
| 消息发送频率 | ≥ 10/秒 | 单用户消息发送频率 |

### 1.3 资源使用

| 资源 | 限制 | 说明 |
|------|------|------|
| 内存使用 | < 512MB | 单实例内存使用 |
| CPU 使用率 | < 70% | 正常负载下的 CPU 使用率 |
| 数据库连接数 | < 100 | 数据库连接池大小 |

---

## 2. 可用性需求

### 2.1 系统可用性

| 指标 | 目标值 | 说明 |
|------|--------|------|
| 系统可用性 | ≥ 99% | 月度可用性 |
| 计划内维护时间 | < 4 小时/月 | 维护窗口时间 |
| 故障恢复时间 | < 30 分钟 | MTTR（平均故障恢复时间） |

### 2.2 容错能力

- **服务降级**：LLM API 不可用时，返回友好提示，不阻塞其他功能
- **数据备份**：数据库每日自动备份，保留 30 天
- **故障转移**：支持多实例部署，单实例故障不影响整体服务

---

## 3. 可扩展性需求

### 3.1 水平扩展

- **无状态设计**：后端服务无状态，支持水平扩展
- **负载均衡**：支持负载均衡，自动分发请求
- **数据库扩展**：支持读写分离（V2 考虑）

### 3.2 垂直扩展

- **资源弹性**：支持动态调整 CPU、内存等资源
- **存储扩展**：数据库支持存储扩容

### 3.3 功能扩展

- **插件化设计**：LLM 服务支持插件化，便于添加新的 LLM 提供商
- **事件驱动**：基于事件记录系统，便于添加新功能

---

## 4. 安全需求

### 4.1 数据安全

#### 4.1.1 数据加密

- **传输加密**：所有 API 请求使用 HTTPS（TLS 1.2+）
- **存储加密**：敏感数据加密存储（V1.5 实现）
- **密码加密**：用户密码使用 bcrypt 加密（V1.5 实现）

#### 4.1.2 数据隔离

- **用户数据隔离**：确保用户只能访问自己的数据
- **SQL 注入防护**：使用参数化查询，避免 SQL 注入
- **XSS 防护**：前端和后端都进行内容转义

### 4.2 访问控制

#### 4.2.1 认证（V1.5 实现）

- **JWT Token**：使用 JWT Token 进行用户认证
- **Token 过期**：Token 有效期 7 天，支持刷新
- **密码策略**：密码长度至少 8 位，包含字母和数字

#### 4.2.2 授权（V1.5 实现）

- **权限验证**：每个 API 请求验证用户权限
- **资源访问控制**：用户只能访问自己的资源

### 4.3 API 安全

- **HTTPS**：所有 API 请求使用 HTTPS
- **CORS**：配置正确的 CORS 策略
- **限流**：防止 API 滥用（V1.5 实现）
  - 用户级别：每分钟最多 60 次请求
  - IP 级别：每分钟最多 100 次请求

---

## 5. 可维护性需求

### 5.1 代码质量

- **代码规范**：遵循团队代码规范（ESLint、Prettier）
- **代码注释**：关键逻辑添加注释
- **代码审查**：所有代码变更需要代码审查

### 5.2 文档要求

- **API 文档**：完整的 API 文档，包含请求/响应示例
- **代码文档**：关键函数和类添加文档注释
- **部署文档**：详细的部署和运维文档

### 5.3 测试要求

- **单元测试**：核心业务逻辑单元测试覆盖率 ≥ 60%
- **集成测试**：关键流程集成测试
- **端到端测试**：主要用户流程端到端测试（V2 考虑）

---

## 6. 可移植性需求

### 6.1 平台支持

- **浏览器支持**：
  - Chrome（最新 2 个版本）
  - Firefox（最新 2 个版本）
  - Safari（最新 2 个版本）
  - Edge（最新 2 个版本）
- **移动端支持**：响应式设计，支持移动端浏览器

### 6.2 部署环境

- **开发环境**：支持本地开发环境
- **测试环境**：支持独立的测试环境
- **生产环境**：支持云服务器部署（Docker）

---

## 7. 兼容性需求

### 7.1 向后兼容

- **API 版本**：API 版本化管理，保持向后兼容
- **数据迁移**：数据库结构变更时提供迁移脚本

### 7.2 浏览器兼容

- **现代浏览器**：支持现代浏览器（ES6+）
- **降级方案**：不支持的功能提供降级方案

---

## 8. 监控和日志需求

### 8.1 日志系统

#### 8.1.1 日志级别

- **ERROR**：错误日志，需要立即处理
- **WARN**：警告日志，需要关注
- **INFO**：信息日志，记录关键操作
- **DEBUG**：调试日志，开发环境使用

#### 8.1.2 日志内容

- **请求日志**：请求路径、方法、参数、响应时间、状态码
- **错误日志**：错误堆栈、上下文信息（userId, agentId 等）
- **业务日志**：关键业务操作记录（创建 NPC、发送消息等）

#### 8.1.3 日志格式

- **格式**：JSON 格式，便于解析和查询
- **字段**：timestamp, level, message, context, error（可选）

### 8.2 监控指标

#### 8.2.1 系统指标

- **CPU 使用率**：监控 CPU 使用率，超过 80% 告警
- **内存使用率**：监控内存使用率，超过 80% 告警
- **磁盘使用率**：监控磁盘使用率，超过 80% 告警
- **网络流量**：监控网络流量

#### 8.2.2 应用指标

- **API 响应时间**：监控 API 响应时间，P95 > 1 秒告警
- **API 错误率**：监控 API 错误率，错误率 > 1% 告警
- **API QPS**：监控 API QPS
- **数据库查询时间**：监控数据库查询时间，慢查询 > 1 秒告警

#### 8.2.3 业务指标

- **用户活跃度**：日活跃用户数、周活跃用户数
- **NPC 创建数**：每日 NPC 创建数量
- **消息发送数**：每日消息发送数量
- **LLM API 调用次数**：每日 LLM API 调用次数和成功率

### 8.3 告警机制（V2 实现）

- **错误率告警**：API 错误率超过阈值时告警
- **响应时间告警**：API 响应时间超过阈值时告警
- **资源使用告警**：CPU、内存使用率超过阈值时告警
- **LLM API 失败告警**：LLM API 调用失败率超过阈值时告警

---

## 9. 数据管理需求

### 9.1 数据备份

- **备份频率**：每日自动备份
- **备份保留**：保留最近 30 天的备份
- **备份验证**：定期验证备份的完整性

### 9.2 数据恢复

- **恢复时间目标（RTO）**：< 4 小时
- **恢复点目标（RPO）**：< 24 小时（最多丢失 24 小时数据）

### 9.3 数据保留

- **对话记录**：永久保留（除非用户主动删除）
- **NPC 配置**：永久保留（除非用户主动删除）
- **日志数据**：保留 90 天

---

## 10. 用户体验需求

### 10.1 界面响应

- **操作反馈**：所有操作都有明确的反馈（加载、成功、错误）
- **加载状态**：数据加载时显示加载动画
- **错误提示**：错误信息清晰明确，提供解决方案

### 10.2 易用性

- **学习成本**：新用户能够在 5 分钟内完成首次 NPC 创建和对话
- **操作步骤**：核心流程操作步骤 ≤ 3 步
- **帮助文档**：提供清晰的帮助文档和引导

### 10.3 无障碍设计

- **键盘导航**：支持键盘导航
- **屏幕阅读器**：支持屏幕阅读器
- **颜色对比度**：文本对比度 ≥ 4.5:1（WCAG AA 标准）

---

## 11. 成本控制需求

### 11.1 LLM API 成本

- **成本监控**：监控 LLM API 调用成本
- **成本限制**：设置每日/每月成本上限（V2 实现）
- **成本优化**：优化 Prompt 长度，减少不必要的 API 调用

### 11.2 基础设施成本

- **资源优化**：合理配置服务器资源，避免资源浪费
- **成本监控**：监控基础设施成本

---

## 12. 合规需求

### 12.1 数据保护

- **隐私政策**：提供清晰的隐私政策
- **数据使用**：明确数据使用范围和目的
- **用户权利**：支持用户查看、导出、删除自己的数据（V2 实现）

### 12.2 法律法规

- **GDPR**：遵守 GDPR 相关法规（如适用）
- **数据安全法**：遵守当地数据安全法规

---

## 13. 相关文档

- [产品概述](./01-产品概述.md) - 产品定义和目标
- [系统架构](./06-系统架构.md) - 系统架构设计
- [开发计划](./09-开发计划.md) - 开发计划和时间表

---

**文档维护**：非功能需求变更时，需同步更新本文档和相关技术文档。

