# 03-功能需求（V1）

**文档版本**：v1.0.0  
**最后更新**：2025-11-22  
**相关文档**：[产品概述](./01-产品概述.md) | [API 设计](./04-API设计.md) | [数据模型](./05-数据模型.md)

---

## 1. 功能需求总览

### 1.1 功能模块划分

| 模块     | 功能编号 | 功能名称     | 优先级 | 状态       |
| -------- | -------- | ------------ | ------ | ---------- |
| 用户认证 | F0       | 用户登录     | P0     | ✅ 已完成  |
| 用户认证 | F0.1     | 用户注册     | P0     | ✅ 已完成  |
| NPC 管理 | F1       | 创建 NPC     | P0     | ✅ 已完成  |
| NPC 管理 | F2       | NPC 列表展示 | P0     | ✅ 已完成  |
| NPC 管理 | F2.1     | 获取 NPC 详情 | P1     | ✅ 已完成  |
| 对话系统 | F5       | 发送消息     | P0     | ✅ 已完成  |
| 对话系统 | F6       | 获取对话历史 | P0     | ✅ 已完成  |
| 对话系统 | F6.1     | 获取会话列表 | P0     | ✅ 已完成  |
| 事件系统 | F8       | 事件记录     | P0     | ✅ 已完成  |
| 事件系统 | F9       | 事件查询     | P0     | ✅ 已完成  |

---

## 2. 用户认证模块

### 2.1 F0：用户登录

#### 2.1.1 功能描述

用户通过 User ID 和密码登录系统。

#### 2.1.2 功能流程

```
用户输入 User ID 和密码
  ↓
前端验证输入
  ↓
发送 POST /api/v1/users/login 请求
  ↓
后端验证用户信息
  ├─ 用户存在且密码正确 → 返回用户信息
  └─ 用户不存在或密码错误 → 返回错误
  ↓
前端保存登录状态（localStorage）
  ↓
更新全局用户状态
```

#### 2.1.3 输入输出规范

**请求格式**：
```json
{
  "userId": "user_123",
  "password": "password"
}
```

**响应格式**：
```json
{
  "success": true,
  "data": {
    "id": "user_123",
    "username": "TestUser",
    "createdAt": 1703001234567
  }
}
```

#### 2.1.4 业务规则

1. User ID 不能为空
2. 如果用户不存在，返回 `USER_NOT_FOUND` 错误
3. 如果密码错误，返回 `INVALID_PASSWORD` 错误
4. 登录状态保存在 localStorage，刷新页面不丢失

#### 2.1.5 验收标准

- [x] 用户能够成功登录 ✅
- [x] 登录状态正确保存 ✅
- [x] 错误情况正确处理 ✅

**实现状态**：已完成（2025-11-21）

---

### 2.2 F0.1：用户注册

#### 2.2.1 功能描述

新用户注册账号，创建用户记录。

#### 2.2.2 功能流程

```
用户进入注册页面
  ↓
填写注册信息（User ID、昵称、密码）
  ↓
前端验证表单
  ↓
发送 POST /api/v1/users/register 请求
  ↓
后端创建用户记录
  ├─ 成功 → 返回用户信息
  └─ 失败（User ID 或用户名重复） → 返回错误
  ↓
前端保存登录状态
  ↓
跳转到 NPC 列表页面
```

#### 2.2.3 输入输出规范

**请求格式**：
```json
{
  "userId": "user_123",
  "username": "TestUser",
  "password": "password"
}
```

**响应格式**：
```json
{
  "success": true,
  "data": {
    "id": "user_123",
    "username": "TestUser",
    "createdAt": 1703001234567
  }
}
```

#### 2.2.4 业务规则

1. User ID、用户名、密码都不能为空
2. User ID 必须唯一，不能重复
3. 用户名必须唯一，不能重复
4. 注册成功后自动登录

#### 2.2.5 验收标准

- [x] 用户能够成功注册 ✅
- [x] User ID 和用户名重复时正确提示 ✅
- [x] 注册后自动登录 ✅

**实现状态**：已完成（2025-11-21）

---

## 3. NPC 管理模块

### 3.1 F1：创建 NPC

#### 3.1.1 功能描述

用户可以通过表单创建新的 AI NPC，配置 NPC 的基本信息、人设和使用的模型。

#### 3.1.2 功能流程

```
用户进入创建页面
  ↓
填写 NPC 信息表单
  ├─ 名称（必填）
  ├─ 类型（必填：通用/特定）
  ├─ 人设描述（可选：system prompt）
  ├─ 使用模型（必填：如 GPT-4.1）
  └─ 头像（可选：URL）
  ↓
点击"创建"按钮
  ↓
前端验证表单
  ├─ 名称：1-50 字符，不能为空
  ├─ 类型：必须选择
  ├─ 人设：可选，无最小长度限制
  ├─ 模型：必须选择支持的模型
  └─ 头像：URL 格式验证（如提供）
  ↓
发送创建请求到后端
  ↓
后端创建 Agent 记录
  ├─ 生成唯一 agentId
  ├─ 保存到数据库
  └─ 返回 agentId
  ↓
前端接收成功响应
  ↓
跳转到 NPC 列表页面（显示新创建的 NPC）
```

#### 3.1.3 输入输出规范

**输入字段**：

| 字段名       | 类型   | 必填 | 长度限制     | 说明                           | 示例                               |
| ------------ | ------ | ---- | ------------ | ------------------------------ | ---------------------------------- |
| name         | string | 是   | 1-50 字符    | NPC 名称                       | "学习教练"                         |
| type         | enum   | 是   | -            | NPC 类型                       | "general" 或 "special"             |
| systemPrompt | string | 否   | -            | NPC 人设描述（可选）            | "你是一位专业的学习教练..."        |
| model        | string | 是   | -            | 使用的 LLM 模型名称            | "gpt-4o" 或 "deepseek-chat"        |
| provider     | string | 否   | -            | 模型提供商（自定义模型时必填） | "openai"、"deepseek"、"openrouter" |
| avatarUrl    | string | 否   | URL 格式     | 头像 URL                       | "https://..."                      |

**模型配置说明**：

- **预设模型模式**：如果配置了预设模型（MODELS 环境变量），只需提供 `model` 字段，系统会自动识别提供商
- **自定义模型模式**：如果没有预设模型，必须同时提供 `model` 和 `provider` 字段
- **支持的提供商**：OpenAI、DeepSeek、OpenRouter

**输出结果**：

- **成功**：返回创建的 Agent 对象（包含 agentId）
- **失败**：返回错误信息（字段验证失败、名称重复、系统错误等）

#### 3.1.4 业务规则

1. **名称唯一性**：同一用户创建的 NPC 名称不能重复（不区分大小写）
2. **模型支持**：
   - 如果配置了预设模型，只能选择预设模型列表中的模型
   - 如果没有预设模型，可以选择任意模型，但必须指定提供商且提供商必须启用
3. **提供商配置**：
   - 通过环境变量 `ENABLE_OPENAI`、`ENABLE_DEEPSEEK`、`ENABLE_OPENROUTER` 控制提供商启用
   - 通过环境变量 `MODELS` 配置预设模型（格式：`model:provider`）
4. **人设长度**：systemPrompt 为可选字段，可以为空
5. **类型说明**：
   - `general`：通用助手，适用于多种场景
   - `special`：特定功能 NPC，专注于某个领域（如学习、心理等）

#### 3.1.5 错误处理

| 错误场景 | 错误码           | 错误信息                       | 处理方式               |
| -------- | ---------------- | ------------------------------ | ---------------------- |
| 名称为空 | VALIDATION_ERROR | "NPC 名称不能为空"             | 前端提示，阻止提交     |
| 名称过长 | VALIDATION_ERROR | "NPC 名称不能超过 50 字符"     | 前端提示，阻止提交     |
| 名称重复 | DUPLICATE_NAME   | "该名称已存在，请使用其他名称" | 前端提示，允许修改     |
| 模型无效 | INVALID_MODEL    | "无效的模型选择"               | 前端提示，阻止提交     |
| 系统错误 | SYSTEM_ERROR     | "创建失败，请稍后重试"         | 记录日志，提示用户重试 |

#### 3.1.6 验收标准

- [x] 用户能够成功创建 NPC，所有必填字段验证通过 ✅
- [x] 创建成功后，NPC 出现在列表中 ✅
- [x] 名称重复时，系统正确提示错误 ✅
- [x] 所有字段验证规则正确执行 ✅
- [x] 创建失败时，错误信息清晰明确 ✅
- [x] 创建过程有加载状态提示 ✅

**实现状态**：已完成（2025-11-20）

---

### 3.2 F2：NPC 列表展示

#### 3.2.1 功能描述

展示用户创建的所有 NPC，支持点击进入对话页面。

#### 3.2.2 功能流程

```
用户进入 NPC 列表页面
  ↓
前端请求用户的所有 NPC 列表
  ↓
后端查询数据库，返回 NPC 列表
  ↓
前端渲染 NPC 卡片列表
  ├─ 每个卡片显示：头像、名称、类型、最后对话时间
  └─ 卡片可点击，进入对话页面
  ↓
用户点击某个 NPC 卡片
  ↓
跳转到该 NPC 的对话页面
```

#### 3.2.3 输入输出规范

**输入**：

- 无（通过 userId 自动获取）

**输出**：

- NPC 列表数组，每个元素包含：
  - `id`: Agent ID
  - `name`: NPC 名称
  - `type`: NPC 类型
  - `avatarUrl`: 头像 URL（可选）
  - `createdAt`: 创建时间戳
  - `lastMessageAt`: 最后对话时间（可选）

#### 3.2.4 业务规则

1. **列表排序**：按最后对话时间倒序排列（最近对话的在前），如果没有对话记录，按创建时间倒序
2. **空状态**：如果用户没有创建任何 NPC，显示"创建你的第一个 NPC"提示和创建按钮
3. **自动刷新**：
   - 页面可见性变化时自动刷新
   - 从聊天页返回时自动刷新
   - 每 30 秒自动刷新一次（仅在页面可见时）

#### 3.2.5 UI 设计要求

- **卡片布局**：网格布局，每行显示 2-4 个卡片（响应式）
- **卡片内容**：
  - 头像（圆形，默认头像如果未设置）
  - 名称（粗体，最大 2 行，超出省略）
  - 类型标签（"通用"或"特定"）
  - 最后对话时间（相对时间，如"2 小时前"）
  - 消息预览（最后一条消息的纯文本预览，最多 60 字符）
- **交互效果**：卡片 hover 时有阴影效果，点击有反馈
- **移动端优化**：移动端隐藏用户名和注册按钮，优化创建按钮大小

#### 3.2.6 边界条件

- **空列表**：显示空状态提示和创建按钮
- **加载中**：显示加载动画
- **加载失败**：显示错误提示和重试按钮

#### 3.2.7 验收标准

- [x] 正确显示用户创建的所有 NPC ✅
- [x] 列表按最后对话时间倒序排列 ✅
- [x] 点击卡片能够跳转到对话页面 ✅
- [x] 空状态正确显示 ✅
- [x] 加载状态和错误状态正确处理 ✅
- [x] 自动刷新功能正常工作 ✅
- [x] 移动端显示优化 ✅

**实现状态**：已完成（2025-11-20）

---

### 3.3 F2.1：获取 NPC 详情

#### 3.3.1 功能描述

获取指定 NPC 的详细信息，用于对话页面显示 NPC 信息。

#### 3.3.2 功能流程

```
用户进入对话页面
  ↓
前端请求 NPC 详情
  GET /api/v1/agents/:id?userId=xxx
  ↓
后端查询数据库
  ↓
返回 NPC 详细信息
  ↓
前端显示 NPC 信息（名称、头像等）
```

#### 3.3.3 输入输出规范

**请求参数**：

| 参数名 | 类型   | 必填 | 说明                    |
| ------ | ------ | ---- | ----------------------- |
| id     | string | 是   | NPC ID（路径参数）      |
| userId | string | 是   | 用户 ID（查询参数）     |

**响应格式**：

```json
{
  "success": true,
  "data": {
    "id": "agent_456",
    "userId": "user_123",
    "name": "学习教练",
    "type": "special",
    "model": "gpt-4.1",
    "systemPrompt": "你是一位专业的学习教练...",
    "avatarUrl": "https://example.com/avatar.png",
    "createdAt": 1703001234567,
    "updatedAt": 1703001234567
  }
}
```

#### 3.3.4 业务规则

1. 只能查询当前用户创建的 NPC
2. 如果 NPC 不存在或不属于当前用户，返回 404

#### 3.3.5 验收标准

- [x] 正确返回 NPC 详细信息 ✅
- [x] 权限验证正确执行 ✅

**实现状态**：已完成（2025-11-21）

---

## 4. 对话系统模块

### 4.1 F5：发送消息

#### 4.1.1 功能描述

用户向选中的 NPC 发送消息，系统调用 LLM API 生成回复，并保存对话记录。

#### 4.1.2 功能流程（V1 实现：短轮询方案）

```
用户在输入框输入消息
  ↓
点击发送按钮（或按 Enter）
  ↓
前端验证消息
  ├─ 消息不能为空
  ├─ 消息长度不超过 5000 字符
  └─ 发送按钮禁用，显示加载状态
  ↓
发送 POST /api/v1/messages 请求
  ├─ userId: 用户 ID
  ├─ agentId: NPC ID
  └─ content: 消息内容
  ↓
后端处理流程（异步）：
  ├─ 1. 验证参数（userId, agentId, content）
  ├─ 2. 写入 Event（用户发言，同步）
  ├─ 3. 读取 Agent 配置（获取 systemPrompt 和 model）
  ├─ 4. 获取最近 N 条历史事件（上下文，默认 20 条）
  ├─ 5. 构建 LLM Prompt
  │   ├─ system: Agent 的 systemPrompt
  │   └─ messages: 历史事件转换为对话格式
  ├─ 6. 调用 LLM API（使用 Agent 配置的 model，异步）
  └─ 7. 写入 Event（NPC 回复，同步）
  ↓
后端立即返回用户消息 Event ID
  ↓
前端接收响应，立即显示用户消息
  ↓
前端开始轮询检查新消息
  ├─ 每 5 秒发送 GET /api/v1/messages/check 请求
  ├─ 最多轮询 60 次（5 分钟）
  └─ 检测到新消息后停止轮询
  ↓
后端生成 NPC 回复后，前端轮询检测到新消息
  ↓
前端显示 NPC 回复
  ↓
前端停止轮询，恢复发送按钮状态
```

#### 4.1.3 输入输出规范

**请求格式**：

```json
{
  "userId": "user_123",
  "agentId": "agent_456",
  "content": "今天有什么学习建议？"
}
```

**响应格式**（立即返回）：

```json
{
  "success": true,
  "data": {
    "userEventId": "event_789",
    "sessionId": "session_xxx"
  }
}
```

**轮询检查接口**：`GET /api/v1/messages/check?sessionId=xxx&lastEventId=yyy`

**轮询响应格式**：

```json
{
  "success": true,
  "data": {
    "hasNewMessage": true,
    "newEvent": {
      "id": "event_790",
      "content": "我们先从制定学习计划开始吧...",
      "timestamp": 1703001234567
    }
  }
}
```

#### 4.1.4 业务规则

1. **消息长度限制**：单条消息不超过 5000 字符
2. **上下文窗口**：默认获取最近 20 条事件作为上下文（可配置）
3. **重试机制**：LLM API 调用失败时，自动重试 2 次（指数退避）
4. **超时处理**：LLM API 调用超时时间设置为 30 秒（可配置，默认 30 秒）
5. **并发控制**：同一用户同一 NPC 的对话请求串行处理（防止消息顺序混乱）
6. **LLM 提供商支持**：支持 OpenAI、DeepSeek、OpenRouter 三个提供商
7. **模型配置**：支持预设模型和自定义模型两种配置模式
8. **多 API Key 支持**：支持多个 API Key，自动故障转移
9. **轮询机制**：前端每 5 秒轮询一次，最多轮询 60 次（5 分钟）

#### 4.1.5 Prompt 构建规则

**System Prompt**：

- 直接使用 Agent 的 `systemPrompt` 字段（如果为空，则不设置 system prompt）

**Messages 构建**：

- 将历史事件转换为对话格式
- 用户发言：`{ role: 'user', content: event.content }`
- NPC 回复：`{ role: 'assistant', content: event.content }`
- 按时间顺序排列

#### 4.1.6 边界条件

- **消息为空**：前端阻止发送，提示"消息不能为空"
- **消息过长**：前端阻止发送，提示"消息过长，请缩短"
- **Agent 不存在**：返回错误"NPC 不存在"
- **LLM API 失败**：重试后仍失败，前端轮询超时后提示错误
- **LLM API 超时**：返回超时错误，前端轮询超时后提示用户重试
- **轮询超时**：5 分钟后仍未收到回复，提示用户"AI 回复生成失败，请稍后重试"

#### 4.1.7 错误处理

| 错误场景     | 错误码           | 错误信息                      | 处理方式           |
| ------------ | ---------------- | ----------------------------- | ------------------ |
| 消息为空     | VALIDATION_ERROR | "消息不能为空"                | 前端提示，阻止发送 |
| 消息过长     | VALIDATION_ERROR | "消息过长，请缩短"            | 前端提示，阻止发送 |
| Agent 不存在 | AGENT_NOT_FOUND  | "NPC 不存在"                  | 返回错误，前端提示 |
| LLM API 失败 | LLM_API_ERROR    | "AI 回复生成失败，请稍后重试" | 记录日志，返回错误 |
| LLM API 超时 | LLM_API_TIMEOUT  | "请求超时，请重试"            | 记录日志，返回错误 |
| 系统错误     | SYSTEM_ERROR     | "系统错误，请稍后重试"        | 记录日志，返回错误 |

#### 4.1.8 性能要求

- **响应时间**：P95 响应时间 < 3 秒（取决于 LLM API 速度）
- **并发支持**：支持至少 100 并发请求
- **重试延迟**：重试间隔指数退避，最多重试 2 次

#### 4.1.9 验收标准

- [x] 用户能够成功发送消息并收到 NPC 回复 ✅
- [x] 消息和回复都正确保存到事件记录中 ✅
- [x] NPC 回复基于历史上下文生成 ✅
- [x] 消息验证规则正确执行 ✅
- [x] LLM API 失败时正确处理和提示 ✅
- [x] 发送过程有明确的加载状态 ✅
- [x] 轮询机制正常工作 ✅
- [x] 多 API Key 故障转移正常工作 ✅

**实现状态**：已完成（2025-11-21）

---

### 4.2 F6：获取对话历史

#### 4.2.1 功能描述

获取用户与指定 NPC 的完整对话历史记录。

#### 4.2.2 功能流程

```
用户进入对话页面
  ↓
前端请求对话历史
  GET /api/v1/history?agentId=xxx&userId=yyy
  ↓
后端查询事件记录
  ├─ 查询条件：agentId + userId
  ├─ 排序：按 timestamp 升序
  └─ 返回所有事件
  ↓
前端渲染对话历史
  ├─ 用户消息：左侧显示（纯文本）
  ├─ NPC 消息：右侧显示（Markdown 渲染）
  └─ 按时间顺序排列
```

#### 4.2.3 输入输出规范

**请求参数**：

| 参数名  | 类型   | 必填 | 说明                            |
| ------- | ------ | ---- | ------------------------------- |
| agentId | string | 是   | NPC ID                          |
| userId  | string | 是   | 用户 ID                         |
| limit   | number | 否   | 返回数量限制（默认不限制）      |
| offset  | number | 否   | 偏移量（用于分页，V1 暂不支持） |

**响应格式**：

```json
{
  "success": true,
  "data": {
    "events": [
      {
        "id": "event_1",
        "sessionId": "session_xxx",
        "fromType": "user",
        "fromId": "user_123",
        "toType": "agent",
        "toId": "agent_456",
        "content": "你好",
        "timestamp": 1703001000000
      },
      {
        "id": "event_2",
        "sessionId": "session_xxx",
        "fromType": "agent",
        "fromId": "agent_456",
        "toType": "user",
        "toId": "user_123",
        "content": "你好！我是你的学习教练...",
        "timestamp": 1703001001000
      }
    ],
    "total": 2
  }
}
```

#### 4.2.4 业务规则

1. **数据隔离**：只返回指定 userId 和 agentId 的事件记录
2. **时间排序**：按 timestamp 升序排列（最早的在前面）
3. **完整历史**：V1 返回所有历史记录（不限制数量，但需考虑性能）
4. **空历史**：如果没有历史记录，返回空数组
5. **Markdown 渲染**：NPC 消息支持 Markdown 渲染（代码高亮、表格、列表等）

#### 4.2.5 边界条件

- **无历史记录**：返回空数组，前端显示"开始你的第一次对话吧"
- **Agent 不存在**：返回错误"NPC 不存在"
- **参数缺失**：返回参数错误

#### 4.2.6 性能要求

- **查询性能**：在 1000 条记录内，查询时间 < 100ms
- **数据量限制**：V1 暂不限制，但需考虑未来分页

#### 4.2.7 验收标准

- [x] 正确返回用户与 NPC 的所有对话历史 ✅
- [x] 历史记录按时间顺序正确排列 ✅
- [x] NPC 消息正确渲染 Markdown ✅
- [x] 空历史时正确显示空状态 ✅
- [x] 查询性能满足要求 ✅

**实现状态**：已完成（2025-11-21）

---

### 4.3 F6.1：获取会话列表

#### 4.3.1 功能描述

获取用户的所有会话列表，每个会话对应一个用户与 NPC 的对话。

#### 4.3.2 功能流程

```
用户进入 NPC 列表页面
  ↓
前端请求会话列表
  GET /api/v1/sessions?userId=xxx
  ↓
后端查询会话记录
  ├─ 查询条件：userId
  ├─ 为每个会话补充 Agent 信息
  └─ 按最后活动时间倒序排列
  ↓
前端使用会话信息（如显示最后对话时间）
```

#### 4.3.3 输入输出规范

**请求参数**：

| 参数名 | 类型   | 必填 | 说明    |
| ------ | ------ | ---- | ------- |
| userId | string | 是   | 用户 ID |

**响应格式**：

```json
{
  "success": true,
  "data": {
    "sessions": [
      {
        "id": "session_xxx",
        "participants": [
          { "id": "user_123", "type": "user" },
          { "id": "agent_456", "type": "agent" }
        ],
        "agent": {
          "id": "agent_456",
          "name": "学习教练",
          "avatarUrl": "https://..."
        },
        "lastActiveAt": 1703002000000,
        "createdAt": 1703001000000
      }
    ],
    "total": 1
  }
}
```

#### 4.3.4 业务规则

1. **单会话模式**：同一参与者组合（用户 + Agent）只有一个会话
2. **排序规则**：按最后活动时间倒序排列
3. **Agent 信息**：为每个会话补充对应的 Agent 信息

#### 4.3.5 验收标准

- [x] 正确返回用户的所有会话列表 ✅
- [x] 会话按最后活动时间正确排序 ✅
- [x] 每个会话包含 Agent 信息 ✅

**实现状态**：已完成（2025-11-21）

---

## 5. 事件系统模块

### 5.1 F8：事件记录

#### 5.1.1 功能描述

统一记录所有对话事件（用户发言、NPC 回复），为对话历史和上下文提供数据基础。

#### 5.1.2 功能说明

事件记录是系统的核心数据层，所有对话都通过事件记录。事件记录在以下场景自动创建：

1. **用户发送消息时**：自动创建用户发言事件
2. **NPC 生成回复时**：自动创建 NPC 回复事件

#### 5.1.3 事件结构

```typescript
interface Event {
  id: string; // 事件唯一 ID（自动生成）
  sessionId: string; // 会话 ID（独立生成）
  userId: string; // 用户 ID
  agentId: string; // Agent ID
  fromType: "user" | "agent"; // 发送者类型
  fromId: string; // 发送者 ID
  toType: "user" | "agent"; // 接收者类型
  toId: string; // 接收者 ID
  content: string; // 消息内容
  timestamp: number; // 时间戳（毫秒，服务器时间）
}
```

**设计说明**：

- `sessionId` 独立生成，支持未来多参与者会话扩展
- `participants` 列表存储在 Session 中，支持灵活查询
- Session 和 Event 已分离为独立的 Repository 和 Service

#### 5.1.4 业务规则

1. **自动创建**：事件在对话流程中自动创建，不需要单独调用 API
2. **唯一性**：每个事件都有唯一的 ID（自动生成）
3. **Session ID**：sessionId 独立生成，通过 participants 列表关联用户和 Agent
4. **时间戳**：使用服务器时间戳，确保时间准确性
5. **内容存储**：原始内容完整存储，不做修改
6. **会话管理**：同一参与者组合只有一个会话（单会话模式）
7. **活动时间**：创建事件时自动更新会话的 lastActiveAt

#### 5.1.5 数据持久化

- **存储方式**：MySQL 数据库
- **索引设计**：
  - 主键索引：`id`
  - 会话索引：`session_id`（用于快速查询会话的所有事件）
  - 时间戳索引：`timestamp`（用于排序和范围查询）
  - 用户和 Agent 索引：`user_id`、`agent_id`（用于关联查询）
- **数据保留**：事件记录永久保存，不自动删除
- **架构设计**：Session 和 Event 已分离为独立的 Repository 和 Service

#### 5.1.6 验收标准

- [x] 用户发言时自动创建事件记录 ✅
- [x] NPC 回复时自动创建事件记录 ✅
- [x] 事件记录包含所有必需字段 ✅
- [x] 事件记录正确保存到数据库 ✅

**实现状态**：已完成（2025-11-21）

---

### 5.2 F9：事件查询

#### 5.2.1 功能描述

查询指定会话的事件记录，支持按时间范围、事件类型等条件查询。

#### 5.2.2 查询场景

1. **获取对话历史**：查询用户与 NPC 的所有事件
2. **构建上下文**：查询最近 N 条事件用于 LLM 上下文

#### 5.2.3 查询接口

**基础查询**：

- 按 sessionId 查询
- 按 userId 和 agentId 查询
- 按时间范围查询（V1 已实现但未使用）
- 按事件类型查询（V1 已实现但未使用）

**排序和分页**：

- 按 timestamp 排序（升序/降序）
- 支持 limit（V1 已实现但未使用）

#### 5.2.4 性能优化

- **索引优化**：在 sessionId、timestamp、user_id、agent_id 上建立索引
- **查询缓存**：对最近查询的会话历史进行缓存（V2 考虑）

#### 5.2.5 验收标准

- [x] 能够正确查询指定会话的事件记录 ✅
- [x] 查询结果按时间正确排序 ✅
- [x] 查询性能满足要求 ✅

**实现状态**：已完成（2025-11-21）

---

## 6. 功能依赖关系

```
F0 (用户登录)
  └─> F1 (创建 NPC)
  └─> F2 (NPC 列表展示)

F0.1 (用户注册)
  └─> F0 (用户登录)

F1 (创建 NPC)
  └─> F2 (NPC 列表展示)

F2 (NPC 列表展示)
  └─> F5 (发送消息)
  └─> F6 (获取对话历史)

F5 (发送消息)
  └─> F8 (事件记录)
  └─> F6 (获取对话历史) [用于构建上下文]

F6 (获取对话历史)
  └─> F9 (事件查询)
```

---

## 7. 功能优先级总结

### P0（必须实现）

- F0：用户登录 ✅
- F0.1：用户注册 ✅
- F1：创建 NPC ✅
- F2：NPC 列表展示 ✅
- F2.1：获取 NPC 详情 ✅
- F5：发送消息 ✅
- F6：获取对话历史 ✅
- F6.1：获取会话列表 ✅
- F8：事件记录 ✅
- F9：事件查询 ✅

---

## 8. 相关文档

- [API 设计](./04-API设计.md) - API 接口详细设计
- [数据模型](./05-数据模型.md) - 数据结构设计
- [系统架构](./06-系统架构.md) - 系统架构设计

---

**文档维护**：功能需求变更时，需同步更新本文档和相关 API 文档。

