# 02-用户场景与用例（V1）

**文档版本**：v1.0.0  
**最后更新**：2025-11-22  
**相关文档**：[产品概述](./01-产品概述.md) | [功能需求](./03-功能需求.md)

---

## 1. 用户场景总览

### 1.1 场景分类

| 场景编号 | 场景名称       | 优先级 | 相关功能 | 状态 |
| -------- | -------------- | ------ | -------- | ---- |
| UC-001   | 创建 NPC       | P0     | F1       | ✅ 已完成 |
| UC-002   | 查看 NPC 列表  | P0     | F2       | ✅ 已完成 |
| UC-003   | 与 NPC 对话    | P0     | F5, F6   | ✅ 已完成 |
| UC-004   | 查看对话历史   | P0     | F6       | ✅ 已完成 |

---

## 2. 详细用户场景

### 2.1 UC-001：创建 NPC

#### 2.1.1 场景描述

用户希望创建不同风格的 AI NPC，以满足不同场景的需求，如学习教练、心理导师、通用助手、情绪陪伴 AI 等。

#### 2.1.2 用户角色

- **主要角色**：普通用户（我的朋友）

#### 2.1.3 前置条件

- 用户已注册并登录系统
- 用户了解如何创建 NPC（通过界面引导或文档）

#### 2.1.4 主流程（Happy Path）

```
1. 用户进入 NPC 列表页面
2. 用户点击"创建新 NPC"按钮
3. 系统显示创建 NPC 表单页面
4. 用户填写 NPC 信息：
   - 输入 NPC 名称（如"学习教练"）
   - 选择 NPC 类型（通用/特定）
   - 输入人设描述（system prompt，可选）
   - 选择使用的 LLM 模型
   - （可选）输入头像 URL
5. 用户点击"创建"按钮
6. 系统验证表单数据
7. 系统创建 NPC 并保存到数据库
8. 系统返回成功响应
9. 系统跳转到 NPC 列表页面
10. 新创建的 NPC 显示在列表中
```

#### 2.1.5 备选流程

**备选流程 A：名称重复**

```
5. 用户点击"创建"按钮
6. 系统验证表单数据
7. 系统检测到名称已存在
8. 系统返回错误提示："该名称已存在，请使用其他名称"
9. 用户修改名称后重新提交
10. 继续主流程步骤 6
```

**备选流程 B：表单验证失败**

```
5. 用户点击"创建"按钮
6. 系统验证表单数据
7. 系统检测到必填字段为空或格式不正确
8. 系统在对应字段下方显示错误提示
9. 用户修正错误后重新提交
10. 继续主流程步骤 6
```

#### 2.1.6 业务规则

1. 同一用户的 NPC 名称不能重复（不区分大小写）
2. NPC 名称长度：1-50 字符
3. 人设描述长度：可选，无最小长度限制
4. 只能选择系统支持的模型列表中的模型
5. 头像 URL 必须是有效的 URL 格式（如果提供）

#### 2.1.7 验收标准

- [x] 用户能够成功创建 NPC ✅
- [x] 创建成功后 NPC 立即出现在列表中 ✅
- [x] 名称重复时正确提示错误 ✅
- [x] 表单验证规则正确执行 ✅
- [x] 创建过程有明确的加载状态提示 ✅

---

### 2.2 UC-002：查看 NPC 列表

#### 2.2.1 场景描述

用户希望查看自己创建的所有 NPC，以便快速选择想要对话的 NPC。

#### 2.2.2 用户角色

- **主要角色**：普通用户（我的朋友）

#### 2.2.3 前置条件

- 用户已登录系统
- 用户至少创建过一个 NPC（可选，空状态也需要处理）

#### 2.2.4 主流程

```
1. 用户进入 NPC 列表页面
2. 系统请求用户的所有 NPC 列表
3. 系统查询数据库获取 NPC 列表
4. 系统按最后对话时间倒序排列 NPC（如果没有对话，按创建时间倒序）
5. 系统渲染 NPC 卡片列表
6. 用户查看 NPC 列表
7. 用户点击某个 NPC 卡片
8. 系统跳转到该 NPC 的对话页面
```

#### 2.2.5 备选流程

**备选流程 A：空列表**

```
1. 用户进入 NPC 列表页面
2. 系统请求用户的所有 NPC 列表
3. 系统查询数据库，发现用户没有创建任何 NPC
4. 系统显示空状态提示："创建你的第一个 NPC"
5. 系统显示"创建新 NPC"按钮
6. 用户点击"创建新 NPC"按钮
7. 系统跳转到创建 NPC 页面
```

#### 2.2.6 业务规则

1. 列表按最后对话时间倒序排列（最近对话的在前）
2. 如果没有对话记录，按创建时间倒序排列
3. 每个 NPC 卡片显示：头像、名称、类型、最后对话时间（或创建时间）
4. 空列表时显示友好的空状态提示
5. 页面可见性变化时自动刷新列表
6. 每 30 秒自动刷新一次（仅在页面可见时）

#### 2.2.7 验收标准

- [x] 正确显示用户创建的所有 NPC ✅
- [x] 列表按最后对话时间正确排序 ✅
- [x] 点击卡片能够跳转到对话页面 ✅
- [x] 空状态正确显示 ✅
- [x] 自动刷新功能正常工作 ✅

---

### 2.3 UC-003：与 NPC 对话

#### 2.3.1 场景描述

用户希望与选中的 NPC 进行对话，发送消息并收到 NPC 的回复。

#### 2.3.2 用户角色

- **主要角色**：普通用户（我的朋友）

#### 2.3.3 前置条件

- 用户已选择某个 NPC
- 用户已进入对话页面
- 系统已加载对话历史（如果有）

#### 2.3.4 主流程

```
1. 用户在输入框输入消息
2. 用户点击"发送"按钮（或按 Enter）
3. 系统验证消息（不能为空，长度不超过 5000 字符）
4. 系统禁用发送按钮，显示加载状态
5. 系统发送 POST /api/v1/messages 请求
6. 后端处理流程：
   a. 验证参数
   b. 写入用户发言事件（同步）
   c. 读取 NPC 配置
   d. 获取最近 N 条历史事件（上下文）
   e. 构建 LLM Prompt
   f. 调用 LLM API（异步）
   g. 写入 NPC 回复事件（同步）
   h. 返回用户消息 Event ID
7. 前端接收响应，立即显示用户消息
8. 前端开始轮询检查新消息（每 5 秒一次）
9. 后端生成 NPC 回复后，前端轮询检测到新消息
10. 系统在对话界面显示 NPC 回复
11. 系统滚动到底部显示最新消息
12. 系统停止轮询，恢复发送按钮状态
```

#### 2.3.5 备选流程

**备选流程 A：消息为空**

```
2. 用户点击"发送"按钮（或按 Enter）
3. 系统验证消息，发现消息为空
4. 系统在输入框下方显示错误提示："消息不能为空"
5. 系统阻止发送
6. 用户输入消息后重新发送
7. 继续主流程步骤 3
```

**备选流程 B：LLM API 失败**

```
6. 后端处理流程：
   f. 调用 LLM API 失败（网络错误、API 错误等）
   g. 系统自动重试 2 次（指数退避）
   h. 重试后仍失败
9. 前端轮询超时（最多 5 分钟）
10. 系统显示错误提示："AI 回复生成失败，请稍后重试"
11. 系统停止轮询，恢复发送按钮状态
12. 用户消息已保存，但 NPC 未回复
```

#### 2.3.6 业务规则

1. 消息长度限制：1-5000 字符
2. 上下文窗口：默认获取最近 20 条事件
3. 重试机制：LLM API 失败时自动重试 2 次（指数退避）
4. 超时时间：LLM API 调用超时时间 30 秒
5. 轮询机制：前端每 5 秒轮询一次，最多轮询 60 次（5 分钟）
6. 并发控制：同一用户同一 NPC 的请求串行处理

#### 2.3.7 验收标准

- [x] 用户能够成功发送消息并收到 NPC 回复 ✅
- [x] 消息和回复都正确保存 ✅
- [x] NPC 回复基于历史上下文生成 ✅
- [x] 消息验证规则正确执行 ✅
- [x] LLM API 失败时正确处理和提示 ✅
- [x] 发送过程有明确的加载状态 ✅
- [x] 轮询机制正常工作 ✅

---

### 2.4 UC-004：查看对话历史

#### 2.4.1 场景描述

用户希望查看与某个 NPC 的完整对话历史，以便回顾之前的对话内容。

#### 2.4.2 用户角色

- **主要角色**：普通用户（我的朋友）

#### 2.4.3 前置条件

- 用户已选择某个 NPC
- 用户已进入对话页面
- 用户与该 NPC 有过对话记录（可选，空历史也需要处理）

#### 2.4.4 主流程

```
1. 用户进入对话页面
2. 系统自动请求对话历史
3. 系统发送 GET /api/v1/history 请求
4. 后端查询事件记录
5. 后端返回事件列表（按时间升序）
6. 系统渲染对话历史：
   - 用户消息：左侧显示（纯文本）
   - NPC 消息：右侧显示（Markdown 渲染）
   - 按时间顺序排列
7. 用户查看对话历史
8. 用户滚动查看历史消息
```

#### 2.4.5 备选流程

**备选流程 A：空历史**

```
1. 用户进入对话页面
2. 系统自动请求对话历史
3. 系统发送 GET /api/v1/history 请求
4. 后端查询事件记录，发现没有历史记录
5. 后端返回空数组
6. 系统显示空状态提示："开始你的第一次对话吧"
7. 用户输入消息开始对话
```

#### 2.4.6 业务规则

1. 只显示当前用户与当前 NPC 的对话记录
2. 按时间升序排列（最早的在上面）
3. 空历史时显示友好的空状态提示
4. V1 返回所有历史记录（不限制数量）
5. NPC 消息支持 Markdown 渲染（代码高亮、表格、列表等）

#### 2.4.7 验收标准

- [x] 正确显示用户与 NPC 的所有对话历史 ✅
- [x] 历史记录按时间顺序正确排列 ✅
- [x] 用户消息和 NPC 消息正确区分显示 ✅
- [x] NPC 消息正确渲染 Markdown ✅
- [x] 空历史时正确显示空状态 ✅

---

## 3. 用户故事（User Stories）

### 3.1 用户故事列表

#### US-001：创建学习教练 NPC

**作为** 一个需要学习指导的学生（我的朋友）  
**我希望** 能够创建一个"学习教练"类型的 NPC  
**以便于** 获得个性化的学习建议和计划

**验收标准**：

- [x] 能够成功创建学习教练 NPC ✅
- [x] NPC 的人设符合学习教练的特点 ✅
- [x] 创建后可以立即使用 ✅

#### US-002：创建心理导师 NPC

**作为** 一个需要情感支持的用户（我的朋友）  
**我希望** 能够创建一个"心理导师"类型的 NPC  
**以便于** 获得心理疏导和情感陪伴

**验收标准**：

- [x] 能够成功创建心理导师 NPC ✅
- [x] NPC 的回复风格温和、支持性 ✅
- [x] 能够进行深度对话 ✅

#### US-003：快速切换 NPC

**作为** 一个创建了多个 NPC 的用户（我的朋友）  
**我希望** 能够在 NPC 列表页面快速切换不同的 NPC  
**以便于** 根据不同需求与不同的 NPC 对话

**验收标准**：

- [x] NPC 列表清晰展示所有 NPC ✅
- [x] 点击卡片能够快速跳转到对话页面 ✅
- [x] 切换过程流畅无延迟 ✅

#### US-004：回顾历史对话

**作为** 一个与 NPC 有过多次对话的用户（我的朋友）  
**我希望** 能够查看完整的对话历史  
**以便于** 回顾之前的对话内容和建议

**验收标准**：

- [x] 能够查看所有历史对话 ✅
- [x] 历史记录按时间顺序排列 ✅
- [x] NPC 回复支持 Markdown 渲染，阅读体验良好 ✅

---

## 4. 相关文档

- [产品概述](./01-产品概述.md) - 产品定义和目标
- [功能需求](./03-功能需求.md) - 详细功能需求说明
- [API 设计](./04-API设计.md) - API 接口设计

---

**文档维护**：用户场景变更时，需同步更新本文档和功能需求文档。

