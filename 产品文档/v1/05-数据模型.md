# 05-数据模型（V1）

**文档版本**：v1.0.0  
**最后更新**：2025-11-22  
**相关文档**：[功能需求](./03-功能需求.md) | [API设计](./04-API设计.md)

---

## 1. 数据模型总览

### 1.1 核心实体

| 实体   | 说明               | 表名    |
| ------ | ------------------ | ------- |
| User   | 用户信息           | `users` |
| Agent  | AI NPC 配置信息    | `agents` |
| Event  | 对话事件记录       | `events` |
| Session| 会话信息           | `sessions` |

### 1.2 实体关系

```
User (用户)
  ├── 1:N ──> Agent (NPC)
  ├── 1:N ──> Event (事件)
  └── 1:N ──> Session (会话)

Agent (NPC)
  └── 1:N ──> Event (事件)
  └── 1:1 ──> Session (会话)

Event (事件)
  ├── N:1 ──> User (用户)
  ├── N:1 ──> Agent (NPC)
  └── N:1 ──> Session (会话)

Session (会话)
  ├── N:1 ──> User (用户)
  └── N:1 ──> Agent (NPC)
```

---

## 2. User（用户）数据模型

### 2.1 实体说明

User 表示系统用户，包含用户的基本信息和认证信息。V1 版本实现了基础的登录和注册功能。

### 2.2 数据表结构

**表名**：`users`

| 字段名     | 类型         | 约束 | 说明                         | 示例       |
| ---------- | ------------ | ---- | ---------------------------- | ---------- |
| id         | string(100)  | PK, NOT NULL | 唯一标识符（User ID）       | "user_123" |
| username   | string(50)   | UNIQUE, NOT NULL | 用户昵称（显示名称）        | "TestUser" |
| password   | string(255)  | NOT NULL | 密码（V1 版本明文存储）     | "password" |
| created_at | bigint       | NOT NULL, INDEX | 创建时间戳（毫秒）          | 1703001234567 |
| updated_at | bigint       | NOT NULL | 更新时间戳（毫秒）          | 1703001234567 |

**注意**：
- V1 版本密码使用明文存储（简化实现）
- V1.5 版本将改为密码哈希存储（使用 bcrypt）

### 2.3 字段详细说明

#### id（主键）
- **类型**：string(100)
- **生成规则**：用户自定义或系统生成（V1 版本允许用户自定义）
- **示例**：`user_123` 或 `user_550e8400-e29b-41d4-a716-446655440000`
- **约束**：必须唯一，不能重复

#### username（用户昵称）
- **类型**：string(50)
- **约束**：
  - 不能为空
  - 长度：1-50 字符
  - 必须唯一，不能重复
- **说明**：用户的显示名称，用于前端展示

#### password（密码）
- **类型**：string(255)
- **约束**：
  - 不能为空
  - 长度：至少 6 字符（V1 版本简化验证）
- **说明**：
  - V1 版本：明文存储（简化实现，仅用于开发测试）
  - V1.5 版本：改为密码哈希存储（使用 bcrypt）

#### created_at / updated_at（时间戳）
- **类型**：bigint（毫秒时间戳）
- **说明**：记录创建和更新时间
- **索引**：created_at 建立索引，用于排序

### 2.4 索引设计

```sql
-- 主键索引（自动创建）
PRIMARY KEY (id)

-- 用户名唯一索引
CREATE UNIQUE INDEX idx_users_username ON users(username);

-- 创建时间索引（排序）
CREATE INDEX idx_users_created_at ON users(created_at);
```

### 2.5 数据示例

```json
{
  "id": "user_123",
  "username": "TestUser",
  "password": "password",
  "createdAt": 1703001234567,
  "updatedAt": 1703001234567
}
```

**注意**：返回用户信息时，不应包含 password 字段。

---

## 3. Agent（NPC）数据模型

### 3.1 实体说明

Agent 表示用户创建的 AI NPC，包含 NPC 的基本信息、人设配置和使用的模型。

### 3.2 数据表结构

**表名**：`agents`

| 字段名        | 类型         | 约束 | 说明                           | 示例          |
| ------------- | ------------ | ---- | ------------------------------ | ------------- |
| id            | string(100)  | PK, NOT NULL | 唯一标识符                     | "agent_456"   |
| user_id       | string(100)  | NOT NULL, INDEX | 用户 ID                        | "user_123"    |
| name          | string(50)   | NOT NULL | NPC 名称                       | "学习教练"    |
| type          | enum         | NOT NULL | NPC 类型：general/special      | "special"     |
| model         | string(100)  | NOT NULL | LLM 模型名称                   | "anthropic/claude-sonnet-4.5" |
| system_prompt | text         | NULL | NPC 人设描述（可选）           | "你是一位..." |
| avatar_url    | string(500)  | NULL | 头像 URL                       | "https://..." |
| created_at    | bigint       | NOT NULL, INDEX | 创建时间戳（毫秒）             | 1703001234567 |
| updated_at    | bigint       | NOT NULL | 更新时间戳（毫秒）             | 1703001234567 |

### 3.3 字段详细说明

#### id（主键）
- **类型**：string(100)
- **生成规则**：`agent_{timestamp}_{random}` 或使用 UUID
- **示例**：`agent_1703001234567_abc123`

#### user_id（用户 ID）
- **类型**：string(100)
- **说明**：创建该 NPC 的用户 ID
- **索引**：建立索引，用于快速查询用户的 NPC 列表

#### name（NPC 名称）
- **类型**：string(50)
- **约束**：
  - 不能为空
  - 长度：1-50 字符
  - 同一用户的 NPC 名称不能重复（不区分大小写）
- **验证规则**：前端和后端都需要验证

#### type（NPC 类型）
- **类型**：enum('general', 'special')
- **说明**：
  - `general`：通用助手，适用于多种场景
  - `special`：特定功能 NPC，专注于某个领域

#### model（LLM 模型）
- **类型**：string(100)
- **说明**：使用的 LLM 模型名称（V1 版本统一使用 OpenRouter）
- **格式**：`provider/model-name`（如 `anthropic/claude-sonnet-4.5`）
- **示例**：`anthropic/claude-sonnet-4.5`, `openai/gpt-4.1`, `google/gemini-3-pro-preview`

#### system_prompt（人设描述）
- **类型**：text
- **约束**：
  - 可选字段，可以为 NULL
  - 如果提供，建议长度：10-5000 字符
- **说明**：NPC 的 system prompt，用于定义 NPC 的人设和行为

#### avatar_url（头像 URL）
- **类型**：string(500)
- **约束**：可选字段，可以为 NULL
- **说明**：NPC 头像的 URL 地址
- **验证**：如果提供，需要验证 URL 格式

#### created_at / updated_at（时间戳）
- **类型**：bigint（毫秒时间戳）
- **说明**：记录创建和更新时间
- **索引**：created_at 建立索引，用于排序

### 3.4 索引设计

```sql
-- 主键索引（自动创建）
PRIMARY KEY (id)

-- 用户 ID 索引（查询用户的 NPC 列表）
CREATE INDEX idx_agents_user_id ON agents(user_id);

-- 创建时间索引（排序）
CREATE INDEX idx_agents_created_at ON agents(created_at);

-- 复合索引（查询用户的 NPC 列表并按时间排序）
CREATE INDEX idx_agents_user_created ON agents(user_id, created_at DESC);
```

### 3.5 唯一约束

```sql
-- 同一用户的 NPC 名称不能重复（不区分大小写）
-- 注意：需要在应用层实现，因为数据库的 UNIQUE 约束区分大小写
-- 可以在应用层查询时使用 LOWER(name) 进行比较
```

### 3.6 数据示例

```json
{
  "id": "agent_456",
  "user_id": "user_123",
  "name": "学习教练",
  "type": "special",
  "model": "anthropic/claude-sonnet-4.5",
  "system_prompt": "你是一位专业的学习教练，擅长制定学习计划、解答学习问题、提供学习建议。你总是以鼓励和支持的方式与用户交流，帮助用户建立良好的学习习惯。",
  "avatar_url": "https://example.com/avatars/learning-coach.png",
  "created_at": 1703001234567,
  "updated_at": 1703001234567
}
```

---

## 4. Event（事件）数据模型

### 4.1 实体说明

Event 表示用户与 NPC 之间的对话事件，包括用户发言和 NPC 回复。所有对话都通过事件记录，为对话历史和上下文提供数据基础。

### 4.2 数据表结构

**表名**：`events`

| 字段名     | 类型         | 约束 | 说明                           | 示例          |
| ---------- | ------------ | ---- | ------------------------------ | ------------- |
| id         | string(100)  | PK, NOT NULL | 唯一标识符                     | "event_789"   |
| session_id | string(200)  | NOT NULL, INDEX | 会话 ID                        | "session_xxx" |
| user_id    | string(100)  | NOT NULL, INDEX | 用户 ID                        | "user_123"    |
| agent_id   | string(100)  | NOT NULL, INDEX | NPC ID                         | "agent_456"   |
| from_type  | enum         | NOT NULL | 发送者类型：user/agent         | "user"        |
| from_id    | string(100)  | NOT NULL | 发送者 ID                      | "user_123"    |
| to_type    | enum         | NOT NULL | 接收者类型：user/agent         | "agent"       |
| to_id      | string(100)  | NOT NULL | 接收者 ID                      | "agent_456"   |
| content    | text         | NOT NULL | 消息内容                       | "今天有什么学习建议？" |
| timestamp  | bigint       | NOT NULL, INDEX | 时间戳（毫秒）                 | 1703001234567 |

### 4.3 字段详细说明

#### id（主键）
- **类型**：string(100)
- **生成规则**：`event_{timestamp}_{random}` 或使用 UUID
- **示例**：`event_1703001234567_xyz789`

#### session_id（会话 ID）
- **类型**：string(200)
- **说明**：关联的会话 ID，用于快速查询某个会话的所有事件
- **索引**：建立索引，提高查询性能

#### user_id / agent_id（用户和 NPC ID）
- **类型**：string(100)
- **说明**：用户 ID 和 NPC ID，用于关联查询
- **索引**：分别建立索引

#### from_type / to_type（发送者和接收者类型）
- **类型**：enum('user', 'agent')
- **说明**：
  - `from_type`：发送者类型
  - `to_type`：接收者类型
- **业务规则**：
  - 如果 `from_type = 'user'`，则 `to_type = 'agent'`
  - 如果 `from_type = 'agent'`，则 `to_type = 'user'`

#### from_id / to_id（发送者和接收者 ID）
- **类型**：string(100)
- **说明**：
  - `from_id`：发送者 ID（user_id 或 agent_id）
  - `to_id`：接收者 ID（user_id 或 agent_id）

#### content（消息内容）
- **类型**：text
- **约束**：
  - 不能为空
  - 长度：1-50000 字符（预留足够空间）
- **说明**：消息的原始内容，完整存储不做修改

#### timestamp（时间戳）
- **类型**：bigint（毫秒时间戳）
- **说明**：事件发生的时间，使用服务器时间
- **索引**：建立索引，用于排序和范围查询

### 4.4 索引设计

```sql
-- 主键索引（自动创建）
PRIMARY KEY (id)

-- 会话 ID 索引（查询会话的所有事件）
CREATE INDEX idx_events_session_id ON events(session_id);

-- 时间戳索引（排序和范围查询）
CREATE INDEX idx_events_timestamp ON events(timestamp);

-- 复合索引（查询会话的事件并按时间排序）
CREATE INDEX idx_events_session_timestamp ON events(session_id, timestamp ASC);

-- 用户 ID 索引（查询用户的所有事件）
CREATE INDEX idx_events_user_id ON events(user_id);

-- NPC ID 索引（查询 NPC 的所有事件）
CREATE INDEX idx_events_agent_id ON events(agent_id);

-- 复合索引（查询用户与 NPC 的事件并按时间排序）
CREATE INDEX idx_events_user_agent_timestamp ON events(user_id, agent_id, timestamp ASC);
```

### 4.5 数据示例

**用户发言事件**：
```json
{
  "id": "event_111",
  "session_id": "session_xxx",
  "user_id": "user_123",
  "agent_id": "agent_456",
  "from_type": "user",
  "from_id": "user_123",
  "to_type": "agent",
  "to_id": "agent_456",
  "content": "今天有什么学习建议？",
  "timestamp": 1703001234567
}
```

**NPC 回复事件**：
```json
{
  "id": "event_112",
  "session_id": "session_xxx",
  "user_id": "user_123",
  "agent_id": "agent_456",
  "from_type": "agent",
  "from_id": "agent_456",
  "to_type": "user",
  "to_id": "user_123",
  "content": "我们先从制定学习计划开始吧。首先，你需要明确今天的学习目标...",
  "timestamp": 1703001234568
}
```

---

## 5. Session（会话）数据模型

### 5.1 实体说明

Session 表示用户与 NPC 之间的会话，用于管理对话上下文和会话状态。V1 版本实现单会话模式（同一用户和 NPC 只有一个会话）。

### 5.2 数据表结构

**表名**：`sessions`

| 字段名         | 类型         | 约束 | 说明                           | 示例          |
| -------------- | ------------ | ---- | ------------------------------ | ------------- |
| id             | string(200)  | PK, NOT NULL | 唯一标识符（会话 ID）         | "session_xxx" |
| user_id        | string(100)  | NOT NULL, INDEX | 用户 ID                        | "user_123"    |
| agent_id       | string(100)  | NOT NULL, INDEX | NPC ID                         | "agent_456"   |
| created_at     | bigint       | NOT NULL, INDEX | 创建时间戳（毫秒）             | 1703001000000 |
| last_active_at | bigint       | NOT NULL, INDEX | 最后活动时间戳（毫秒）         | 1703002000000 |

### 5.3 字段详细说明

#### id（主键）
- **类型**：string(200)
- **生成规则**：系统自动生成唯一 ID
- **示例**：`session_1703001000000_abc123`

#### user_id / agent_id（用户和 NPC ID）
- **类型**：string(100)
- **说明**：会话的参与者（用户和 NPC）
- **索引**：分别建立索引，用于快速查询用户的会话列表

#### created_at（创建时间）
- **类型**：bigint（毫秒时间戳）
- **说明**：会话创建时间
- **索引**：建立索引，用于排序

#### last_active_at（最后活动时间）
- **类型**：bigint（毫秒时间戳）
- **说明**：会话最后活动时间（创建或更新事件时更新）
- **索引**：建立索引，用于排序和查询最近活跃的会话

### 5.4 索引设计

```sql
-- 主键索引（自动创建）
PRIMARY KEY (id)

-- 用户 ID 索引（查询用户的会话列表）
CREATE INDEX idx_sessions_user_id ON sessions(user_id);

-- NPC ID 索引（查询 NPC 的会话列表）
CREATE INDEX idx_sessions_agent_id ON sessions(agent_id);

-- 复合索引（查询用户与 NPC 的会话）
CREATE INDEX idx_sessions_user_agent ON sessions(user_id, agent_id);

-- 最后活动时间索引（排序）
CREATE INDEX idx_sessions_last_active_at ON sessions(last_active_at DESC);
```

### 5.5 业务规则

1. **单会话模式**：同一参与者组合（用户 + Agent）只有一个会话
2. **自动创建**：首次对话时自动创建会话
3. **自动更新**：创建事件时自动更新 `last_active_at`
4. **会话查询**：通过 user_id 和 agent_id 查询会话

### 5.6 数据示例

```json
{
  "id": "session_xxx",
  "user_id": "user_123",
  "agent_id": "agent_456",
  "created_at": 1703001000000,
  "last_active_at": 1703002000000
}
```

---

## 6. 数据库设计

### 6.1 数据库选型

**V1 版本使用**：MySQL 8.0

- **关系型数据库**：支持事务和复杂查询
- **性能优秀**：满足 V1 版本的性能需求
- **易于部署**：Docker 部署简单

### 6.2 数据库命名规范

- **表名**：小写，复数形式，使用下划线分隔（如 `agents`, `events`）
- **字段名**：小写，使用下划线分隔（如 `user_id`, `created_at`）
- **索引名**：`idx_{table}_{field}` 或 `idx_{table}_{field1}_{field2}`

### 6.3 数据类型选择

| 字段类型     | 数据库类型   | 说明               |
| ------------ | ------------ | ------------------ |
| string(50)   | VARCHAR(50)  | 短字符串           |
| string(100)  | VARCHAR(100) | 中等字符串         |
| string(200)  | VARCHAR(200) | 长字符串           |
| string(500)  | VARCHAR(500) | 超长字符串         |
| text         | TEXT         | 长文本             |
| enum         | ENUM         | 枚举类型           |
| bigint       | BIGINT       | 时间戳（毫秒）     |

### 6.4 数据库初始化 SQL

```sql
-- 创建 users 表
CREATE TABLE users (
  id VARCHAR(100) PRIMARY KEY,
  username VARCHAR(50) NOT NULL,
  password VARCHAR(255) NOT NULL,
  created_at BIGINT NOT NULL,
  updated_at BIGINT NOT NULL,
  UNIQUE INDEX idx_users_username (username),
  INDEX idx_users_created_at (created_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- 创建 agents 表
CREATE TABLE agents (
  id VARCHAR(100) PRIMARY KEY,
  user_id VARCHAR(100) NOT NULL,
  name VARCHAR(50) NOT NULL,
  type ENUM('general', 'special') NOT NULL,
  model VARCHAR(100) NOT NULL,
  system_prompt TEXT,
  avatar_url VARCHAR(500),
  created_at BIGINT NOT NULL,
  updated_at BIGINT NOT NULL,
  INDEX idx_agents_user_id (user_id),
  INDEX idx_agents_created_at (created_at),
  INDEX idx_agents_user_created (user_id, created_at DESC)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- 创建 sessions 表
CREATE TABLE sessions (
  id VARCHAR(200) PRIMARY KEY,
  user_id VARCHAR(100) NOT NULL,
  agent_id VARCHAR(100) NOT NULL,
  created_at BIGINT NOT NULL,
  last_active_at BIGINT NOT NULL,
  INDEX idx_sessions_user_id (user_id),
  INDEX idx_sessions_agent_id (agent_id),
  INDEX idx_sessions_user_agent (user_id, agent_id),
  INDEX idx_sessions_last_active_at (last_active_at DESC)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- 创建 events 表
CREATE TABLE events (
  id VARCHAR(100) PRIMARY KEY,
  session_id VARCHAR(200) NOT NULL,
  user_id VARCHAR(100) NOT NULL,
  agent_id VARCHAR(100) NOT NULL,
  from_type ENUM('user', 'agent') NOT NULL,
  from_id VARCHAR(100) NOT NULL,
  to_type ENUM('user', 'agent') NOT NULL,
  to_id VARCHAR(100) NOT NULL,
  content TEXT NOT NULL,
  timestamp BIGINT NOT NULL,
  INDEX idx_events_session_id (session_id),
  INDEX idx_events_timestamp (timestamp),
  INDEX idx_events_session_timestamp (session_id, timestamp ASC),
  INDEX idx_events_user_id (user_id),
  INDEX idx_events_agent_id (agent_id),
  INDEX idx_events_user_agent_timestamp (user_id, agent_id, timestamp ASC)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
```

---

## 7. 数据关系图（ER 图）

```
┌─────────────┐
│    User     │
│─────────────│
│ id (PK)     │
│ username    │
│ password    │
│ created_at  │
│ updated_at  │
└──────┬──────┘
       │
       │ 1:N
       │
       ├─────────────────┐
       │                 │
       │                 │
┌──────▼──────┐    ┌─────▼──────┐
│   Agent     │    │  Session   │
│─────────────│    │────────────│
│ id (PK)     │    │ id (PK)    │
│ user_id(FK) │    │ user_id(FK)│
│ name        │    │ agent_id(FK│
│ type        │    │ created_at │
│ model       │    │ last_      │
│ system_     │    │   active_at│
│   prompt    │    └─────┬──────┘
│ avatar_url  │          │
│ created_at  │          │ 1:N
│ updated_at  │          │
└──────┬──────┘          │
       │                 │
       │ 1:N             │
       │                 │
       │          ┌──────▼──────┐
       │          │   Event     │
       └──────────│─────────────│
                  │ id (PK)     │
                  │ session_id  │
                  │ user_id(FK) │
                  │ agent_id(FK)│
                  │ from_type   │
                  │ from_id     │
                  │ to_type     │
                  │ to_id       │
                  │ content     │
                  │ timestamp   │
                  └─────────────┘
```

---

## 8. 数据校验规则

### 8.1 User 数据校验

| 字段      | 校验规则                                           |
| --------- | -------------------------------------------------- |
| id        | 不能为空，长度 1-100 字符，必须唯一               |
| username  | 不能为空，长度 1-50 字符，必须唯一                |
| password  | 不能为空，长度至少 6 字符（V1 版本简化验证）     |
| created_at / updated_at | 必须是有效的时间戳（毫秒）                         |

### 8.2 Agent 数据校验

| 字段          | 校验规则                                           |
| ------------- | -------------------------------------------------- |
| id            | 不能为空，格式：`agent_*` 或 UUID                 |
| user_id       | 不能为空，长度 1-100 字符                         |
| name          | 不能为空，长度 1-50 字符，同一用户不能重复        |
| type          | 必须是 'general' 或 'special'                     |
| model         | 必须在支持的模型列表中                             |
| system_prompt | 可选，如果提供长度建议 10-5000 字符               |
| avatar_url    | 可选，如果提供必须是有效的 URL                    |
| created_at / updated_at | 必须是有效的时间戳（毫秒）                         |

### 8.3 Event 数据校验

| 字段      | 校验规则                                           |
| --------- | -------------------------------------------------- |
| id        | 不能为空，格式：`event_*` 或 UUID                 |
| session_id | 不能为空，格式：`session_*`                       |
| user_id   | 不能为空，必须与 session_id 中的 user_id 一致     |
| agent_id  | 不能为空，必须与 session_id 中的 agent_id 一致    |
| from_type | 必须是 'user' 或 'agent'                           |
| to_type   | 必须是 'user' 或 'agent'，且与 from_type 相反     |
| from_id   | 不能为空，如果 from_type='user' 则等于 user_id，否则等于 agent_id |
| to_id     | 不能为空，如果 to_type='user' 则等于 user_id，否则等于 agent_id |
| content   | 不能为空，长度 1-50000 字符                       |
| timestamp | 必须是有效的时间戳（毫秒）                         |

### 8.4 Session 数据校验

| 字段          | 校验规则                                           |
| ------------- | -------------------------------------------------- |
| id            | 不能为空，格式：`session_*` 或 UUID                |
| user_id       | 不能为空，长度 1-100 字符                         |
| agent_id      | 不能为空，长度 1-100 字符                          |
| created_at    | 必须是有效的时间戳（毫秒）                         |
| last_active_at | 必须是有效的时间戳（毫秒）                         |

---

## 9. 数据安全

### 9.1 数据加密

- **敏感数据**：
  - V1 版本：密码明文存储（简化实现，仅用于开发测试）
  - V1.5 版本：密码使用 bcrypt 哈希存储
- **传输加密**：使用 HTTPS 传输数据

### 9.2 数据隔离

- **用户数据隔离**：确保用户只能访问自己的数据
- **SQL 注入防护**：使用参数化查询，避免 SQL 注入

### 9.3 数据隐私

- **内容存储**：对话内容完整存储，不做修改
- **数据保留**：**永久保留用户数据，除非用户主动删除**（产品核心承诺）
- **数据删除**：用户删除数据时，物理删除或标记删除（根据合规要求）
- **数据备份**：定期备份数据，确保数据安全不丢失
- **数据迁移**：系统升级或迁移时，保证数据完整迁移

---

## 10. 相关文档

- [功能需求](./03-功能需求.md) - 功能需求详细说明
- [API设计](./04-API设计.md) - API 接口设计
- [系统架构](./06-系统架构.md) - 系统架构设计

---

**文档维护**：数据结构变更时，需同步更新本文档、API 文档和数据库迁移脚本。

