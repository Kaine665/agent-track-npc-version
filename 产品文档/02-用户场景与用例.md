# 02-用户场景与用例

**文档版本**：v1.0  
**最后更新**：2024-12-19  
**相关文档**：[产品概述](./01-产品概述.md) | [功能需求](./03-功能需求.md)

---

## 1. 用户场景总览

### 1.1 场景分类

| 场景编号 | 场景名称       | 优先级 | 相关功能 |
| -------- | -------------- | ------ | -------- |
| UC-001   | 创建 NPC       | P0     | F1       |
| UC-002   | 查看 NPC 列表  | P0     | F2       |
| UC-003   | 与 NPC 对话    | P0     | F5, F6   |
| UC-004   | 查看对话历史   | P0     | F6       |
| UC-005   | 编辑 NPC（V2） | P2     | F3       |
| UC-006   | 删除 NPC（V2） | P2     | F4       |

---

## 2. 详细用户场景

### 2.1 UC-001：创建 NPC

#### 2.1.1 场景描述

用户希望创建不同风格的 AI NPC，以满足不同场景的需求，如学习教练、心理导师、通用助手、情绪陪伴 AI 等。

#### 2.1.2 用户角色

- **主要角色**：普通用户
- **次要角色**：系统管理员（监控和管理）

#### 2.1.3 前置条件

- 用户已进入系统（V1 使用简单的 userId）
- 用户了解如何创建 NPC（通过界面引导或文档）

#### 2.1.4 主流程（Happy Path）

```
1. 用户进入 NPC 列表页面
2. 用户点击"创建新 NPC"按钮
3. 系统显示创建 NPC 表单页面
4. 用户填写 NPC 信息：
   - 输入 NPC 名称（如"学习教练"）
   - 选择 NPC 类型（通用/特定）
   - 输入人设描述（system prompt）
   - 选择使用的 LLM 模型
   - （可选）上传或输入头像 URL
5. 用户点击"创建"按钮
6. 系统验证表单数据
7. 系统创建 NPC 并保存到数据库
8. 系统返回成功响应
9. 系统跳转到 NPC 列表页面
10. 新创建的 NPC 显示在列表中
```

#### 2.1.5 备选流程

**备选流程 A：名称重复**

```
5. 用户点击"创建"按钮
6. 系统验证表单数据
7. 系统检测到名称已存在
8. 系统返回错误提示："该名称已存在，请使用其他名称"
9. 用户修改名称后重新提交
10. 继续主流程步骤 6
```

**备选流程 B：表单验证失败**

```
5. 用户点击"创建"按钮
6. 系统验证表单数据
7. 系统检测到必填字段为空或格式不正确
8. 系统在对应字段下方显示错误提示
9. 用户修正错误后重新提交
10. 继续主流程步骤 6
```

**备选流程 C：网络错误**

```
5. 用户点击"创建"按钮
6. 系统验证表单数据
7. 发送请求时网络中断
8. 系统显示错误提示："网络错误，请重试"
9. 用户点击"重试"按钮
10. 继续主流程步骤 5
```

#### 2.1.6 后置条件

- NPC 已成功创建并保存到数据库
- NPC 出现在用户的 NPC 列表中
- 用户可以立即使用该 NPC 进行对话

#### 2.1.7 业务规则

1. 同一用户的 NPC 名称不能重复（不区分大小写）
2. NPC 名称长度：1-50 字符
3. 人设描述长度：10-5000 字符
4. 只能选择系统支持的模型列表中的模型
5. 头像 URL 必须是有效的 URL 格式（如果提供）

#### 2.1.8 验收标准

- [ ] 用户能够成功创建 NPC
- [ ] 创建成功后 NPC 立即出现在列表中
- [ ] 名称重复时正确提示错误
- [ ] 表单验证规则正确执行
- [ ] 网络错误时能够重试
- [ ] 创建过程有明确的加载状态提示

---

### 2.2 UC-002：查看 NPC 列表

#### 2.2.1 场景描述

用户希望查看自己创建的所有 NPC，以便快速选择想要对话的 NPC。

#### 2.2.2 用户角色

- **主要角色**：普通用户

#### 2.2.3 前置条件

- 用户已进入系统
- 用户至少创建过一个 NPC（可选，空状态也需要处理）

#### 2.2.4 主流程

```
1. 用户进入 NPC 列表页面
2. 系统请求用户的所有 NPC 列表
3. 系统查询数据库获取 NPC 列表
4. 系统按最后对话时间倒序排列 NPC
5. 系统渲染 NPC 卡片列表
6. 用户查看 NPC 列表
7. 用户点击某个 NPC 卡片
8. 系统跳转到该 NPC 的对话页面
```

#### 2.2.5 备选流程

**备选流程 A：空列表**

```
1. 用户进入 NPC 列表页面
2. 系统请求用户的所有 NPC 列表
3. 系统查询数据库，发现用户没有创建任何 NPC
4. 系统显示空状态提示："创建你的第一个 NPC"
5. 系统显示"创建新 NPC"按钮
6. 用户点击"创建新 NPC"按钮
7. 系统跳转到创建 NPC 页面
```

**备选流程 B：加载失败**

```
1. 用户进入 NPC 列表页面
2. 系统请求用户的所有 NPC 列表
3. 请求失败（网络错误或服务器错误）
4. 系统显示错误提示："加载失败，请重试"
5. 系统显示"重试"按钮
6. 用户点击"重试"按钮
7. 继续主流程步骤 2
```

#### 2.2.6 后置条件

- NPC 列表已正确显示
- 用户可以点击 NPC 卡片进入对话页面

#### 2.2.7 业务规则

1. 列表按最后对话时间倒序排列（最近对话的在前）
2. 如果没有对话记录，按创建时间倒序排列
3. 每个 NPC 卡片显示：头像、名称、类型、最后对话时间
4. 空列表时显示友好的空状态提示

#### 2.2.8 验收标准

- [ ] 正确显示用户创建的所有 NPC
- [ ] 列表按最后对话时间正确排序
- [ ] 点击卡片能够跳转到对话页面
- [ ] 空状态正确显示
- [ ] 加载状态和错误状态正确处理

---

### 2.3 UC-003：与 NPC 对话

#### 2.3.1 场景描述

用户希望与选中的 NPC 进行对话，发送消息并收到 NPC 的回复。

#### 2.3.2 用户角色

- **主要角色**：普通用户

#### 2.3.3 前置条件

- 用户已选择某个 NPC
- 用户已进入对话页面
- 系统已加载对话历史（如果有）

#### 2.3.4 主流程

```
1. 用户在输入框输入消息
2. 用户点击"发送"按钮（或按 Enter）
3. 系统验证消息（不能为空，长度不超过 5000 字符）
4. 系统禁用发送按钮，显示加载状态
5. 系统发送 POST /api/messages 请求
6. 后端处理流程：
   a. 验证参数
   b. 写入用户发言事件
   c. 读取 NPC 配置
   d. 获取最近 N 条历史事件（上下文）
   e. 构建 LLM Prompt
   f. 调用 LLM API
   g. 写入 NPC 回复事件
   h. 返回回复内容
7. 系统接收响应
8. 系统在对话界面显示用户消息和 NPC 回复
9. 系统滚动到底部显示最新消息
10. 系统恢复发送按钮状态
```

#### 2.3.5 备选流程

**备选流程 A：消息为空**

```
2. 用户点击"发送"按钮（或按 Enter）
3. 系统验证消息，发现消息为空
4. 系统在输入框下方显示错误提示："消息不能为空"
5. 系统阻止发送
6. 用户输入消息后重新发送
7. 继续主流程步骤 3
```

**备选流程 B：消息过长**

```
2. 用户点击"发送"按钮（或按 Enter）
3. 系统验证消息，发现消息超过 5000 字符
4. 系统在输入框下方显示错误提示："消息过长，请缩短"
5. 系统阻止发送
6. 用户缩短消息后重新发送
7. 继续主流程步骤 3
```

**备选流程 C：LLM API 失败**

```
6. 后端处理流程：
   f. 调用 LLM API 失败（网络错误、API 错误等）
   g. 系统自动重试 2 次
   h. 重试后仍失败
7. 系统接收错误响应
8. 系统显示错误提示："AI 回复生成失败，请稍后重试"
9. 系统恢复发送按钮状态
10. 用户消息已保存，但 NPC 未回复
```

**备选流程 D：LLM API 超时**

```
6. 后端处理流程：
   f. 调用 LLM API 超时（超过 30 秒）
7. 系统接收超时错误响应
8. 系统显示错误提示："请求超时，请重试"
9. 系统恢复发送按钮状态
10. 用户可以选择重试发送
```

#### 2.3.6 后置条件

- 用户消息已保存到事件记录
- NPC 回复已保存到事件记录（如果成功）
- 对话界面已更新显示最新消息

#### 2.3.7 业务规则

1. 消息长度限制：1-5000 字符
2. 上下文窗口：默认获取最近 20 条事件
3. 重试机制：LLM API 失败时自动重试 2 次
4. 超时时间：LLM API 调用超时时间 30 秒
5. 并发控制：同一用户同一 NPC 的请求串行处理

#### 2.3.8 验收标准

- [ ] 用户能够成功发送消息并收到 NPC 回复
- [ ] 消息和回复都正确保存
- [ ] NPC 回复基于历史上下文生成
- [ ] 消息验证规则正确执行
- [ ] LLM API 失败时正确处理和提示
- [ ] 发送过程有明确的加载状态
- [ ] 响应时间在可接受范围内

---

### 2.4 UC-004：查看对话历史

#### 2.4.1 场景描述

用户希望查看与某个 NPC 的完整对话历史，以便回顾之前的对话内容。

#### 2.4.2 用户角色

- **主要角色**：普通用户

#### 2.4.3 前置条件

- 用户已选择某个 NPC
- 用户已进入对话页面
- 用户与该 NPC 有过对话记录（可选，空历史也需要处理）

#### 2.4.4 主流程

```
1. 用户进入对话页面
2. 系统自动请求对话历史
3. 系统发送 GET /api/history 请求
4. 后端查询事件记录
5. 后端返回事件列表（按时间升序）
6. 系统渲染对话历史：
   - 用户消息：左侧显示
   - NPC 消息：右侧显示
   - 按时间顺序排列
7. 用户查看对话历史
8. 用户滚动查看历史消息
```

#### 2.4.5 备选流程

**备选流程 A：空历史**

```
1. 用户进入对话页面
2. 系统自动请求对话历史
3. 系统发送 GET /api/history 请求
4. 后端查询事件记录，发现没有历史记录
5. 后端返回空数组
6. 系统显示空状态提示："开始你的第一次对话吧"
7. 用户输入消息开始对话
```

**备选流程 B：加载失败**

```
1. 用户进入对话页面
2. 系统自动请求对话历史
3. 请求失败（网络错误或服务器错误）
4. 系统显示错误提示："加载历史失败，请重试"
5. 系统显示"重试"按钮
6. 用户点击"重试"按钮
7. 继续主流程步骤 2
```

#### 2.4.6 后置条件

- 对话历史已正确显示
- 用户可以查看所有历史消息
- 用户可以继续发送新消息

#### 2.4.7 业务规则

1. 只显示当前用户与当前 NPC 的对话记录
2. 按时间升序排列（最早的在上面）
3. 空历史时显示友好的空状态提示
4. V1 返回所有历史记录（不限制数量）

#### 2.4.8 验收标准

- [ ] 正确显示用户与 NPC 的所有对话历史
- [ ] 历史记录按时间顺序正确排列
- [ ] 用户消息和 NPC 消息正确区分显示
- [ ] 空历史时正确显示空状态
- [ ] 加载失败时能够重试

---

## 3. 用户故事（User Stories）

### 3.1 用户故事列表

#### US-001：创建学习教练 NPC

**作为** 一个需要学习指导的学生  
**我希望** 能够创建一个"学习教练"类型的 NPC  
**以便于** 获得个性化的学习建议和计划

**验收标准**：

- 能够成功创建学习教练 NPC
- NPC 的人设符合学习教练的特点
- 创建后可以立即使用

#### US-002：创建心理导师 NPC

**作为** 一个需要情感支持的用户  
**我希望** 能够创建一个"心理导师"类型的 NPC  
**以便于** 获得心理疏导和情感陪伴

**验收标准**：

- 能够成功创建心理导师 NPC
- NPC 的回复风格温和、支持性
- 能够进行深度对话

#### US-003：快速切换 NPC

**作为** 一个创建了多个 NPC 的用户  
**我希望** 能够在 NPC 列表页面快速切换不同的 NPC  
**以便于** 根据不同需求与不同的 NPC 对话

**验收标准**：

- NPC 列表清晰展示所有 NPC
- 点击卡片能够快速跳转到对话页面
- 切换过程流畅无延迟

#### US-004：回顾历史对话

**作为** 一个与 NPC 有过多次对话的用户  
**我希望** 能够查看完整的对话历史  
**以便于** 回顾之前的对话内容和建议

**验收标准**：

- 能够查看所有历史对话
- 历史记录按时间顺序排列
- 能够快速定位到特定时间的对话

---

## 4. 用例图

```
┌─────────┐
│  用户   │
└────┬────┘
     │
     │ ┌─────────────────┐
     ├─│  创建 NPC       │
     │ └─────────────────┘
     │
     │ ┌─────────────────┐
     ├─│  查看 NPC 列表  │
     │ └─────────────────┘
     │
     │ ┌─────────────────┐
     ├─│  与 NPC 对话    │
     │ └─────────────────┘
     │
     │ ┌─────────────────┐
     └─│  查看对话历史   │
       └─────────────────┘

┌─────────┐
│  系统   │
└────┬────┘
     │
     │ ┌─────────────────┐
     ├─│  保存 NPC 配置 │
     │ └─────────────────┘
     │
     │ ┌─────────────────┐
     ├─│  记录对话事件  │
     │ └─────────────────┘
     │
     │ ┌─────────────────┐
     ├─│  调用 LLM API  │
     │ └─────────────────┘
     │
     │ ┌─────────────────┐
     └─│  查询对话历史  │
       └─────────────────┘
```

---

## 5. 场景流程图

### 5.1 创建 NPC 流程图

```
开始
  ↓
进入 NPC 列表页面
  ↓
点击"创建新 NPC"
  ↓
填写 NPC 信息表单
  ↓
点击"创建"按钮
  ↓
表单验证
  ├─ 通过 → 创建 NPC → 跳转到列表页面 → 结束
  └─ 失败 → 显示错误提示 → 用户修正 → 重新验证
```

### 5.2 对话流程图

```
开始
  ↓
进入对话页面
  ↓
加载对话历史
  ↓
用户在输入框输入消息
  ↓
点击"发送"按钮
  ↓
消息验证
  ├─ 通过 → 发送请求 → 调用 LLM API → 显示回复 → 结束
  └─ 失败 → 显示错误提示 → 用户修正 → 重新发送
```

---

## 6. 边界场景

### 6.1 极端情况

1. **用户创建大量 NPC**：单个用户创建 100+ 个 NPC

   - 处理：列表需要支持分页或虚拟滚动（V2 实现）

2. **对话历史非常长**：单个会话有 1000+ 条消息

   - 处理：加载时只加载最近的消息，支持滚动加载更多（V2 实现）

3. **消息内容非常长**：用户发送接近 5000 字符的消息

   - 处理：前端实时显示字符计数，接近限制时提示

4. **LLM API 响应非常慢**：响应时间超过 30 秒
   - 处理：设置超时时间，超时后提示用户重试

### 6.2 异常情况

1. **网络中断**：用户在操作过程中网络中断

   - 处理：显示网络错误提示，支持重试

2. **服务器错误**：后端服务异常

   - 处理：显示系统错误提示，记录错误日志

3. **数据不一致**：NPC 被删除但对话历史仍存在
   - 处理：V1 暂不实现删除功能，V2 实现时需处理数据一致性

---

## 7. 相关文档

- [产品概述](./01-产品概述.md) - 产品定义和目标
- [功能需求](./03-功能需求.md) - 详细功能需求说明
- [API 设计](./04-API设计.md) - API 接口设计

---

**文档维护**：用户场景变更时，需同步更新本文档和功能需求文档。
