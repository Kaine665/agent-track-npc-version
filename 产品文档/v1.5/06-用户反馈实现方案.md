# 用户反馈功能实现方案

**文档版本**：v1.0  
**最后更新**：2025-01-XX  
**相关文档**：[V1.5 版本规划](./README.md)

---

## 功能概述

允许用户提交反馈（Bug、功能建议、使用问题），帮助改进产品。

---

## 技术方案

### 实现步骤

#### 1. 数据模型

**文件**：`npc-backend/migrations/create_feedbacks_table.sql`

```sql
CREATE TABLE IF NOT EXISTS feedbacks (
  id VARCHAR(255) PRIMARY KEY COMMENT '反馈ID',
  userId VARCHAR(255) NOT NULL COMMENT '用户ID',
  type VARCHAR(50) NOT NULL COMMENT '反馈类型：bug, feature, question',
  title VARCHAR(500) NOT NULL COMMENT '反馈标题',
  content TEXT NOT NULL COMMENT '反馈内容',
  status VARCHAR(50) DEFAULT 'pending' COMMENT '状态：pending, resolved, closed',
  userAgent TEXT COMMENT '用户环境信息（浏览器、系统等）',
  screenshots TEXT COMMENT '截图URL（JSON数组）',
  createdAt BIGINT NOT NULL COMMENT '创建时间',
  updatedAt BIGINT COMMENT '更新时间',
  resolvedAt BIGINT COMMENT '解决时间',
  INDEX idx_userId (userId),
  INDEX idx_type (type),
  INDEX idx_status (status),
  INDEX idx_createdAt (createdAt)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='用户反馈表';
```

#### 2. Repository

**文件**：`npc-backend/repositories/FeedbackRepository.js`

```javascript
/**
 * ============================================
 * 反馈数据访问层 (FeedbackRepository.js)
 * ============================================
 */

const pool = require('../config/database').pool;

/**
 * 创建反馈
 */
async function create(feedbackData) {
  const {
    id,
    userId,
    type,
    title,
    content,
    userAgent,
    screenshots,
  } = feedbackData;

  const sql = `
    INSERT INTO feedbacks (
      id, userId, type, title, content, 
      status, userAgent, screenshots, createdAt
    ) VALUES (?, ?, ?, ?, ?, 'pending', ?, ?, ?)
  `;

  await pool.execute(sql, [
    id,
    userId,
    type,
    title,
    content,
    userAgent ? JSON.stringify(userAgent) : null,
    screenshots ? JSON.stringify(screenshots) : null,
    Date.now(),
  ]);

  return findById(id);
}

/**
 * 查询反馈
 */
async function findById(id) {
  const [rows] = await pool.execute(
    'SELECT * FROM feedbacks WHERE id = ?',
    [id]
  );
  return rows[0] || null;
}

/**
 * 查询用户的反馈列表
 */
async function findByUserId(userId, options = {}) {
  const { page = 1, pageSize = 20, type, status } = options;
  const offset = (page - 1) * pageSize;

  let sql = 'SELECT * FROM feedbacks WHERE userId = ?';
  const params = [userId];

  if (type) {
    sql += ' AND type = ?';
    params.push(type);
  }

  if (status) {
    sql += ' AND status = ?';
    params.push(status);
  }

  sql += ' ORDER BY createdAt DESC LIMIT ? OFFSET ?';
  params.push(pageSize, offset);

  const [rows] = await pool.execute(sql, params);
  return rows;
}

/**
 * 查询所有反馈（管理员）
 */
async function findAll(options = {}) {
  const { page = 1, pageSize = 20, type, status } = options;
  const offset = (page - 1) * pageSize;

  let sql = 'SELECT * FROM feedbacks WHERE 1=1';
  const params = [];

  if (type) {
    sql += ' AND type = ?';
    params.push(type);
  }

  if (status) {
    sql += ' AND status = ?';
    params.push(status);
  }

  sql += ' ORDER BY createdAt DESC LIMIT ? OFFSET ?';
  params.push(pageSize, offset);

  const [rows] = await pool.execute(sql, params);
  return rows;
}
```

#### 3. Service

**文件**：`npc-backend/services/FeedbackService.js`

```javascript
/**
 * ============================================
 * 反馈服务 (FeedbackService.js)
 * ============================================
 */

const feedbackRepository = require('../repositories/FeedbackRepository');
const { v4: uuidv4 } = require('uuid');

/**
 * 提交反馈
 */
async function submitFeedback(userId, feedbackData) {
  const {
    type,
    title,
    content,
    userAgent,
    screenshots,
  } = feedbackData;

  // 验证必填字段
  if (!type || !title || !content) {
    const error = new Error('反馈类型、标题和内容不能为空');
    error.code = 'VALIDATION_ERROR';
    throw error;
  }

  // 验证反馈类型
  const validTypes = ['bug', 'feature', 'question'];
  if (!validTypes.includes(type)) {
    const error = new Error('无效的反馈类型');
    error.code = 'INVALID_TYPE';
    throw error;
  }

  // 创建反馈
  const feedback = await feedbackRepository.create({
    id: `feedback_${uuidv4()}`,
    userId,
    type,
    title,
    content,
    userAgent,
    screenshots,
  });

  return feedback;
}

/**
 * 查询用户的反馈列表
 */
async function getUserFeedbacks(userId, options = {}) {
  return await feedbackRepository.findByUserId(userId, options);
}

/**
 * 查询反馈详情
 */
async function getFeedbackById(feedbackId, userId) {
  const feedback = await feedbackRepository.findById(feedbackId);
  
  if (!feedback) {
    const error = new Error('反馈不存在');
    error.code = 'FEEDBACK_NOT_FOUND';
    throw error;
  }

  // 验证权限（用户只能查看自己的反馈）
  if (feedback.userId !== userId) {
    const error = new Error('无权查看此反馈');
    error.code = 'PERMISSION_DENIED';
    throw error;
  }

  return feedback;
}
```

#### 4. 路由

**文件**：`npc-backend/routes/feedbacks.js`

```javascript
/**
 * ============================================
 * 反馈路由 (feedbacks.js)
 * ============================================
 */

const express = require('express');
const router = express.Router();
const feedbackService = require('../services/FeedbackService');
const { authenticate } = require('../middleware/auth');

router.use(authenticate);

/**
 * 提交反馈
 * POST /api/v1/feedbacks
 */
router.post('/', async (req, res) => {
  try {
    const userId = req.user.userId;
    const { type, title, content, screenshots } = req.body;

    // 自动获取用户环境信息
    const userAgent = {
      browser: req.headers['user-agent'],
      platform: req.headers['sec-ch-ua-platform'] || 'unknown',
      language: req.headers['accept-language'],
      referer: req.headers['referer'],
    };

    const feedback = await feedbackService.submitFeedback(userId, {
      type,
      title,
      content,
      screenshots,
      userAgent,
    });

    res.json({
      success: true,
      data: feedback,
      timestamp: Date.now(),
    });
  } catch (error) {
    const code = error.code || 'SYSTEM_ERROR';
    const status = 
      code === 'VALIDATION_ERROR' ? 400 :
      code === 'INVALID_TYPE' ? 400 : 500;
    
    res.status(status).json({
      success: false,
      error: {
        code,
        message: error.message,
      },
      timestamp: Date.now(),
    });
  }
});

/**
 * 查询用户的反馈列表
 * GET /api/v1/feedbacks?page=1&pageSize=20&type=bug&status=pending
 */
router.get('/', async (req, res) => {
  try {
    const userId = req.user.userId;
    const { page, pageSize, type, status } = req.query;

    const feedbacks = await feedbackService.getUserFeedbacks(userId, {
      page: parseInt(page) || 1,
      pageSize: parseInt(pageSize) || 20,
      type,
      status,
    });

    res.json({
      success: true,
      data: feedbacks,
      timestamp: Date.now(),
    });
  } catch (error) {
    res.status(500).json({
      success: false,
      error: {
        code: 'SYSTEM_ERROR',
        message: error.message,
      },
      timestamp: Date.now(),
    });
  }
});

/**
 * 查询反馈详情
 * GET /api/v1/feedbacks/:id
 */
router.get('/:id', async (req, res) => {
  try {
    const { id } = req.params;
    const userId = req.user.userId;

    const feedback = await feedbackService.getFeedbackById(id, userId);

    res.json({
      success: true,
      data: feedback,
      timestamp: Date.now(),
    });
  } catch (error) {
    const code = error.code || 'SYSTEM_ERROR';
    const status = 
      code === 'FEEDBACK_NOT_FOUND' ? 404 :
      code === 'PERMISSION_DENIED' ? 403 : 500;
    
    res.status(status).json({
      success: false,
      error: {
        code,
        message: error.message,
      },
      timestamp: Date.now(),
    });
  }
});

module.exports = router;
```

**文件**：`npc-backend/server.js`

```javascript
const feedbacksRouter = require('./routes/feedbacks');
app.use('/api/v1/feedbacks', feedbacksRouter);
```

---

## 前端适配

### 1. 反馈表单组件

**文件**：`npc-frontend/src/components/FeedbackModal/FeedbackModal.jsx`

```javascript
import React, { useState } from 'react';
import { Modal, Form, Input, Select, Upload, message } from 'antd';
import { BugOutlined, BulbOutlined, QuestionCircleOutlined } from '@ant-design/icons';
import api from '../../api';

const { Option } = Select;
const { TextArea } = Input;

const FeedbackModal = ({ visible, onCancel, onSuccess }) => {
  const [form] = Form.useForm();
  const [loading, setLoading] = useState(false);

  const handleSubmit = async () => {
    try {
      const values = await form.validateFields();
      setLoading(true);

      const response = await api.feedbacks.submit(values);
      if (response.success) {
        message.success('反馈提交成功，感谢您的反馈！');
        form.resetFields();
        onSuccess();
        onCancel();
      }
    } catch (error) {
      message.error(error.message || '提交失败');
    } finally {
      setLoading(false);
    }
  };

  return (
    <Modal
      title="提交反馈"
      visible={visible}
      onOk={handleSubmit}
      onCancel={onCancel}
      confirmLoading={loading}
      width={600}
    >
      <Form form={form} layout="vertical">
        <Form.Item
          name="type"
          label="反馈类型"
          rules={[{ required: true, message: '请选择反馈类型' }]}
        >
          <Select placeholder="请选择反馈类型">
            <Option value="bug">
              <BugOutlined /> Bug 报告
            </Option>
            <Option value="feature">
              <BulbOutlined /> 功能建议
            </Option>
            <Option value="question">
              <QuestionCircleOutlined /> 使用问题
            </Option>
          </Select>
        </Form.Item>

        <Form.Item
          name="title"
          label="标题"
          rules={[{ required: true, message: '请输入标题' }]}
        >
          <Input placeholder="简要描述问题或建议" />
        </Form.Item>

        <Form.Item
          name="content"
          label="详细描述"
          rules={[{ required: true, message: '请输入详细描述' }]}
        >
          <TextArea
            rows={6}
            placeholder="请详细描述问题、建议或使用场景..."
          />
        </Form.Item>

        <Form.Item name="screenshots" label="截图（可选）">
          <Upload
            listType="picture-card"
            maxCount={3}
            beforeUpload={() => false} // 阻止自动上传
          >
            + 上传
          </Upload>
        </Form.Item>
      </Form>
    </Modal>
  );
};
```

### 2. API 适配层

**文件**：`npc-frontend/src/api/adapter.js`

```javascript
feedbacks: {
  /**
   * 提交反馈
   */
  submit: async (data) => {
    return await api.post('/feedbacks', data);
  },

  /**
   * 查询反馈列表
   */
  list: async (options = {}) => {
    const params = new URLSearchParams(options);
    return await api.get(`/feedbacks?${params}`);
  },

  /**
   * 查询反馈详情
   */
  get: async (id) => {
    return await api.get(`/feedbacks/${id}`);
  },
}
```

### 3. 反馈入口

**文件**：`npc-frontend/src/components/Header/Header.jsx`

```javascript
import { Button } from 'antd';
import { MessageOutlined } from '@ant-design/icons';
import FeedbackModal from '../FeedbackModal/FeedbackModal';

const Header = () => {
  const [feedbackVisible, setFeedbackVisible] = useState(false);

  return (
    <div className="header">
      {/* ... 其他内容 */}
      <Button
        icon={<MessageOutlined />}
        onClick={() => setFeedbackVisible(true)}
      >
        反馈
      </Button>
      <FeedbackModal
        visible={feedbackVisible}
        onCancel={() => setFeedbackVisible(false)}
        onSuccess={() => {
          // 反馈提交成功后的处理
        }}
      />
    </div>
  );
};
```

---

## 测试要点

1. **提交反馈**：验证反馈是否正确提交
2. **反馈类型**：验证不同类型的反馈是否正确分类
3. **用户环境信息**：验证用户环境信息是否正确记录
4. **权限验证**：验证用户只能查看自己的反馈
5. **错误处理**：验证必填字段、无效类型等错误处理

---

## 注意事项

1. **截图上传**：
   - 当前版本可以暂不支持截图上传（简化实现）
   - 未来可以实现图片上传到云存储

2. **反馈处理**：
   - 当前版本只实现提交和查询
   - 未来可以实现管理员回复、状态更新等功能

3. **通知机制**（可选）：
   - 可以添加邮件通知（反馈提交后通知管理员）
   - 可以使用消息队列异步处理

4. **反馈分析**（可选）：
   - 可以添加反馈统计和分析功能
   - 帮助识别常见问题和功能需求

