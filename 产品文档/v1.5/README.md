# V1.5 版本规划

**文档版本**：v1.0  
**最后更新**：2025-01-XX  
**相关文档**：[V1 产品文档](../v1/README.md) | [未来版本规划](../未来版本规划.md)

---

## 版本概述

V1.5 版本是小范围测试版本，主要目标是**完善基础功能、增强安全性、提升用户体验**。本版本采用"简单实现、可扩展设计"的原则，在满足当前需求的同时，为后续版本预留扩展空间。

### 版本定位

- **目标用户**：小范围测试用户
- **核心原则**：简单实现 + 可扩展设计
- **技术策略**：最小开销、最大效果

---

## 功能清单

### P0 优先级（必须实现）

1. ✅ **密码功能**（bcrypt 加密）
2. ✅ **JWT Token 认证**
3. ✅ **API 限流**（简单版：内存存储）
4. ✅ **NPC 编辑和删除**
5. ✅ **对话搜索功能**（不做筛选）

### P1 优先级（强烈建议）

1. ✅ **用户反馈功能**
2. ✅ **数据导入导出功能**
3. ✅ **错误日志和监控**（简单版：winston + 文件）
4. ✅ **数据备份机制**（简单版：mysqldump）

---

## 详细功能规划

### 1. 密码功能（P0）

**功能描述**：
- 实现密码加密存储（bcrypt）
- 用户注册时密码加密
- 用户登录时密码验证
- 现有用户密码迁移策略

**技术实现**：
- 使用 `bcrypt` 库进行密码哈希
- 密码强度验证（可选，建议8位以上）
- 现有用户首次登录时强制设置密码

**实现方案**：
详见 [01-密码功能实现方案.md](./01-密码功能实现方案.md)

---

### 2. JWT Token 认证（P0）

**功能描述**：
- 实现 JWT Token 生成和验证
- Token 中间件验证
- Token 过期处理
- Token 刷新机制（可选，建议实现）

**技术实现**：
- 使用 `jsonwebtoken` 库
- Token 有效期：7天
- Refresh Token 机制（可选）

**实现方案**：
详见 [02-JWT认证实现方案.md](./02-JWT认证实现方案.md)

---

### 3. API 限流（P0）

**功能描述**：
- IP 级别限流（全局）
- 用户级别限流（依赖 JWT Token）
- LLM API 特殊限流（防止成本过高）

**技术实现**：
- 使用 `express-rate-limit`（内存存储）
- 设计接口抽象，便于后续切换 Redis
- 限流策略：1分钟窗口

**实现方案**：
详见 [03-API限流实现方案.md](./03-API限流实现方案.md)

---

### 4. NPC 编辑和删除（P0）

**功能描述**：
- 允许用户编辑 NPC 配置（名称、人设、模型等）
- 允许用户删除 NPC
- 删除时的数据清理策略（软删除或硬删除）

**技术实现**：
- PUT /api/v1/agents/:id API
- DELETE /api/v1/agents/:id API
- 数据清理逻辑（关联对话历史）

**实现方案**：
详见 [04-NPC编辑删除实现方案.md](./04-NPC编辑删除实现方案.md)

---

### 5. 对话搜索功能（P0）

**功能描述**：
- 支持搜索对话内容
- 支持关键词高亮显示
- 不做筛选功能（简化实现）

**技术实现**：
- 数据库全文搜索（MySQL FULLTEXT）
- 搜索 API 实现
- 前端搜索界面

**实现方案**：
详见 [05-对话搜索实现方案.md](./05-对话搜索实现方案.md)

---

### 6. 用户反馈功能（P1）

**功能描述**：
- 用户提交反馈（Bug、功能建议、使用问题）
- 反馈分类
- 自动附加用户环境信息

**技术实现**：
- 反馈表设计
- 反馈 API 实现
- 前端反馈表单

**实现方案**：
详见 [06-用户反馈实现方案.md](./06-用户反馈实现方案.md)

---

### 7. 数据导入导出功能（P1）

**功能描述**：
- 导出对话历史（JSON、TXT、Markdown 格式）
- 导出 NPC 配置
- 导入对话历史（包含 prompt、模型信息）
- 模型兼容性处理（如果模型不存在，提供替代方案）

**技术实现**：
- 导出服务实现
- 导入服务实现
- 文件生成和下载
- 模型映射配置

**实现方案**：
详见 [07-数据导入导出实现方案.md](./07-数据导入导出实现方案.md)

---

### 8. 错误日志和监控（P1）

**功能描述**：
- 结构化日志记录（winston）
- 错误追踪
- API 调用统计
- 日志文件管理

**技术实现**：
- 使用 `winston` 库
- JSON 格式日志（便于后续解析）
- 文件输出 + 控制台输出
- 日志轮转（可选）

**实现方案**：
详见 [08-错误日志监控实现方案.md](./08-错误日志监控实现方案.md)

---

### 9. 数据备份机制（P1）

**功能描述**：
- 定期数据备份（每日全量）
- 备份文件管理（保留7天）
- 备份验证
- 数据恢复工具（简单版）

**技术实现**：
- 使用 MySQL `mysqldump`
- Node.js 定时任务或 cron
- 备份文件自动清理

**实现方案**：
详见 [09-数据备份实现方案.md](./09-数据备份实现方案.md)

---

## 技术架构

### 新增依赖

```json
{
  "bcrypt": "^5.1.1",
  "jsonwebtoken": "^9.0.2",
  "express-rate-limit": "^7.1.5",
  "winston": "^3.11.0"
}
```

### 目录结构

```
npc-backend/
├── middleware/
│   ├── auth.js          # JWT 认证中间件
│   ├── rateLimiter.js   # API 限流中间件
│   └── logger.js        # 日志中间件
├── utils/
│   ├── logger.js        # Winston 日志工具
│   └── password.js      # 密码加密工具
├── services/
│   ├── FeedbackService.js    # 反馈服务
│   ├── ExportService.js      # 导出服务
│   └── ImportService.js      # 导入服务
├── scripts/
│   └── backup-database.js     # 备份脚本
└── logs/                      # 日志目录
```

---

## 开发计划

### 阶段一：安全与认证（1周）
- 密码功能
- JWT Token 认证
- API 限流

### 阶段二：数据管理（1周）
- NPC 编辑和删除
- 对话搜索功能

### 阶段三：用户体验（1周）
- 用户反馈功能
- 数据导入导出功能

### 阶段四：运维支持（3天）
- 错误日志和监控
- 数据备份机制

**总计**：约 3-4 周

---

## 扩展性设计

### API 限流
- 当前：内存存储（`express-rate-limit`）
- 未来：可替换为 Redis（`rate-limit-redis`），接口不变

### 日志系统
- 当前：文件 + 控制台（`winston`）
- 未来：可接入 ELK、Sentry、Grafana，日志格式已统一

### 数据备份
- 当前：mysqldump + 本地文件
- 未来：可接入云存储（OSS/S3），增量备份（binlog）

---

## 相关文档

- [V1 产品文档](../v1/README.md)
- [未来版本规划](../未来版本规划.md)
- [非功能需求](../08-非功能需求.md)

