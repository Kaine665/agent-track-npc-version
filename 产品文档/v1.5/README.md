# V1.5 版本规划

**文档版本**：v1.0  
**最后更新**：2025-01-XX  
**相关文档**：[V1 产品文档](../v1/README.md) | [未来版本规划](../未来版本规划.md)

---

## 版本概述

V1.5 版本是小范围测试版本，主要目标是**完善基础功能、增强安全性、提升用户体验**。本版本采用"简单实现、可扩展设计"的原则，在满足当前需求的同时，为后续版本预留扩展空间。

### 版本定位

- **目标用户**：小范围测试用户
- **核心原则**：简单实现 + 可扩展设计
- **技术策略**：最小开销、最大效果

---

## 功能清单

### P0 优先级（必须实现）

1. ✅ **密码功能**（bcrypt 加密）
2. ✅ **JWT Token 认证**
3. ✅ **API 限流**（简单版：内存存储）
4. ✅ **NPC 编辑和删除**
5. ✅ **对话搜索功能**（不做筛选）
6. ✅ **对话交互增强**（基础功能）
   - ✅ 一键复制整段回答
   - ✅ 复制代码块（单独复制按钮）
   - ✅ 复制单次AI回复（在每条AI消息下方）
   - ✅ 数据导出功能（文本、Word、Markdown格式）
   - ✅ 收起/展开回答（默认展开，收起时只显示2行）（2025-11-24）
   - ⏳ 重新生成回答
   - ⏳ 编辑问题并重新生成

### P1 优先级（强烈建议）

1. ✅ **用户反馈功能**
2. ✅ **数据导入导出功能**
3. ✅ **错误日志和监控**（简单版：winston + 文件）
4. ✅ **数据备份机制**（简单版：mysqldump）

---

## 详细功能规划

### 1. 密码功能（P0）✅ 已完成（简化版）

**功能描述**：
- ✅ 实现密码登录（账号密码双重匹配）
- ✅ 用户注册时密码可选（不填则默认123456）
- ✅ 用户登录时密码验证（必填）
- ✅ 忘记密码功能（重置密码）
- ✅ 现有用户密码迁移（为无密码用户设置默认密码）

**技术实现**：
- 简化实现：密码明文存储，不使用 bcrypt 加密
- 不使用 JWT Token，采用简单密码验证
- 默认密码：123456

**实现方案**：
详见 [01-密码功能实现方案.md](./01-密码功能实现方案.md)

**完成时间**：2025-11-24

---

### 2. JWT Token 认证（P0）✅ 已完成

**功能描述**：
- ✅ 实现 JWT Token 生成和验证
- ✅ Token 中间件验证
- ✅ Token 过期处理
- ✅ Refresh Token 机制（已实现但未使用）

**当前状态**：
- ✅ JWT Token认证已完整实现
- ✅ 所有受保护的路由已添加认证中间件
- ✅ 前端自动携带Token，Token过期自动处理

**技术实现**：
- ✅ 使用 `jsonwebtoken` 库
- ✅ Token 有效期：7天（Access Token）
- ✅ Refresh Token 有效期：30天（已实现但未使用）
- ✅ Token存储在localStorage，请求时自动携带

**实现位置**：
- 后端：`npc-backend/utils/jwt.js`、`npc-backend/middleware/auth.js`
- 前端：`npc-frontend/src/api/httpAdapter.js`、`npc-frontend/src/context/AuthContext.jsx`

**完成时间**：2025-11-24

**未来优化方向**：
- Token刷新机制（自动刷新Access Token）
- Token黑名单机制（支持主动注销）
- httpOnly Cookie存储（更安全，防止XSS）
- Token轮换机制（每次刷新都生成新的Refresh Token）

**详细改进方案**：详见 [未来版本规划](../未来版本规划.md#2210-jwt-认证优化方案未来)

---

### 3. API 限流（P0）⏳ 未实现

**功能描述**：
- ⏳ IP 级别限流（全局）（未实现）
- ⏳ 用户级别限流（依赖 JWT Token）（未实现）
- ⏳ LLM API 特殊限流（防止成本过高）（未实现）

**当前状态**：
- 当前未实现任何限流机制
- 所有API接口无限制访问

**技术实现**：
- ⏳ 使用 `express-rate-limit`（未安装）
- ⏳ 设计接口抽象，便于后续切换 Redis（未实现）
- ⏳ 限流策略：1分钟窗口（未实现）

**实现方案**：
详见 [03-API限流实现方案.md](./03-API限流实现方案.md)（完整方案文档，待实现）

---

### 4. NPC 编辑和删除（P0）⏳ 未实现

**功能描述**：
- ⏳ 允许用户编辑 NPC 配置（名称、人设、模型等）（未实现）
- ⏳ 允许用户删除 NPC（未实现）
- ⏳ 删除时的数据清理策略（软删除或硬删除）（未实现）

**当前状态**：
- 当前仅支持创建和查询NPC，不支持编辑和删除
- `routes/agents.js` 中只有 POST 和 GET 路由，没有 PUT 和 DELETE

**技术实现**：
- ⏳ PUT /api/v1/agents/:id API（未实现）
- ⏳ DELETE /api/v1/agents/:id API（未实现）
- ⏳ 数据清理逻辑（关联对话历史）（未实现）

**实现方案**：
详见 [04-NPC编辑删除实现方案.md](./04-NPC编辑删除实现方案.md)（完整方案文档，待实现）

---

### 5. 对话搜索功能（P0）⏳ 未实现

**功能描述**：
- ⏳ 支持搜索对话内容（未实现）
- ⏳ 支持关键词高亮显示（未实现）
- ⏳ 不做筛选功能（简化实现）（未实现）

**当前状态**：
- 当前不支持搜索对话内容
- 没有搜索相关的路由和服务

**技术实现**：
- ⏳ 数据库全文搜索（MySQL FULLTEXT）（未实现）
- ⏳ 搜索 API 实现（未实现）
- ⏳ 前端搜索界面（未实现）

**实现方案**：
详见 [05-对话搜索实现方案.md](./05-对话搜索实现方案.md)（完整方案文档，待实现）

---

### 6. 对话交互增强（P0）✅ 部分完成

**功能描述**：
- ✅ **一键复制整段回答**：快速复制AI生成的整段回答内容，提升使用效率
- ✅ **复制代码块**：代码块提供单独的复制按钮，方便单独复制代码
- ✅ **复制单次AI回复**：在每条AI消息下方添加复制按钮，支持复制单条消息内容
- ✅ **数据导出功能**：支持导出对话记录为文本、Word、Markdown格式
- ✅ **收起/展开回答**：长回答默认展开，超过2行时自动显示收起/展开按钮，可以收起只显示前2行，提升浏览体验（2025-11-24）
- ⏳ **重新生成回答**：用户对当前回答不满意时，可以重新生成回答
- ⏳ **编辑问题**：用户可以修改已发送的提问，自动重新生成回答

**核心价值**：
- **提升使用效率**：快速复制整段回答，减少手动操作
- **改善用户体验**：重新生成、编辑问题等功能让用户更容易获得满意的回答
- **优化长内容浏览**：收起/展开功能让用户更好地浏览长回答
- **数据管理**：导出功能让用户可以保存和管理对话记录

**技术实现**：
- 前端：使用 Clipboard API 实现复制功能
- 前端：使用 `docx`、`file-saver` 等库实现导出功能
- 前端：复用现有消息发送API实现重新生成和编辑
- 无需后端改动（纯前端功能）

**已完成功能**：
- ✅ 复制单次AI回复（2025-01-24）
- ✅ 数据导出功能（2025-11-24）：支持文本、Word、Markdown格式
- ✅ 收起/展开回答（2025-11-24）：AI回复超过2行时自动显示收起/展开按钮，使用CSS line-clamp实现2行限制，添加平滑过渡动画

**实现方案**：
详见 [11-对话交互增强实现方案.md](./11-对话交互增强实现方案.md)

---

### 7. 用户反馈功能（P1）✅ 已完成

**功能描述**：
- ✅ 用户提交反馈（Bug、功能建议、使用问题）
- ✅ 反馈分类（bug, feature, question）
- ✅ 自动附加用户环境信息（浏览器、平台、语言、referer）
- ✅ 历史反馈查看（用户可查看自己的反馈列表）
- ✅ 反馈状态管理（pending, resolved, closed）

**当前状态**：
- ✅ 反馈功能已完整实现
- ✅ 数据库表、Repository、Service、路由均已实现
- ✅ 前端反馈页面和历史反馈列表已实现

**技术实现**：
- ✅ 反馈表设计（`migrations/004_create_feedbacks_table.sql`）
- ✅ 反馈 API 实现（`routes/feedbacks.js`）
- ✅ 前端反馈表单（`pages/Feedback/Feedback.jsx`）

**完成时间**：2025-01-XX

**未来优化方向**：
- 截图上传功能（数据库字段已预留，前端待实现）
- 管理员功能（查看所有反馈、更新状态、回复反馈）
- JWT认证集成（待JWT认证实现后添加认证中间件）
- 通知机制（邮件通知、消息队列）
- 反馈分析和统计功能

**详细改进方案**：详见 [未来版本规划](../未来版本规划.md#101-反馈渠道--v15)

---

### 8. 数据导入导出功能（P1）✅ 部分完成（导出已实现）

**功能描述**：
- ✅ 导出对话历史（文本、Word、Markdown 格式）
- ⏳ 导出 NPC 配置（未实现）
- ⏳ 导入对话历史（未实现）
- ⏳ 模型兼容性处理（未实现）

**技术实现**：
- ✅ 导出服务实现（前端实现，支持文本、Word、Markdown）
- ⏳ 导入服务实现（未实现）
- ✅ 文件生成和下载（已实现）

**实现位置**：
- `npc-frontend/src/utils/export/`（导出功能）
- `npc-frontend/src/pages/Chat/Chat.jsx`（导出按钮）

**实现方案**：
详见 [07-数据导入导出实现方案.md](./07-数据导入导出实现方案.md)（文档包含完整方案，当前仅实现导出功能）

---

### 9. 错误日志和监控（P1）✅ 部分完成（简化版）

**功能描述**：
- ✅ 基础日志记录（console.log，简化版）
- ✅ 错误追踪（已集成到错误处理中间件）
- ⏳ API 调用统计（未实现）
- ⏳ 日志文件管理（未实现）

**技术实现**：
- ✅ 当前：使用 console.log/console.error（简化版）
- ⏳ 未来：可升级为 winston（JSON格式、文件输出、日志轮转）

**实现方案**：
详见 [08-错误日志监控实现方案.md](./08-错误日志监控实现方案.md)（文档包含完整方案，当前实现为简化版）

---

### 10. 数据备份机制（P1）⏳ 未实现

**功能描述**：
- ⏳ 定期数据备份（每日全量）（未实现）
- ⏳ 备份文件管理（保留7天）（未实现）
- ⏳ 备份验证（未实现）
- ⏳ 数据恢复工具（简单版）（未实现）

**当前状态**：
- 当前未实现自动备份机制
- 需要手动使用 mysqldump 进行备份

**技术实现**：
- ⏳ 使用 MySQL `mysqldump`（未实现自动化）
- ⏳ Node.js 定时任务或 cron（未实现）
- ⏳ 备份文件自动清理（未实现）

**实现方案**：
详见 [09-数据备份实现方案.md](./09-数据备份实现方案.md)（完整方案文档，待实现）

---

### 11. 数据持久化风险分析（核心功能）

**功能描述**：
- 分析数据持久化承诺的实现现状和潜在风险
- 识别数据丢失的主要风险点
- 提供风险缓解措施和改进建议

**重要性**：
- 这是产品的**核心功能**之一
- 关系到"永久保留用户数据"承诺的履行
- 需要持续关注和改进

**风险分析**：
- 备份策略风险（最严重）：备份保留期短、无异地备份
- 数据库故障风险：硬盘故障、数据库损坏
- 人为操作风险：误删除、恶意操作
- 单点故障风险：无主从复制、无异地备份

**改进建议**：
- 短期：延长备份保留期、实现异地备份、备份监控告警
- 中期：实现主从复制、增量备份、数据完整性校验
- 长期：多地域备份、数据版本控制、自动化灾难恢复

**详细分析**：
详见 [10-数据持久化风险分析.md](./10-数据持久化风险分析.md)

---

## 技术架构

### 新增依赖

```json
{
  "bcrypt": "^5.1.1",
  "jsonwebtoken": "^9.0.2",
  "express-rate-limit": "^7.1.5",
  "winston": "^3.11.0"
}
```

### 目录结构

```
npc-backend/
├── middleware/
│   ├── auth.js          # JWT 认证中间件
│   ├── rateLimiter.js   # API 限流中间件
│   └── logger.js        # 日志中间件
├── utils/
│   ├── logger.js        # Winston 日志工具
│   └── password.js      # 密码加密工具
├── services/
│   ├── FeedbackService.js    # 反馈服务
│   ├── ExportService.js      # 导出服务
│   └── ImportService.js      # 导入服务
├── scripts/
│   └── backup-database.js     # 备份脚本
└── logs/                      # 日志目录
```

---

## 开发计划

### 阶段一：安全与认证（1周）
- 密码功能
- JWT Token 认证
- API 限流

### 阶段二：数据管理（1周）
- NPC 编辑和删除
- 对话搜索功能

### 阶段三：对话交互增强（4-6天）
- ✅ 一键复制整段回答（已完成）
- ✅ 复制代码块（已完成）
- ✅ 收起/展开回答（已完成，2025-11-24）
- ⏳ 重新生成回答（待实现）
- ⏳ 编辑问题并重新生成（待实现）

### 阶段四：用户体验（1周）
- 用户反馈功能
- 数据导入导出功能

### 阶段四：运维支持（3天）
- 错误日志和监控
- 数据备份机制

**总计**：约 4-5 周

---

## 扩展性设计

### API 限流
- 当前：内存存储（`express-rate-limit`）
- 未来：可替换为 Redis（`rate-limit-redis`），接口不变

### 日志系统
- 当前：文件 + 控制台（`winston`）
- 未来：可接入 ELK、Sentry、Grafana，日志格式已统一

### 数据备份
- 当前：mysqldump + 本地文件
- 未来：可接入云存储（OSS/S3），增量备份（binlog）

---

## 相关文档

- [V1 产品文档](../v1/README.md)
- [未来版本规划](../未来版本规划.md)
- [非功能需求](../08-非功能需求.md)

