# 密码功能实现方案

**文档版本**：v1.1  
**最后更新**：2025-11-24  
**相关文档**：[V1.5 版本规划](./README.md)

---

## ⚠️ 实际实现说明

**当前实现版本**：简化版（v1.1，2025-11-24）

根据实际需求，当前实现的是**简化版密码功能**，不使用 bcrypt 加密和 JWT Token，采用简单的账号密码双重匹配验证。

### 实际实现内容

1. **密码登录**：
   - 登录时密码必填
   - 账号和密码必须同时匹配才能登录
   - 密码明文存储（简化实现）

2. **密码注册**：
   - 注册时密码可选
   - 如果密码为空，自动设置为默认密码 `123456`

3. **忘记密码功能**：
   - 用户可以通过账号重置密码
   - 如果账号不存在，提示"账号不存在"
   - 重置后使用新密码登录

4. **数据库迁移**：
   - 为数据库中密码为空或 NULL 的用户设置默认密码 `123456`
   - 迁移脚本：`migrations/003_set_default_password.sql`
   - 执行脚本：`scripts/set-default-password.js`

### 未来升级计划

后续版本可以升级为使用 bcrypt 加密的完整方案（见下方完整方案文档）。

---

## 功能概述（完整方案）

实现用户密码的加密存储和验证，提升系统安全性。

**注意**：下方文档描述的是使用 bcrypt 加密的完整方案，当前版本未实现，仅供参考。

---

## 技术方案

### 依赖库

```json
{
  "bcrypt": "^5.1.1"
}
```

### 实现步骤

#### 1. 密码工具类

**文件**：`npc-backend/utils/password.js`

```javascript
/**
 * ============================================
 * 密码工具 (password.js)
 * ============================================
 *
 * 【文件职责】
 * 提供密码加密和验证功能
 *
 * 【主要功能】
 * 1. 密码加密（bcrypt）
 * 2. 密码验证
 * 3. 密码强度检查（可选）
 */

const bcrypt = require('bcrypt');

const SALT_ROUNDS = 10; // bcrypt 加密轮数

/**
 * 加密密码
 *
 * @param {string} plainPassword - 明文密码
 * @returns {Promise<string>} 加密后的密码哈希
 */
async function hashPassword(plainPassword) {
  if (!plainPassword || plainPassword.length < 8) {
    throw new Error('密码长度至少8位');
  }
  return await bcrypt.hash(plainPassword, SALT_ROUNDS);
}

/**
 * 验证密码
 *
 * @param {string} plainPassword - 明文密码
 * @param {string} hashedPassword - 加密后的密码哈希
 * @returns {Promise<boolean>} 是否匹配
 */
async function verifyPassword(plainPassword, hashedPassword) {
  if (!plainPassword || !hashedPassword) {
    return false;
  }
  return await bcrypt.compare(plainPassword, hashedPassword);
}

/**
 * 检查密码强度（可选）
 *
 * @param {string} password - 密码
 * @returns {Object} { valid: boolean, message: string }
 */
function checkPasswordStrength(password) {
  if (!password || password.length < 8) {
    return { valid: false, message: '密码长度至少8位' };
  }
  // 可以添加更多规则：包含字母、数字等
  return { valid: true, message: '密码强度符合要求' };
}

module.exports = {
  hashPassword,
  verifyPassword,
  checkPasswordStrength,
};
```

#### 2. 更新用户注册逻辑

**文件**：`npc-backend/services/UserService.js`

```javascript
const { hashPassword, checkPasswordStrength } = require('../utils/password');

/**
 * 用户注册
 */
async function register(userData) {
  const { userId, username, password } = userData;

  // 检查密码强度
  const strengthCheck = checkPasswordStrength(password);
  if (!strengthCheck.valid) {
    const error = new Error(strengthCheck.message);
    error.code = 'INVALID_PASSWORD';
    throw error;
  }

  // 加密密码
  const hashedPassword = await hashPassword(password);

  // 创建用户（密码已加密）
  const newUser = await userRepository.create({
    id: userId,
    username,
    password: hashedPassword, // 存储加密后的密码
    createdAt: Date.now(),
  });

  // 返回用户信息（不含密码）
  const { password: _, ...userInfo } = newUser;
  return userInfo;
}
```

#### 3. 更新用户登录逻辑

**文件**：`npc-backend/services/UserService.js`

```javascript
const { verifyPassword } = require('../utils/password');

/**
 * 用户登录
 */
async function login(userId, password) {
  const user = await userRepository.findById(userId);
  
  if (!user) {
    const error = new Error('用户不存在');
    error.code = 'USER_NOT_FOUND';
    throw error;
  }

  // 检查用户是否有密码
  if (!user.password) {
    // 现有用户首次登录，需要设置密码
    const error = new Error('请先设置密码');
    error.code = 'PASSWORD_REQUIRED';
    throw error;
  }

  // 验证密码
  const isValid = await verifyPassword(password, user.password);
  if (!isValid) {
    const error = new Error('密码错误');
    error.code = 'INVALID_PASSWORD';
    throw error;
  }

  // 返回用户信息（不含密码）
  const { password: _, ...userInfo } = user;
  return userInfo;
}
```

#### 4. 添加设置密码接口

**文件**：`npc-backend/routes/users.js`

```javascript
/**
 * 设置密码（用于现有用户首次设置密码）
 */
router.post('/set-password', async (req, res) => {
  try {
    const { userId, password } = req.body;
    
    if (!userId || !password) {
      return sendErrorResponse(res, 400, 'VALIDATION_ERROR', 'User ID and password are required');
    }

    const result = await userService.setPassword(userId, password);
    sendSuccessResponse(res, 200, result);
  } catch (error) {
    const code = error.code || 'SYSTEM_ERROR';
    const status = code === 'USER_NOT_FOUND' ? 404 : (code === 'INVALID_PASSWORD' ? 400 : 500);
    sendErrorResponse(res, status, code, error.message);
  }
});
```

**文件**：`npc-backend/services/UserService.js`

```javascript
/**
 * 设置密码（用于现有用户）
 */
async function setPassword(userId, password) {
  const user = await userRepository.findById(userId);
  
  if (!user) {
    const error = new Error('用户不存在');
    error.code = 'USER_NOT_FOUND';
    throw error;
  }

  // 检查密码强度
  const strengthCheck = checkPasswordStrength(password);
  if (!strengthCheck.valid) {
    const error = new Error(strengthCheck.message);
    error.code = 'INVALID_PASSWORD';
    throw error;
  }

  // 加密密码
  const hashedPassword = await hashPassword(password);

  // 更新用户密码
  await userRepository.update(userId, { password: hashedPassword });

  return { success: true, message: '密码设置成功' };
}
```

#### 5. 数据库迁移

**文件**：`npc-backend/migrations/add_password_to_users.sql`

```sql
-- 为现有用户表添加密码字段（如果还没有）
ALTER TABLE users 
ADD COLUMN IF NOT EXISTS password VARCHAR(255) NULL COMMENT '密码哈希（bcrypt）';

-- 注意：现有用户的 password 字段为 NULL，表示未设置密码
-- 首次登录时会提示设置密码
```

---

## 前端适配

### 1. 注册页面

**文件**：`npc-frontend/src/pages/Register/Register.jsx`

- 添加密码输入框
- 密码强度提示
- 密码确认输入框

### 2. 登录页面

**文件**：`npc-frontend/src/components/LoginModal/LoginModal.jsx`

- 添加密码输入框
- 处理"需要设置密码"的情况
- 显示设置密码提示

### 3. 设置密码页面（可选）

**文件**：`npc-frontend/src/pages/SetPassword/SetPassword.jsx`

- 用于现有用户首次设置密码
- 密码强度检查
- 密码确认

---

## 测试要点

1. **密码加密**：验证密码是否正确加密存储
2. **密码验证**：验证登录时密码验证是否正确
3. **密码强度**：验证密码强度检查是否生效
4. **现有用户**：验证现有用户（无密码）的处理流程
5. **错误处理**：验证密码错误时的错误提示

---

## 注意事项

1. **现有用户迁移**：
   - 现有用户的 `password` 字段为 `NULL`
   - 首次登录时提示设置密码
   - 或者允许无密码用户继续使用（但限制功能）

2. **密码安全**：
   - 密码永远不返回给前端
   - 密码错误不透露具体原因（防止用户枚举）
   - 使用 bcrypt 的默认轮数（10）即可

3. **性能考虑**：
   - bcrypt 是异步操作，注意错误处理
   - 密码验证可能较慢，考虑添加加载状态

