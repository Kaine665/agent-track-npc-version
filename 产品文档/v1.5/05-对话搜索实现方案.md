# 对话搜索功能实现方案

**文档版本**：v1.0  
**最后更新**：2025-01-XX  
**相关文档**：[V1.5 版本规划](./README.md)

---

## 功能概述

实现对话内容的搜索功能，支持关键词搜索和结果高亮显示。本版本不做筛选功能（简化实现）。

---

## 技术方案

### 实现策略

- **搜索方式**：MySQL 全文搜索（FULLTEXT）
- **搜索范围**：对话内容（events 表的 content 字段）
- **简化实现**：不做时间范围、类型等筛选功能

---

## 实现步骤

#### 1. 数据库索引

**文件**：`npc-backend/migrations/add_fulltext_index_to_events.sql`

```sql
-- 为 events 表的 content 字段添加全文索引
-- 注意：MySQL 5.7+ 支持中文全文搜索（需要配置 ngram）

-- 如果表已存在，添加全文索引
ALTER TABLE events 
ADD FULLTEXT INDEX idx_content_fulltext (content) 
WITH PARSER ngram; -- 支持中文分词

-- 或者创建表时就添加（如果重新创建表）
-- CREATE TABLE events (
--   ...
--   content TEXT NOT NULL,
--   FULLTEXT INDEX idx_content_fulltext (content) WITH PARSER ngram
-- );
```

**注意**：如果 MySQL 版本不支持 ngram，可以使用 `LIKE` 查询（性能较差，但兼容性好）。

#### 2. 搜索服务

**文件**：`npc-backend/services/SearchService.js`

```javascript
/**
 * ============================================
 * 搜索服务 (SearchService.js)
 * ============================================
 *
 * 【文件职责】
 * 提供对话内容搜索功能
 *
 * 【主要功能】
 * 1. 全文搜索对话内容
 * 2. 搜索结果高亮
 * 3. 分页支持
 */

const eventRepository = require('../repositories/EventRepository');
const pool = require('../config/database').pool;

/**
 * 搜索对话内容
 *
 * @param {string} userId - 用户 ID
 * @param {string} keyword - 搜索关键词
 * @param {Object} options - 搜索选项
 * @param {number} options.page - 页码（默认 1）
 * @param {number} options.pageSize - 每页数量（默认 20）
 * @param {string} options.agentId - NPC ID（可选，限制搜索范围）
 * @returns {Promise<Object>} 搜索结果
 */
async function searchConversations(userId, keyword, options = {}) {
  const { page = 1, pageSize = 20, agentId } = options;
  const offset = (page - 1) * pageSize;

  if (!keyword || keyword.trim().length === 0) {
    return {
      results: [],
      total: 0,
      page,
      pageSize,
    };
  }

  // 构建 SQL 查询
  let sql = `
    SELECT 
      e.id,
      e.sessionId,
      e.agentId,
      e.type,
      e.content,
      e.createdAt,
      a.name as agentName
    FROM events e
    LEFT JOIN agents a ON e.agentId = a.id
    WHERE e.userId = ?
    AND e.type IN ('user_message', 'agent_message')
    AND MATCH(e.content) AGAINST(? IN NATURAL LANGUAGE MODE)
  `;

  const params = [userId, keyword];

  // 如果指定了 agentId，添加过滤条件
  if (agentId) {
    sql += ` AND e.agentId = ?`;
    params.push(agentId);
  }

  // 添加排序和分页
  sql += ` ORDER BY e.createdAt DESC LIMIT ? OFFSET ?`;
  params.push(pageSize, offset);

  // 执行查询
  const [rows] = await pool.execute(sql, params);

  // 查询总数
  let countSql = `
    SELECT COUNT(*) as total
    FROM events e
    WHERE e.userId = ?
    AND e.type IN ('user_message', 'agent_message')
    AND MATCH(e.content) AGAINST(? IN NATURAL LANGUAGE MODE)
  `;
  const countParams = [userId, keyword];

  if (agentId) {
    countSql += ` AND e.agentId = ?`;
    countParams.push(agentId);
  }

  const [countRows] = await pool.execute(countSql, countParams);
  const total = countRows[0].total;

  // 高亮关键词（简单实现）
  const highlightedResults = rows.map(event => ({
    ...event,
    highlightedContent: highlightKeyword(event.content, keyword),
  }));

  return {
    results: highlightedResults,
    total,
    page,
    pageSize,
    totalPages: Math.ceil(total / pageSize),
  };
}

/**
 * 高亮关键词（简单实现）
 *
 * @param {string} text - 文本内容
 * @param {string} keyword - 关键词
 * @returns {string} 高亮后的 HTML
 */
function highlightKeyword(text, keyword) {
  if (!text || !keyword) {
    return text;
  }

  // 简单的字符串替换（区分大小写）
  const regex = new RegExp(`(${keyword})`, 'gi');
  return text.replace(regex, '<mark>$1</mark>');
}

/**
 * 如果 MySQL 不支持全文索引，使用 LIKE 查询（兼容方案）
 *
 * @param {string} userId - 用户 ID
 * @param {string} keyword - 搜索关键词
 * @param {Object} options - 搜索选项
 * @returns {Promise<Object>} 搜索结果
 */
async function searchConversationsLike(userId, keyword, options = {}) {
  const { page = 1, pageSize = 20, agentId } = options;
  const offset = (page - 1) * pageSize;

  let sql = `
    SELECT 
      e.id,
      e.sessionId,
      e.agentId,
      e.type,
      e.content,
      e.createdAt,
      a.name as agentName
    FROM events e
    LEFT JOIN agents a ON e.agentId = a.id
    WHERE e.userId = ?
    AND e.type IN ('user_message', 'agent_message')
    AND e.content LIKE ?
  `;

  const searchKeyword = `%${keyword}%`;
  const params = [userId, searchKeyword];

  if (agentId) {
    sql += ` AND e.agentId = ?`;
    params.push(agentId);
  }

  sql += ` ORDER BY e.createdAt DESC LIMIT ? OFFSET ?`;
  params.push(pageSize, offset);

  const [rows] = await pool.execute(sql, params);

  // 查询总数
  let countSql = `
    SELECT COUNT(*) as total
    FROM events e
    WHERE e.userId = ?
    AND e.type IN ('user_message', 'agent_message')
    AND e.content LIKE ?
  `;
  const countParams = [userId, searchKeyword];

  if (agentId) {
    countSql += ` AND e.agentId = ?`;
    countParams.push(agentId);
  }

  const [countRows] = await pool.execute(countSql, countParams);
  const total = countRows[0].total;

  const highlightedResults = rows.map(event => ({
    ...event,
    highlightedContent: highlightKeyword(event.content, keyword),
  }));

  return {
    results: highlightedResults,
    total,
    page,
    pageSize,
    totalPages: Math.ceil(total / pageSize),
  };
}

module.exports = {
  searchConversations,
  searchConversationsLike, // 兼容方案
};
```

#### 3. 搜索路由

**文件**：`npc-backend/routes/search.js`

```javascript
/**
 * ============================================
 * 搜索路由 (search.js)
 * ============================================
 */

const express = require('express');
const router = express.Router();
const searchService = require('../services/SearchService');
const { authenticate } = require('../middleware/auth');

// 所有搜索接口都需要认证
router.use(authenticate);

/**
 * 搜索对话
 * GET /api/v1/search/conversations?keyword=xxx&page=1&pageSize=20&agentId=xxx
 */
router.get('/conversations', async (req, res) => {
  try {
    const { keyword, page, pageSize, agentId } = req.query;
    const userId = req.user.userId;

    if (!keyword) {
      return res.status(400).json({
        success: false,
        error: {
          code: 'VALIDATION_ERROR',
          message: '搜索关键词不能为空',
        },
        timestamp: Date.now(),
      });
    }

    // 尝试使用全文搜索，如果失败则使用 LIKE
    let result;
    try {
      result = await searchService.searchConversations(userId, keyword, {
        page: parseInt(page) || 1,
        pageSize: parseInt(pageSize) || 20,
        agentId,
      });
    } catch (error) {
      // 如果全文搜索失败（可能不支持），使用 LIKE 查询
      console.warn('Fulltext search failed, falling back to LIKE:', error.message);
      result = await searchService.searchConversationsLike(userId, keyword, {
        page: parseInt(page) || 1,
        pageSize: parseInt(pageSize) || 20,
        agentId,
      });
    }

    res.json({
      success: true,
      data: result,
      timestamp: Date.now(),
    });
  } catch (error) {
    console.error('Search error:', error);
    res.status(500).json({
      success: false,
      error: {
        code: 'SYSTEM_ERROR',
        message: '搜索失败',
      },
      timestamp: Date.now(),
    });
  }
});

module.exports = router;
```

**文件**：`npc-backend/server.js`

```javascript
const searchRouter = require('./routes/search');
app.use('/api/v1/search', searchRouter);
```

---

## 前端适配

### 1. 搜索组件

**文件**：`npc-frontend/src/components/SearchBox/SearchBox.jsx`

```javascript
import React, { useState } from 'react';
import { Input, Button, List, Empty } from 'antd';
import { SearchOutlined } from '@ant-design/icons';
import api from '../../api';

const SearchBox = ({ agentId, onResultClick }) => {
  const [keyword, setKeyword] = useState('');
  const [loading, setLoading] = useState(false);
  const [results, setResults] = useState([]);
  const [total, setTotal] = useState(0);

  const handleSearch = async () => {
    if (!keyword.trim()) {
      return;
    }

    setLoading(true);
    try {
      const response = await api.search.conversations(keyword, {
        agentId,
        page: 1,
        pageSize: 20,
      });

      if (response.success) {
        setResults(response.data.results);
        setTotal(response.data.total);
      }
    } catch (error) {
      console.error('Search failed:', error);
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="search-box">
      <Input
        placeholder="搜索对话内容..."
        value={keyword}
        onChange={(e) => setKeyword(e.target.value)}
        onPressEnter={handleSearch}
        suffix={
          <Button
            type="primary"
            icon={<SearchOutlined />}
            onClick={handleSearch}
            loading={loading}
          >
            搜索
          </Button>
        }
      />

      {results.length > 0 && (
        <div className="search-results">
          <div className="search-summary">
            找到 {total} 条结果
          </div>
          <List
            dataSource={results}
            renderItem={(item) => (
              <List.Item
                onClick={() => onResultClick?.(item)}
                style={{ cursor: 'pointer' }}
              >
                <List.Item.Meta
                  title={item.agentName}
                  description={
                    <div
                      dangerouslySetInnerHTML={{
                        __html: item.highlightedContent,
                      }}
                    />
                  }
                />
                <div>{new Date(item.createdAt).toLocaleString()}</div>
              </List.Item>
            )}
          />
        </div>
      )}

      {!loading && keyword && results.length === 0 && (
        <Empty description="未找到相关对话" />
      )}
    </div>
  );
};
```

### 2. API 适配层

**文件**：`npc-frontend/src/api/adapter.js`

```javascript
search: {
  /**
   * 搜索对话
   */
  conversations: async (keyword, options = {}) => {
    const params = new URLSearchParams({
      keyword,
      ...options,
    });
    return await api.get(`/search/conversations?${params}`);
  },
}
```

---

## 测试要点

1. **搜索功能**：验证关键词搜索是否正确返回结果
2. **高亮显示**：验证关键词是否正确高亮
3. **分页功能**：验证分页是否正确
4. **权限验证**：验证用户只能搜索自己的对话
5. **空结果处理**：验证无结果时的提示

---

## 注意事项

1. **MySQL 全文索引**：
   - MySQL 5.7+ 支持中文全文搜索（需要 ngram）
   - 如果版本不支持，使用 LIKE 查询（性能较差）

2. **性能优化**：
   - 全文索引可以提高搜索性能
   - 如果数据量大，考虑使用 Elasticsearch（未来）

3. **搜索范围**：
   - 当前只搜索对话内容
   - 未来可以扩展搜索 NPC 名称、描述等

4. **高亮实现**：
   - 当前使用简单的字符串替换
   - 未来可以使用更智能的高亮算法

