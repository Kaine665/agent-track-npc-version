# 06-系统架构

**文档版本**：v1.0  
**最后更新**：2024-12-19  
**相关文档**：[功能需求](./03-功能需求.md) | [API 设计](./04-API设计.md) | [数据模型](./05-数据模型.md)

---

## 1. 架构总览

### 1.1 架构原则

- **前后端分离**：前端和后端独立开发和部署
- **RESTful API**：使用 RESTful 风格设计 API
- **事件驱动**：基于事件记录系统，便于扩展
- **可扩展性**：为未来功能扩展预留接口
- **简单优先**：V1 版本优先简单实现，避免过度设计

### 1.2 技术选型

#### 前端技术栈

| 技术 | 版本 | 说明 |
|------|------|------|
| 框架 | React / Vue.js | 根据团队技术栈选择 |
| 状态管理 | Redux / Pinia | 全局状态管理 |
| UI 组件库 | Ant Design / Element Plus | 根据框架选择 |
| HTTP 客户端 | Axios | API 请求 |
| 构建工具 | Vite / Webpack | 项目构建 |

#### 后端技术栈

| 技术 | 版本 | 说明 |
|------|------|------|
| 运行时 | Node.js | 18+ |
| 框架 | Express.js / Koa.js | Web 框架 |
| 数据库 | PostgreSQL / MySQL | 关系型数据库 |
| ORM | Sequelize / TypeORM | 数据库 ORM |
| LLM SDK | OpenAI SDK / Anthropic SDK | LLM API 调用 |

#### 基础设施

| 技术 | 说明 |
|------|------|
| 版本控制 | Git |
| 容器化 | Docker |
| 部署 | 云服务器 / 容器平台 |

---

## 2. 系统架构图

### 2.1 整体架构

```
┌─────────────────────────────────────────────────────────┐
│                      用户浏览器                          │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  │
│  │  NPC 列表页  │  │  对话页面   │  │  创建 NPC 页  │  │
│  └──────────────┘  └──────────────┘  └──────────────┘  │
└───────────────────────┬─────────────────────────────────┘
                        │ HTTP/HTTPS
                        │
┌───────────────────────▼─────────────────────────────────┐
│                    API 网关 / 负载均衡                    │
└───────────────────────┬─────────────────────────────────┘
                        │
┌───────────────────────▼─────────────────────────────────┐
│                   后端服务层                              │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  │
│  │  NPC 管理    │  │  对话服务    │  │  事件服务    │  │
│  │   模块       │  │   模块       │  │   模块       │  │
│  └──────────────┘  └──────────────┘  └──────────────┘  │
└───────┬───────────────────┬───────────────────┬───────┘
        │                   │                   │
        │                   │                   │
┌───────▼────────┐  ┌───────▼────────┐  ┌───────▼────────┐
│   数据库       │  │   LLM API       │  │   缓存（可选）  │
│  PostgreSQL    │  │  OpenAI/Claude │  │    Redis        │
└────────────────┘  └─────────────────┘  └────────────────┘
```

### 2.2 模块划分

```
后端服务
├── API 路由层
│   ├── agents.js      (NPC 管理路由)
│   ├── messages.js    (对话路由)
│   └── history.js     (历史记录路由)
│
├── 服务层
│   ├── AgentService.js      (NPC 管理服务)
│   ├── MessageService.js    (对话服务)
│   ├── EventService.js      (事件服务)
│   └── LLMService.js        (LLM API 调用服务)
│
├── 数据访问层
│   ├── AgentRepository.js   (NPC 数据访问)
│   └── EventRepository.js  (事件数据访问)
│
└── 工具层
    ├── logger.js            (日志工具)
    ├── validator.js         (数据验证工具)
    └── errorHandler.js      (错误处理工具)
```

---

## 3. 核心模块设计

### 3.1 NPC 管理模块

#### 3.1.1 职责

- 创建、查询、更新 NPC 配置
- 管理 NPC 列表
- 验证 NPC 数据

#### 3.1.2 接口设计

```javascript
// AgentService.js
class AgentService {
  /**
   * 创建 NPC
   * @param {Object} agentData - NPC 数据
   * @returns {Promise<Agent>}
   */
  async createAgent(agentData) {
    // 1. 验证数据
    // 2. 检查名称是否重复
    // 3. 保存到数据库
    // 4. 返回创建的 Agent
  }

  /**
   * 获取用户的 NPC 列表
   * @param {string} userId - 用户 ID
   * @returns {Promise<Agent[]>}
   */
  async getAgentList(userId) {
    // 1. 查询数据库
    // 2. 按最后对话时间排序
    // 3. 返回列表
  }

  /**
   * 获取 NPC 详情
   * @param {string} agentId - NPC ID
   * @param {string} userId - 用户 ID（权限验证）
   * @returns {Promise<Agent>}
   */
  async getAgentById(agentId, userId) {
    // 1. 查询数据库
    // 2. 验证权限
    // 3. 返回 Agent
  }
}
```

#### 3.1.3 数据流

```
用户请求 → API 路由 → AgentService → AgentRepository → 数据库
                ↓
            返回响应
```

---

### 3.2 对话服务模块

#### 3.2.1 职责

- 处理用户消息
- 调用 LLM API 生成回复
- 管理对话上下文
- 记录对话事件

#### 3.2.2 接口设计

```javascript
// MessageService.js
class MessageService {
  /**
   * 发送消息并获取 NPC 回复
   * @param {string} userId - 用户 ID
   * @param {string} agentId - NPC ID
   * @param {string} text - 消息内容
   * @returns {Promise<MessageResponse>}
   */
  async sendMessage(userId, agentId, text) {
    // 1. 验证参数
    // 2. 写入用户发言事件
    // 3. 获取 Agent 配置
    // 4. 获取历史事件（上下文）
    // 5. 构建 LLM Prompt
    // 6. 调用 LLM API
    // 7. 写入 NPC 回复事件
    // 8. 返回回复内容
  }
}
```

#### 3.2.3 数据流

```
用户消息 → API 路由 → MessageService
                          ├─→ EventService (记录用户发言)
                          ├─→ AgentService (获取 NPC 配置)
                          ├─→ EventService (获取历史事件)
                          ├─→ LLMService (调用 LLM API)
                          └─→ EventService (记录 NPC 回复)
                              ↓
                          返回回复
```

---

### 3.3 LLM 服务模块

#### 3.3.1 职责

- 封装 LLM API 调用
- 处理重试和错误
- 管理不同 LLM 提供商的接口差异

#### 3.3.2 接口设计

```javascript
// LLMService.js
class LLMService {
  /**
   * 调用 LLM API 生成回复
   * @param {Object} options - 调用选项
   * @param {string} options.model - 模型名称
   * @param {string} options.systemPrompt - System prompt
   * @param {Array} options.messages - 对话消息列表
   * @returns {Promise<string>}
   */
  async generateReply(options) {
    // 1. 根据 model 选择对应的 LLM 提供商
    // 2. 构建请求参数
    // 3. 调用 LLM API（带重试机制）
    // 4. 处理响应
    // 5. 返回回复内容
  }

  /**
   * 获取支持的模型列表
   * @returns {Array<string>}
   */
  getSupportedModels() {
    // 返回支持的模型列表
  }
}
```

#### 3.3.3 重试机制

```javascript
async generateReply(options) {
  const maxRetries = 2;
  const retryDelay = 1000; // 1 秒

  for (let attempt = 1; attempt <= maxRetries + 1; attempt++) {
    try {
      const response = await this.callLLMAPI(options);
      return response.content;
    } catch (error) {
      if (attempt > maxRetries) {
        throw error;
      }
      await this.sleep(retryDelay * attempt); // 指数退避
    }
  }
}
```

---

### 3.4 事件服务模块

#### 3.4.1 职责

- 记录对话事件
- 查询事件记录
- 构建对话上下文

#### 3.4.2 接口设计

```javascript
// EventService.js
class EventService {
  /**
   * 创建事件记录
   * @param {Object} eventData - 事件数据
   * @returns {Promise<Event>}
   */
  async createEvent(eventData) {
    // 1. 生成事件 ID
    // 2. 生成 sessionId
    // 3. 保存到数据库
    // 4. 返回事件对象
  }

  /**
   * 获取会话的事件列表
   * @param {string} sessionId - 会话 ID
   * @param {Object} options - 查询选项
   * @returns {Promise<Event[]>}
   */
  async getEventsBySession(sessionId, options = {}) {
    // 1. 构建查询条件
    // 2. 查询数据库
    // 3. 排序和分页
    // 4. 返回事件列表
  }

  /**
   * 获取最近的 N 条事件（用于构建上下文）
   * @param {string} sessionId - 会话 ID
   * @param {number} limit - 数量限制
   * @returns {Promise<Event[]>}
   */
  async getRecentEvents(sessionId, limit = 20) {
    // 1. 查询最近的 N 条事件
    // 2. 按时间升序排列
    // 3. 返回事件列表
  }
}
```

---

## 4. 数据流设计

### 4.1 创建 NPC 数据流

```
前端表单
  ↓ POST /api/v1/agents
API 路由层
  ↓ 验证请求参数
AgentService
  ↓ 验证业务规则
AgentRepository
  ↓ INSERT INTO agents
数据库
  ↓ 返回创建的记录
AgentRepository
  ↓ 返回 Agent 对象
AgentService
  ↓ 返回 Agent 对象
API 路由层
  ↓ 返回 JSON 响应
前端
```

### 4.2 发送消息数据流

```
前端输入框
  ↓ POST /api/v1/messages
API 路由层
  ↓ 验证请求参数
MessageService
  ├─→ EventService.createEvent (用户发言)
  ├─→ AgentService.getAgentById (获取 NPC 配置)
  ├─→ EventService.getRecentEvents (获取上下文)
  ├─→ LLMService.generateReply (调用 LLM API)
  └─→ EventService.createEvent (NPC 回复)
  ↓ 返回回复内容
API 路由层
  ↓ 返回 JSON 响应
前端
```

---

## 5. 数据库设计

### 5.1 表结构

详见 [05-数据模型.md](./05-数据模型.md)

### 5.2 索引策略

- **agents 表**：
  - `user_id` 索引：快速查询用户的 NPC 列表
  - `created_at` 索引：排序使用

- **events 表**：
  - `session_id` 索引：快速查询会话事件
  - `timestamp` 索引：排序和范围查询
  - `(session_id, timestamp)` 复合索引：优化会话历史查询

---

## 6. API 设计

### 6.1 RESTful 规范

- **资源命名**：使用名词，复数形式（如 `/agents`, `/events`）
- **HTTP 方法**：
  - GET：查询资源
  - POST：创建资源
  - PUT：更新资源（V2）
  - DELETE：删除资源（V2）

### 6.2 统一响应格式

详见 [04-API设计.md](./04-API设计.md)

---

## 7. 错误处理

### 7.1 错误分类

1. **客户端错误**（4xx）：
   - 参数验证失败
   - 资源不存在
   - 权限不足

2. **服务器错误**（5xx）：
   - 系统内部错误
   - 数据库错误
   - LLM API 错误

### 7.2 错误处理流程

```
错误发生
  ↓
捕获错误
  ↓
记录日志
  ↓
转换为统一错误格式
  ↓
返回错误响应
```

### 7.3 错误日志

- 记录错误堆栈
- 记录请求上下文（userId, agentId, 请求参数等）
- 记录错误发生时间
- 区分错误级别（ERROR, WARN, INFO）

---

## 8. 安全设计

### 8.1 数据验证

- **输入验证**：所有用户输入都进行验证
- **SQL 注入防护**：使用参数化查询
- **XSS 防护**：前端和后端都进行内容转义

### 8.2 权限控制

- **V1**：简单的 userId 验证
- **V1.5**：实现 JWT Token 认证
- **数据隔离**：确保用户只能访问自己的数据

### 8.3 API 安全

- **HTTPS**：所有 API 请求使用 HTTPS
- **限流**：防止 API 滥用（V1.5 实现）
- **CORS**：配置正确的 CORS 策略

---

## 9. 性能优化

### 9.1 数据库优化

- **索引优化**：在常用查询字段上建立索引
- **查询优化**：避免全表扫描，使用合适的 WHERE 条件
- **连接池**：使用数据库连接池管理连接

### 9.2 缓存策略（V2 考虑）

- **NPC 列表缓存**：缓存用户的 NPC 列表，TTL 5 分钟
- **对话历史缓存**：缓存最近的对话历史，TTL 10 分钟
- **Agent 配置缓存**：缓存 Agent 配置，TTL 1 小时

### 9.3 异步处理

- **事件记录**：可以考虑异步写入事件（V2 考虑）
- **日志记录**：异步记录日志，不阻塞主流程

---

## 10. 部署架构

### 10.1 开发环境

```
前端 (localhost:3000)
  ↓
后端 (localhost:8000)
  ↓
数据库 (localhost:5432)
```

### 10.2 生产环境

```
┌─────────────┐
│   CDN       │ (静态资源)
└─────────────┘
      │
      │
┌─────▼──────┐
│  负载均衡   │
└─────┬──────┘
      │
      ├──────────┬──────────┐
      │          │          │
┌─────▼──┐  ┌────▼────┐  ┌─▼─────┐
│ 后端 1 │  │ 后端 2  │  │ 后端 3│
└─────┬──┘  └────┬────┘  └─┬─────┘
      │          │          │
      └──────────┴──────────┘
                 │
      ┌──────────▼──────────┐
      │   数据库（主从）     │
      └─────────────────────┘
```

### 10.3 Docker 部署

```dockerfile
# Dockerfile 示例
FROM node:18-alpine

WORKDIR /app

COPY package*.json ./
RUN npm install

COPY . .

EXPOSE 8000

CMD ["npm", "start"]
```

```yaml
# docker-compose.yml 示例
version: '3.8'

services:
  backend:
    build: .
    ports:
      - "8000:8000"
    environment:
      - DATABASE_URL=postgresql://user:pass@db:5432/npc_db
    depends_on:
      - db

  db:
    image: postgres:15
    environment:
      - POSTGRES_DB=npc_db
      - POSTGRES_USER=user
      - POSTGRES_PASSWORD=pass
    volumes:
      - postgres_data:/var/lib/postgresql/data

volumes:
  postgres_data:
```

---

## 11. 监控和日志

### 11.1 日志系统

- **日志级别**：ERROR, WARN, INFO, DEBUG
- **日志格式**：JSON 格式，便于解析
- **日志内容**：
  - 请求日志：请求路径、方法、参数、响应时间
  - 错误日志：错误堆栈、上下文信息
  - 业务日志：关键业务操作记录

### 11.2 监控指标

- **API 性能**：响应时间、QPS、错误率
- **数据库性能**：查询时间、连接数
- **LLM API 性能**：调用时间、成功率、错误率
- **系统资源**：CPU、内存、磁盘使用率

### 11.3 告警机制（V2 实现）

- API 错误率超过阈值
- 响应时间超过阈值
- 数据库连接数过高
- LLM API 调用失败率过高

---

## 12. 扩展性设计

### 12.1 水平扩展

- **无状态设计**：后端服务无状态，可以水平扩展
- **数据库扩展**：支持读写分离、分库分表（未来）

### 12.2 功能扩展

- **插件化设计**：LLM 服务支持插件化，便于添加新的 LLM 提供商
- **事件驱动**：基于事件记录系统，便于添加新功能（如记忆系统、工具调用）

### 12.3 架构演进

- **V1**：单体架构，简单实现
- **V2**：引入缓存、消息队列（如需要）
- **V3**：微服务架构（如需要）

---

## 13. 相关文档

- [功能需求](./03-功能需求.md) - 功能需求详细说明
- [API 设计](./04-API设计.md) - API 接口设计
- [数据模型](./05-数据模型.md) - 数据结构设计
- [非功能需求](./08-非功能需求.md) - 性能、安全等非功能需求

---

**文档维护**：架构变更时，需同步更新本文档和相关技术文档。

