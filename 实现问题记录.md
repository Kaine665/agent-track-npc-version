# 实现问题记录

> 本文档记录开发过程中遇到的关键问题和解决方案

---

## 📋 已解决的关键问题

### PROB-016：前端刷新后 404 错误（SPA 路由问题）

**发现时间**：2025-11-22  
**问题类型**：代码错误  
**状态**：✅ 已解决

**问题描述**：
- 前端刷新页面后出现 404 Not Found 错误
- 问题出现在生产环境部署，本地开发环境正常

**原因**：
- React Router 使用客户端路由，刷新时浏览器直接请求服务器
- Nginx 需要配置 `try_files` 指令处理 SPA 路由

**解决方案**：
1. 前端容器 `nginx.conf` 已包含 `try_files $uri $uri/ /index.html;` 配置
2. 重新加载 Nginx 配置：
   ```bash
   sudo docker exec npc-nginx nginx -s reload
   sudo docker exec npc-frontend nginx -s reload
   ```

**相关文件**：
- `npc-frontend/nginx.conf`
- `nginx/conf.d/default.conf`

---

### PROB-015：Docker 部署后前端无法连接后端

**发现时间**：2025-11-22  
**问题类型**：配置错误  
**状态**：✅ 已解决

**问题描述**：
- Docker 部署后前端无法连接后端 API
- 错误：`Network Error` 或 `CORS` 错误

**原因**：
- 前端构建时使用了错误的 API 基础 URL
- Docker 环境中应使用相对路径 `/api`，通过 Nginx 代理

**解决方案**：
- 修改 `docker-compose.yml` 中的构建参数：
  ```yaml
  args:
    VITE_API_BASE_URL: /api
  ```

---

### PROB-017：后端数据库连接错误（ECONNREFUSED）

**发现时间**：2025-11-22  
**问题类型**：配置错误  
**状态**：✅ 已解决

**问题描述**：
- Docker 部署后后端无法连接数据库
- 错误：`ECONNREFUSED ::1:3306`

**原因**：
- 数据库连接配置使用了 `localhost`，在 Docker 环境中应使用服务名 `mysql`

**解决方案**：
- 修改 `.env` 文件：
  ```env
  DB_HOST=mysql  # 使用 Docker 服务名
  ```

---

### PROB-020：多 API Key 故障转移实现

**发现时间**：2025-11-22  
**问题类型**：功能实现  
**状态**：✅ 已解决

**问题描述**：
- 需要支持多个 API Key，当一个失败时自动切换到下一个

**解决方案**：
- 实现多 API Key 故障转移机制
- 支持格式：`OPENROUTER_API_KEY=key1,key2,key3`
- 详细说明：`npc-backend/docs/MULTI_API_KEYS.md`

---

### PROB-021：Agent列表轮询刷新导致页面闪烁

**发现时间**：2025-01-XX  
**问题类型**：用户体验问题  
**状态**：待修复

**问题描述**：
- 前端在轮询Agent列表时（每30秒自动刷新），会触发页面刷新，导致用户屏幕快速闪动
- 问题出现在AgentList页面，每次轮询都会显示加载状态，影响用户体验

**原因**：
- `fetchAgents` 函数中每次都会调用 `setLoading(true)`，导致页面显示加载状态
- 轮询刷新时，即使数据没有变化，也会触发加载状态，导致页面闪烁
- 没有区分"首次加载"和"后台刷新"的状态

**影响范围**：
- 前端：`npc-frontend/src/pages/AgentList/AgentList.jsx`
- 用户体验：页面每30秒闪烁一次，影响阅读和操作

**解决方案**：
1. **方案A（推荐）**：区分加载状态
   - 添加 `isInitialLoading` 和 `isRefreshing` 两个状态
   - 首次加载时显示全屏加载状态
   - 后台刷新时不显示加载状态，静默更新数据
   - 可以使用顶部进度条或小图标提示刷新状态

2. **方案B**：数据对比优化
   - 对比新旧数据，如果数据没有变化，不更新状态
   - 只在数据真正变化时才更新UI
   - 减少不必要的重渲染

3. **方案C**：优化轮询策略
   - 增加轮询间隔（从30秒改为60秒或更长）
   - 只在用户操作后（如创建Agent、发送消息）才立即刷新
   - 减少不必要的轮询次数

**推荐实现**：
- 使用方案A，添加静默刷新功能
- 在后台刷新时，不显示加载状态，静默更新数据
- 可以添加一个小的刷新图标或提示，告知用户数据已更新

**相关文件**：
- `npc-frontend/src/pages/AgentList/AgentList.jsx`
- `npc-frontend/src/components/Loading/Loading.jsx`

**优先级**：P1（影响用户体验）

---

## 📚 其他问题

其他已解决的问题已记录在 Git 提交历史中。如需查看详细记录，请查看项目提交历史。

---

## 🔍 问题排查指南

### 刷新页面 404
- 重新加载 Nginx 配置（见 PROB-016）

### AI 无响应
- 检查 API Key 配置
- 查看后端日志：`docker-compose logs backend`

### 数据库连接失败
- 检查 `.env` 中的 `DB_HOST` 和 `DB_PASSWORD`
- 确认 MySQL 容器运行正常：`docker-compose ps mysql`

### 前端无法连接后端
- 检查 `VITE_API_BASE_URL` 配置
- 确认 Nginx 代理配置正确

---

**更多问题排查**：查看 [DEPLOYMENT.md](./DEPLOYMENT.md) 的"常见问题"部分
