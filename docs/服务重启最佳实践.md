# æœåŠ¡é‡å¯æœ€ä½³å®è·µ

## ğŸ“‹ æ¦‚è¿°

æœ¬æ–‡æ¡£è®°å½•ä½¿ç”¨è“ç»¿éƒ¨ç½²ç­–ç•¥è¿›è¡ŒæœåŠ¡é‡å¯çš„æœ€ä½³å®è·µï¼Œç¡®ä¿æœåŠ¡æ›´æ–°æ—¶ç”¨æˆ·æ— æ„ŸçŸ¥æˆ–å½±å“æœ€å°ã€‚

---

## ğŸ¯ æ ¸å¿ƒåŸåˆ™

**æ°¸è¿œä¸è¦ç›´æ¥é‡å¯ç”Ÿäº§ç¯å¢ƒï¼Œä½¿ç”¨è“ç»¿éƒ¨ç½²ç­–ç•¥å®ç°é›¶åœæœºæ›´æ–°ã€‚**

---

## ğŸ”„ æ ‡å‡†é‡å¯æµç¨‹

### åœºæ™¯ï¼šç”¨æˆ·æ­£åœ¨ä½¿ç”¨ Blue ç¯å¢ƒï¼Œéœ€è¦æ›´æ–°é…ç½®æˆ–ä»£ç 

```bash
# ========== é˜¶æ®µ 1ï¼šå‡†å¤‡ ==========
# 1. ç¡®è®¤å½“å‰ç”Ÿäº§ç¯å¢ƒ
docker ps | grep "npc-backend"

# å¦‚æœçœ‹åˆ° npc-backend-green åœ¨è¿è¡Œ â†’ å½“å‰ç”Ÿäº§æ˜¯ Green
# å¦‚æœçœ‹åˆ° npc-backendï¼ˆæ²¡æœ‰-greenï¼‰åœ¨è¿è¡Œ â†’ å½“å‰ç”Ÿäº§æ˜¯ Blue

# ========== é˜¶æ®µ 2ï¼šæ›´æ–°å¤‡ç”¨ç¯å¢ƒ ==========
# 2. ä¿®æ”¹é…ç½®æˆ–ä»£ç 
nano .env
# æˆ–
git pull origin main

# 3. é‡å¯å¤‡ç”¨ç¯å¢ƒï¼ˆç”¨æˆ·ä¸å—å½±å“ï¼‰
# å¦‚æœå½“å‰ç”Ÿäº§æ˜¯ Blueï¼Œé‡å¯ Green
docker restart npc-backend-green npc-frontend-green

# å¦‚æœå½“å‰ç”Ÿäº§æ˜¯ Greenï¼Œé‡å¯ Blue
docker-compose restart backend frontend

# 4. ç­‰å¾…æœåŠ¡å¯åŠ¨ï¼ˆ10-30ç§’ï¼‰
sleep 15

# 5. æµ‹è¯•å¤‡ç”¨ç¯å¢ƒ
# å¦‚æœé‡å¯çš„æ˜¯ Green
curl http://localhost:8001/api/v1/health

# å¦‚æœé‡å¯çš„æ˜¯ Blue
curl http://localhost:8000/api/v1/health

# ========== é˜¶æ®µ 3ï¼šåˆ‡æ¢æµé‡ ==========
# 6. åˆ‡æ¢æµé‡åˆ°æ›´æ–°åçš„ç¯å¢ƒï¼ˆ1ç§’ï¼Œå‡ ä¹æ— æ„ŸçŸ¥ï¼‰
# å¦‚æœæ›´æ–°çš„æ˜¯ Green
./switch-to-green.sh

# å¦‚æœæ›´æ–°çš„æ˜¯ Blue
./switch-to-blue.sh

# ========== é˜¶æ®µ 4ï¼šæ›´æ–°å¦ä¸€ä¸ªç¯å¢ƒï¼ˆå¯é€‰ï¼‰ ==========
# 7. ç°åœ¨ç”¨æˆ·è®¿é—®æ›´æ–°åçš„ç¯å¢ƒï¼Œå¯ä»¥æ›´æ–°å¦ä¸€ä¸ªç¯å¢ƒäº†
# å¦‚æœåˆšæ‰æ›´æ–°çš„æ˜¯ Greenï¼Œç°åœ¨æ›´æ–° Blue
docker-compose restart backend frontend

# å¦‚æœåˆšæ‰æ›´æ–°çš„æ˜¯ Blueï¼Œç°åœ¨æ›´æ–° Green
docker restart npc-backend-green npc-frontend-green

# 8. æµ‹è¯•å¦ä¸€ä¸ªç¯å¢ƒ
curl http://localhost:8000/api/v1/health
# æˆ–
curl http://localhost:8001/api/v1/health
```

---

## ğŸ“ è¯¦ç»†æ“ä½œæ­¥éª¤

### æƒ…å†µä¸€ï¼šæ›´æ–°é…ç½®ï¼ˆ.env æ–‡ä»¶ï¼‰

```bash
# 1. æ£€æŸ¥å½“å‰ç”Ÿäº§ç¯å¢ƒ
CURRENT_ENV=$(docker ps | grep -q "npc-backend-green" && echo "green" || echo "blue")
echo "å½“å‰ç”Ÿäº§ç¯å¢ƒ: $CURRENT_ENV"

# 2. ä¿®æ”¹é…ç½®
nano .env

# 3. é‡å¯å¤‡ç”¨ç¯å¢ƒ
if [ "$CURRENT_ENV" = "blue" ]; then
    echo "é‡å¯ Green ç¯å¢ƒï¼ˆå¤‡ç”¨ï¼‰..."
    docker restart npc-backend-green npc-frontend-green
    sleep 15
    curl http://localhost:8001/api/v1/health
    echo "åˆ‡æ¢æµé‡åˆ° Green..."
    ./switch-to-green.sh
    echo "é‡å¯ Blue ç¯å¢ƒ..."
    docker-compose restart backend frontend
else
    echo "é‡å¯ Blue ç¯å¢ƒï¼ˆå¤‡ç”¨ï¼‰..."
    docker-compose restart backend frontend
    sleep 15
    curl http://localhost:8000/api/v1/health
    echo "åˆ‡æ¢æµé‡åˆ° Blue..."
    ./switch-to-blue.sh
    echo "é‡å¯ Green ç¯å¢ƒ..."
    docker restart npc-backend-green npc-frontend-green
fi

# 4. éªŒè¯ä¸¤ä¸ªç¯å¢ƒéƒ½æ­£å¸¸
echo "éªŒè¯æœåŠ¡..."
curl http://localhost:8000/api/v1/health
curl http://localhost:8001/api/v1/health
```

### æƒ…å†µäºŒï¼šæ›´æ–°ä»£ç 

```bash
# 1. æ‹‰å–æœ€æ–°ä»£ç 
git pull origin main

# 2. é‡æ–°éƒ¨ç½²åˆ°å¤‡ç”¨ç¯å¢ƒï¼ˆä½¿ç”¨è“ç»¿éƒ¨ç½²è„šæœ¬ï¼‰
# å¦‚æœå½“å‰ç”Ÿäº§æ˜¯ Blueï¼Œéƒ¨ç½²åˆ° Green
./deploy-blue-green.sh main

# 3. æµ‹è¯• Green ç¯å¢ƒ
curl http://localhost:8001/api/v1/health
# æµè§ˆå™¨è®¿é—®: http://your-server-ip:3001

# 4. åˆ‡æ¢æµé‡åˆ° Green
./switch-to-green.sh

# 5. ç°åœ¨å¯ä»¥æ›´æ–° Blue äº†ï¼ˆå¦‚æœéœ€è¦ï¼‰
docker-compose up -d --build backend frontend
```

### æƒ…å†µä¸‰ï¼šç´§æ€¥ä¿®å¤ï¼ˆå¿…é¡»ç«‹å³é‡å¯ï¼‰

```bash
# âš ï¸ åªæœ‰åœ¨ç´§æ€¥æƒ…å†µä¸‹æ‰ç›´æ¥é‡å¯ç”Ÿäº§ç¯å¢ƒ

# 1. é€‰æ‹©ä½å³°æœŸï¼ˆå¦‚æœå¯èƒ½ï¼‰
# 2. å¿«é€Ÿé‡å¯
docker-compose restart backend

# 3. éªŒè¯æ¢å¤
curl http://localhost:8000/api/v1/health

# é¢„è®¡ä¸­æ–­æ—¶é—´ï¼š6-12ç§’
```

---

## â±ï¸ æ—¶é—´å¯¹æ¯”

| æ–¹å¼ | ä¸­æ–­æ—¶é—´ | ç”¨æˆ·ä½“éªŒ |
|------|---------|---------|
| **ç›´æ¥é‡å¯ç”Ÿäº§** | 6-12ç§’ | âŒ ç”¨æˆ·æ— æ³•è®¿é—® |
| **è“ç»¿éƒ¨ç½²ç­–ç•¥** | <1ç§’ | âœ… å‡ ä¹æ— æ„ŸçŸ¥ |

---

## ğŸ›¡ï¸ å®‰å…¨æ£€æŸ¥æ¸…å•

é‡å¯å‰æ£€æŸ¥ï¼š

- [ ] ç¡®è®¤å½“å‰ç”Ÿäº§ç¯å¢ƒï¼ˆBlue è¿˜æ˜¯ Greenï¼‰
- [ ] å¤‡ä»½é…ç½®æ–‡ä»¶ï¼ˆå¦‚æœä¿®æ”¹äº† .envï¼‰
- [ ] ç¡®è®¤å¤‡ç”¨ç¯å¢ƒå¯ä»¥æ­£å¸¸å¯åŠ¨
- [ ] å‡†å¤‡å›æ»šæ–¹æ¡ˆï¼ˆå¦‚æœå‡ºé—®é¢˜ï¼‰

é‡å¯åæ£€æŸ¥ï¼š

- [ ] å¥åº·æ£€æŸ¥é€šè¿‡
- [ ] æ ¸å¿ƒåŠŸèƒ½æ­£å¸¸
- [ ] æ—¥å¿—æ— é”™è¯¯
- [ ] ç”¨æˆ·åé¦ˆæ­£å¸¸

---

## ğŸ” å¿«é€Ÿåˆ¤æ–­å½“å‰ç”Ÿäº§ç¯å¢ƒ

```bash
# æ–¹æ³•ä¸€ï¼šæ£€æŸ¥ Nginx é…ç½®
docker exec npc-nginx cat /etc/nginx/conf.d/default.conf | grep "server npc-backend"

# å¦‚æœçœ‹åˆ° "npc-backend-green" â†’ å½“å‰ç”Ÿäº§æ˜¯ Green
# å¦‚æœçœ‹åˆ° "backend:8000" â†’ å½“å‰ç”Ÿäº§æ˜¯ Blue

# æ–¹æ³•äºŒï¼šæ£€æŸ¥å®¹å™¨è¿è¡ŒçŠ¶æ€
docker ps | grep "npc-backend-green"
# å¦‚æœè¿è¡Œ â†’ å¯èƒ½æ˜¯ç”Ÿäº§ç¯å¢ƒï¼ˆéœ€è¦ç¡®è®¤ Nginx é…ç½®ï¼‰

# æ–¹æ³•ä¸‰ï¼šæŸ¥çœ‹éƒ¨ç½²è„šæœ¬è¾“å‡º
# éƒ¨ç½²è„šæœ¬ä¼šæ˜¾ç¤ºå½“å‰ç”Ÿäº§ç¯å¢ƒ
```

---

## ğŸ“Š å®Œæ•´æµç¨‹å›¾

```
å¼€å§‹
  â†“
æ£€æŸ¥å½“å‰ç”Ÿäº§ç¯å¢ƒï¼ˆBlue/Greenï¼‰
  â†“
ä¿®æ”¹é…ç½®æˆ–ä»£ç 
  â†“
é‡å¯å¤‡ç”¨ç¯å¢ƒ
  â†“
ç­‰å¾…å¯åŠ¨ï¼ˆ15ç§’ï¼‰
  â†“
æµ‹è¯•å¤‡ç”¨ç¯å¢ƒ
  â†“
åˆ‡æ¢æµé‡åˆ°å¤‡ç”¨ç¯å¢ƒï¼ˆ<1ç§’ï¼‰
  â†“
ç”¨æˆ·ç°åœ¨è®¿é—®æ›´æ–°åçš„ç¯å¢ƒ âœ…
  â†“
é‡å¯å¦ä¸€ä¸ªç¯å¢ƒï¼ˆå¯é€‰ï¼‰
  â†“
å®Œæˆ
```

---

## ğŸ’¡ æœ€ä½³å®è·µæ€»ç»“

1. **æ°¸è¿œä½¿ç”¨è“ç»¿éƒ¨ç½²ç­–ç•¥**
   - å…ˆæ›´æ–°å¤‡ç”¨ç¯å¢ƒ
   - æµ‹è¯•é€šè¿‡ååˆ‡æ¢æµé‡
   - ç”¨æˆ·å‡ ä¹æ— æ„ŸçŸ¥

2. **é¿å…ç›´æ¥é‡å¯ç”Ÿäº§ç¯å¢ƒ**
   - é™¤éç´§æ€¥æƒ…å†µ
   - é€‰æ‹©ä½å³°æœŸ
   - æå‰é€šçŸ¥ç”¨æˆ·ï¼ˆå¦‚æœæœ‰ç”¨æˆ·ç¾¤ï¼‰

3. **ä¿æŒä¸¤ä¸ªç¯å¢ƒåŒæ­¥**
   - æ›´æ–°åç¡®ä¿ä¸¤ä¸ªç¯å¢ƒéƒ½æ­£å¸¸
   - æ–¹ä¾¿å¿«é€Ÿåˆ‡æ¢å’Œå›æ»š

4. **ç›‘æ§å’ŒéªŒè¯**
   - é‡å¯åç«‹å³éªŒè¯
   - è§‚å¯Ÿæ—¥å¿—å’Œç”¨æˆ·åé¦ˆ
   - å‡†å¤‡å›æ»šæ–¹æ¡ˆ

---

## ğŸš¨ ç´§æ€¥æƒ…å†µå¤„ç†

å¦‚æœæ›´æ–°åå‡ºç°é—®é¢˜ï¼š

```bash
# å¿«é€Ÿå›æ»šåˆ°å¦ä¸€ä¸ªç¯å¢ƒ
# å¦‚æœ Green æœ‰é—®é¢˜ï¼Œå›æ»šåˆ° Blue
./switch-to-blue.sh

# å¦‚æœ Blue æœ‰é—®é¢˜ï¼Œå›æ»šåˆ° Green
./switch-to-green.sh

# å›æ»šæ—¶é—´ï¼š<1ç§’ âœ…
```

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [è“ç»¿éƒ¨ç½²ä½¿ç”¨æŒ‡å—](./BLUE-GREEN-DEPLOYMENT.md)
- [CORS é…ç½®è¯´æ˜](./CORSé…ç½®è¯´æ˜.md)
- [éƒ¨ç½²æŒ‡å—](../DEPLOYMENT.md)

---

## ğŸ”„ æ›´æ–°è®°å½•

- 2025-01-XXï¼šåˆ›å»ºæ–‡æ¡£ï¼Œè®°å½•è“ç»¿éƒ¨ç½²é‡å¯ç­–ç•¥

