# å¤šåº”ç”¨æ¶æ„æ–¹æ¡ˆ

**æ–‡æ¡£ç‰ˆæœ¬**ï¼šv1.0.0  
**åˆ›å»ºæ—¶é—´**ï¼š2025-01-XX  
**é€‚ç”¨ç‰ˆæœ¬**ï¼šv1.5+

---

## ğŸ“‹ é—®é¢˜èƒŒæ™¯

å½“å‰é¡¹ç›®åªæœ‰ C ç«¯ï¼ˆå®¢æˆ·ç«¯ï¼‰åº”ç”¨ï¼Œä½†éœ€è¦ï¼š
1. **ç®¡ç†åå°**ï¼šç”¨äºç³»ç»Ÿç®¡ç†ã€æ•°æ®ç»Ÿè®¡ã€ç”¨æˆ·ç®¡ç†ç­‰
2. **å…¶ä»–æœåŠ¡**ï¼šå¯èƒ½åŒ…æ‹¬æ•°æ®åˆ†ææœåŠ¡ã€å®šæ—¶ä»»åŠ¡ã€ç¬¬ä¸‰æ–¹é›†æˆç­‰
3. **è¿™äº›åº”ç”¨ä¸èƒ½å’Œ C ç«¯å†™åœ¨ä¸€èµ·**ï¼šéœ€è¦ä»£ç åˆ†ç¦»ã€ç‹¬ç«‹éƒ¨ç½²ã€ç‹¬ç«‹ç»´æŠ¤

---

## ğŸ—ï¸ æ¶æ„æ–¹æ¡ˆ

### æ–¹æ¡ˆä¸€ï¼šMonorepo + å…±äº«åç«¯ï¼ˆæ¨èï¼‰

**æ ¸å¿ƒæ€æƒ³**ï¼šå¤šä¸ªå‰ç«¯åº”ç”¨å…±äº«åŒä¸€ä¸ªåç«¯ APIï¼Œé€šè¿‡è·¯ç”±å‰ç¼€åŒºåˆ†ä¸åŒåº”ç”¨ã€‚

#### é¡¹ç›®ç»“æ„

```
agent-track/v1.5/
â”œâ”€â”€ npc-backend/              # åç«¯ APIï¼ˆå…±äº«ï¼‰
â”‚   â”œâ”€â”€ routes/
â”‚   â”‚   â”œâ”€â”€ api/              # C ç«¯ APIï¼ˆ/api/v1/*ï¼‰
â”‚   â”‚   â”‚   â”œâ”€â”€ agents.js
â”‚   â”‚   â”‚   â”œâ”€â”€ users.js
â”‚   â”‚   â”‚   â””â”€â”€ messages.js
â”‚   â”‚   â””â”€â”€ admin/            # ç®¡ç†åå° APIï¼ˆ/api/admin/*ï¼‰
â”‚   â”‚       â”œâ”€â”€ users.js      # ç”¨æˆ·ç®¡ç†
â”‚   â”‚       â”œâ”€â”€ agents.js     # NPC ç®¡ç†
â”‚   â”‚       â”œâ”€â”€ statistics.js # æ•°æ®ç»Ÿè®¡
â”‚   â”‚       â””â”€â”€ system.js    # ç³»ç»Ÿé…ç½®
â”‚   â”œâ”€â”€ services/             # ä¸šåŠ¡é€»è¾‘å±‚ï¼ˆå…±äº«ï¼‰
â”‚   â”œâ”€â”€ repositories/         # æ•°æ®è®¿é—®å±‚ï¼ˆå…±äº«ï¼‰
â”‚   â””â”€â”€ middleware/
â”‚       â””â”€â”€ adminAuth.js      # ç®¡ç†åå°è®¤è¯ä¸­é—´ä»¶
â”‚
â”œâ”€â”€ npc-frontend/             # C ç«¯å‰ç«¯
â”‚   â””â”€â”€ src/
â”‚
â”œâ”€â”€ admin-frontend/           # ç®¡ç†åå°å‰ç«¯ï¼ˆæ–°å»ºï¼‰
â”‚   â”œâ”€â”€ package.json
â”‚   â”œâ”€â”€ vite.config.js
â”‚   â””â”€â”€ src/
â”‚       â”œâ”€â”€ pages/
â”‚       â”‚   â”œâ”€â”€ Dashboard/    # ä»ªè¡¨ç›˜
â”‚       â”‚   â”œâ”€â”€ Users/        # ç”¨æˆ·ç®¡ç†
â”‚       â”‚   â”œâ”€â”€ Agents/       # NPC ç®¡ç†
â”‚       â”‚   â””â”€â”€ Statistics/   # æ•°æ®ç»Ÿè®¡
â”‚       â””â”€â”€ api/
â”‚           â””â”€â”€ admin.js     # ç®¡ç†åå° API è°ƒç”¨
â”‚
â”œâ”€â”€ docker-compose.yml        # ç»Ÿä¸€ç¼–æ’
â””â”€â”€ package.json             # æ ¹ç›®å½•è„šæœ¬
```

#### ä¼˜ç‚¹

âœ… **ä»£ç å¤ç”¨**ï¼šå…±äº«åç«¯ä»£ç ï¼ˆServicesã€Repositoriesï¼‰  
âœ… **ç»Ÿä¸€æ•°æ®åº“**ï¼šæ‰€æœ‰åº”ç”¨ä½¿ç”¨åŒä¸€ä¸ªæ•°æ®åº“  
âœ… **ç»Ÿä¸€éƒ¨ç½²**ï¼šå¯ä»¥é€šè¿‡ Docker Compose ç»Ÿä¸€ç®¡ç†  
âœ… **æ˜“äºç»´æŠ¤**ï¼šä»£ç é›†ä¸­ï¼Œä¾¿äºç®¡ç†  

#### ç¼ºç‚¹

âš ï¸ **è€¦åˆåº¦è¾ƒé«˜**ï¼šæ‰€æœ‰åº”ç”¨å…±äº«åŒä¸€ä¸ªåç«¯è¿›ç¨‹  
âš ï¸ **æ‰©å±•æ€§æœ‰é™**ï¼šå¦‚æœæŸä¸ªåº”ç”¨éœ€è¦ç‹¬ç«‹æ‰©å±•ï¼Œéœ€è¦æ‹†åˆ†  

---

### æ–¹æ¡ˆäºŒï¼šç‹¬ç«‹åç«¯ + API Gatewayï¼ˆé€‚åˆå¤§å‹é¡¹ç›®ï¼‰

**æ ¸å¿ƒæ€æƒ³**ï¼šæ¯ä¸ªåº”ç”¨æœ‰ç‹¬ç«‹çš„åç«¯ï¼Œé€šè¿‡ API Gateway ç»Ÿä¸€å…¥å£ã€‚

#### é¡¹ç›®ç»“æ„

```
agent-track/v1.5/
â”œâ”€â”€ npc-backend/              # C ç«¯åç«¯ API
â”‚   â”œâ”€â”€ routes/
â”‚   â”œâ”€â”€ services/
â”‚   â””â”€â”€ repositories/
â”‚
â”œâ”€â”€ admin-backend/            # ç®¡ç†åå°åç«¯ APIï¼ˆæ–°å»ºï¼‰
â”‚   â”œâ”€â”€ routes/
â”‚   â”œâ”€â”€ services/
â”‚   â””â”€â”€ repositories/
â”‚
â”œâ”€â”€ shared/                   # å…±äº«ä»£ç åº“ï¼ˆæ–°å»ºï¼‰
â”‚   â”œâ”€â”€ repositories/         # å…±äº«æ•°æ®è®¿é—®å±‚
â”‚   â”œâ”€â”€ services/             # å…±äº«ä¸šåŠ¡é€»è¾‘
â”‚   â””â”€â”€ utils/                # å…±äº«å·¥å…·å‡½æ•°
â”‚
â”œâ”€â”€ npc-frontend/             # C ç«¯å‰ç«¯
â”‚
â”œâ”€â”€ admin-frontend/           # ç®¡ç†åå°å‰ç«¯
â”‚
â”œâ”€â”€ api-gateway/              # API Gatewayï¼ˆå¯é€‰ï¼Œæ–°å»ºï¼‰
â”‚   â””â”€â”€ nginx.conf            # è·¯ç”±é…ç½®
â”‚
â””â”€â”€ docker-compose.yml
```

#### ä¼˜ç‚¹

âœ… **å®Œå…¨è§£è€¦**ï¼šæ¯ä¸ªåº”ç”¨ç‹¬ç«‹éƒ¨ç½²ã€ç‹¬ç«‹æ‰©å±•  
âœ… **é«˜å¯ç”¨æ€§**ï¼šæŸä¸ªåº”ç”¨æ•…éšœä¸å½±å“å…¶ä»–åº”ç”¨  
âœ… **çµæ´»æ‰©å±•**ï¼šå¯ä»¥æ ¹æ®éœ€æ±‚ç‹¬ç«‹æ‰©å±•æŸä¸ªåº”ç”¨  

#### ç¼ºç‚¹

âš ï¸ **ä»£ç é‡å¤**ï¼šéœ€è¦ç»´æŠ¤å¤šä»½ç›¸ä¼¼ä»£ç   
âš ï¸ **éƒ¨ç½²å¤æ‚**ï¼šéœ€è¦ç®¡ç†å¤šä¸ªæœåŠ¡  
âš ï¸ **æ•°æ®åº“è¿æ¥**ï¼šæ¯ä¸ªåº”ç”¨éƒ½éœ€è¦è¿æ¥æ•°æ®åº“  

---

### æ–¹æ¡ˆä¸‰ï¼šæ··åˆæ–¹æ¡ˆï¼ˆæ¨èç”¨äºå½“å‰é¡¹ç›®ï¼‰

**æ ¸å¿ƒæ€æƒ³**ï¼šC ç«¯å’Œç®¡ç†åå°å…±äº«åç«¯ï¼Œå…¶ä»–ç‰¹æ®ŠæœåŠ¡ç‹¬ç«‹ã€‚

#### é¡¹ç›®ç»“æ„

```
agent-track/v1.5/
â”œâ”€â”€ npc-backend/              # ä¸»åç«¯ï¼ˆC ç«¯ + ç®¡ç†åå°ï¼‰
â”‚   â”œâ”€â”€ routes/
â”‚   â”‚   â”œâ”€â”€ api/              # C ç«¯ API
â”‚   â”‚   â””â”€â”€ admin/            # ç®¡ç†åå° API
â”‚   â”œâ”€â”€ services/             # å…±äº«ä¸šåŠ¡é€»è¾‘
â”‚   â””â”€â”€ repositories/         # å…±äº«æ•°æ®è®¿é—®
â”‚
â”œâ”€â”€ npc-frontend/             # C ç«¯å‰ç«¯
â”‚
â”œâ”€â”€ admin-frontend/           # ç®¡ç†åå°å‰ç«¯
â”‚
â”œâ”€â”€ services/                 # ç‹¬ç«‹æœåŠ¡ï¼ˆæ–°å»ºï¼‰
â”‚   â”œâ”€â”€ scheduler/            # å®šæ—¶ä»»åŠ¡æœåŠ¡
â”‚   â”‚   â”œâ”€â”€ package.json
â”‚   â”‚   â””â”€â”€ index.js
â”‚   â”œâ”€â”€ analytics/            # æ•°æ®åˆ†ææœåŠ¡
â”‚   â”‚   â”œâ”€â”€ package.json
â”‚   â”‚   â””â”€â”€ index.js
â”‚   â””â”€â”€ webhook/              # Webhook æœåŠ¡
â”‚       â”œâ”€â”€ package.json
â”‚       â””â”€â”€ index.js
â”‚
â””â”€â”€ docker-compose.yml
```

---

## ğŸ¯ æ¨èæ–¹æ¡ˆï¼šæ–¹æ¡ˆä¸€ï¼ˆMonorepo + å…±äº«åç«¯ï¼‰

åŸºäºå½“å‰é¡¹ç›®è§„æ¨¡ï¼Œ**æ¨èä½¿ç”¨æ–¹æ¡ˆä¸€**ï¼ŒåŸå› ï¼š

1. **å½“å‰é¡¹ç›®è§„æ¨¡é€‚ä¸­**ï¼šä¸éœ€è¦è¿‡åº¦æ‹†åˆ†
2. **ä»£ç å¤ç”¨æœ€å¤§åŒ–**ï¼šå…±äº« Services å’Œ Repositories
3. **éƒ¨ç½²ç®€å•**ï¼šç»Ÿä¸€ç®¡ç†ï¼Œé™ä½è¿ç»´æˆæœ¬
4. **æ˜“äºæ‰©å±•**ï¼šåç»­å¦‚æœéœ€è¦ç‹¬ç«‹æœåŠ¡ï¼Œå¯ä»¥é€æ­¥æ‹†åˆ†

---

## ğŸ“ å®æ–½æ­¥éª¤

### ç¬¬ä¸€æ­¥ï¼šé‡æ„åç«¯è·¯ç”±ç»“æ„

**ç›®æ ‡**ï¼šå°† C ç«¯ API å’Œç®¡ç†åå° API åˆ†ç¦»

```javascript
// npc-backend/server.js

// C ç«¯ APIï¼ˆ/api/v1/*ï¼‰
app.use("/api/v1/agents", require("./routes/api/agents"));
app.use("/api/v1/users", require("./routes/api/users"));
app.use("/api/v1/messages", require("./routes/api/messages"));

// ç®¡ç†åå° APIï¼ˆ/api/admin/*ï¼‰
app.use("/api/admin/users", require("./routes/admin/users"));
app.use("/api/admin/agents", require("./routes/admin/agents"));
app.use("/api/admin/statistics", require("./routes/admin/statistics"));
```

### ç¬¬äºŒæ­¥ï¼šåˆ›å»ºç®¡ç†åå°è®¤è¯ä¸­é—´ä»¶

```javascript
// npc-backend/middleware/adminAuth.js

const { authenticate } = require('./auth');
const userRepository = require('../repositories/UserRepository');

/**
 * ç®¡ç†åå°è®¤è¯ä¸­é—´ä»¶
 * è¦æ±‚ç”¨æˆ·å¿…é¡»æ˜¯ç®¡ç†å‘˜è§’è‰²
 */
async function adminAuth(req, res, next) {
  // 1. å…ˆè¿›è¡Œæ™®é€šè®¤è¯
  authenticate(req, res, async () => {
    try {
      // 2. æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æ˜¯ç®¡ç†å‘˜
      const user = await userRepository.findById(req.user.userId);
      
      if (!user || user.role !== 'admin') {
        return res.status(403).json({
          success: false,
          error: {
            code: 'FORBIDDEN',
            message: 'éœ€è¦ç®¡ç†å‘˜æƒé™',
          },
          timestamp: Date.now(),
        });
      }
      
      // 3. é™„åŠ ç®¡ç†å‘˜ä¿¡æ¯åˆ°è¯·æ±‚å¯¹è±¡
      req.admin = {
        userId: user.id,
        username: user.username,
        role: user.role,
      };
      
      next();
    } catch (error) {
      return res.status(500).json({
        success: false,
        error: {
          code: 'SYSTEM_ERROR',
          message: 'è®¤è¯å¤±è´¥',
        },
        timestamp: Date.now(),
      });
    }
  });
}

module.exports = { adminAuth };
```

### ç¬¬ä¸‰æ­¥ï¼šåˆ›å»ºç®¡ç†åå°å‰ç«¯é¡¹ç›®

```bash
# åœ¨é¡¹ç›®æ ¹ç›®å½•åˆ›å»ºç®¡ç†åå°å‰ç«¯
cd agent-track/v1.5
npm create vite@latest admin-frontend -- --template react

cd admin-frontend
npm install
npm install antd react-router-dom
```

### ç¬¬å››æ­¥ï¼šé…ç½® Docker Compose

```yaml
# docker-compose.yml

services:
  # ... ç°æœ‰æœåŠ¡ ...
  
  # ç®¡ç†åå°å‰ç«¯
  admin-frontend:
    build:
      context: ./admin-frontend
      dockerfile: Dockerfile
    container_name: npc-admin-frontend
    restart: unless-stopped
    ports:
      - "${ADMIN_FRONTEND_PORT:-3001}:80"
    depends_on:
      - backend
    networks:
      - npc-network
```

### ç¬¬äº”æ­¥ï¼šé…ç½® Nginx è·¯ç”±

```nginx
# nginx/conf.d/default.conf

# C ç«¯å‰ç«¯
location / {
    proxy_pass http://frontend:80;
}

# ç®¡ç†åå°å‰ç«¯
location /admin {
    proxy_pass http://admin-frontend:80;
    rewrite ^/admin/(.*)$ /$1 break;
}

# C ç«¯ API
location /api/v1 {
    proxy_pass http://backend:8000;
}

# ç®¡ç†åå° API
location /api/admin {
    proxy_pass http://backend:8000;
}
```

---

## ğŸ” æƒé™ç®¡ç†

### ç”¨æˆ·è§’è‰²è®¾è®¡

```sql
-- åœ¨ users è¡¨ä¸­æ·»åŠ  role å­—æ®µ
ALTER TABLE users ADD COLUMN role VARCHAR(20) DEFAULT 'user';

-- è§’è‰²ç±»å‹
-- 'user': æ™®é€šç”¨æˆ·ï¼ˆC ç«¯ï¼‰
-- 'admin': ç®¡ç†å‘˜ï¼ˆç®¡ç†åå°ï¼‰
-- 'super_admin': è¶…çº§ç®¡ç†å‘˜
```

### API æƒé™æ§åˆ¶

```javascript
// npc-backend/routes/admin/users.js

const express = require('express');
const router = express.Router();
const { adminAuth } = require('../../middleware/adminAuth');
const userService = require('../../services/UserService');

// æ‰€æœ‰ç®¡ç†åå°è·¯ç”±éƒ½éœ€è¦ adminAuth ä¸­é—´ä»¶
router.use(adminAuth);

// è·å–æ‰€æœ‰ç”¨æˆ·åˆ—è¡¨
router.get('/', async (req, res) => {
  // åªæœ‰ç®¡ç†å‘˜å¯ä»¥è®¿é—®
  const users = await userService.getAllUsers();
  res.json({ success: true, data: users });
});
```

---

## ğŸ“¦ ç‹¬ç«‹æœåŠ¡ç¤ºä¾‹

å¦‚æœéœ€è¦ç‹¬ç«‹æœåŠ¡ï¼ˆå¦‚å®šæ—¶ä»»åŠ¡ï¼‰ï¼Œå¯ä»¥è¿™æ ·ç»„ç»‡ï¼š

```javascript
// services/scheduler/index.js

/**
 * å®šæ—¶ä»»åŠ¡æœåŠ¡
 * ç‹¬ç«‹è¿è¡Œï¼Œä¸ä¾èµ–ä¸»åç«¯
 */

const cron = require('node-cron');
const { query } = require('../../npc-backend/config/database');

// æ¯å¤©å‡Œæ™¨æ¸…ç†è¿‡æœŸæ•°æ®
cron.schedule('0 0 * * *', async () => {
  console.log('å¼€å§‹æ¸…ç†è¿‡æœŸæ•°æ®...');
  // æ¸…ç†é€»è¾‘
});

// æ¯å°æ—¶ç»Ÿè®¡ç”¨æˆ·æ´»è·ƒåº¦
cron.schedule('0 * * * *', async () => {
  console.log('å¼€å§‹ç»Ÿè®¡ç”¨æˆ·æ´»è·ƒåº¦...');
  // ç»Ÿè®¡é€»è¾‘
});
```

åœ¨ `docker-compose.yml` ä¸­æ·»åŠ ï¼š

```yaml
services:
  scheduler:
    build:
      context: ./services/scheduler
    container_name: npc-scheduler
    restart: unless-stopped
    environment:
      DB_HOST: mysql
      DB_USER: ${DB_USER:-root}
      DB_PASSWORD: ${DB_PASSWORD:-your_mysql_password}
      DB_NAME: ${DB_NAME:-npc_db}
    depends_on:
      - mysql
    networks:
      - npc-network
```

---

## ğŸš€ éƒ¨ç½²å»ºè®®

### å¼€å‘ç¯å¢ƒ

```bash
# å¯åŠ¨æ‰€æœ‰æœåŠ¡
npm run dev

# åˆ†åˆ«å¯åŠ¨
npm run dev:backend      # åç«¯ï¼ˆåŒ…å« C ç«¯å’Œç®¡ç†åå° APIï¼‰
npm run dev:frontend      # C ç«¯å‰ç«¯
npm run dev:admin         # ç®¡ç†åå°å‰ç«¯ï¼ˆéœ€è¦æ·»åŠ è„šæœ¬ï¼‰
```

### ç”Ÿäº§ç¯å¢ƒ

```bash
# ä½¿ç”¨ Docker Compose ç»Ÿä¸€éƒ¨ç½²
docker-compose up -d

# æˆ–è€…åˆ†åˆ«éƒ¨ç½²
# 1. åç«¯ï¼ˆåŒ…å«æ‰€æœ‰ APIï¼‰
cd npc-backend && npm start

# 2. C ç«¯å‰ç«¯
cd npc-frontend && npm run build && serve -s dist

# 3. ç®¡ç†åå°å‰ç«¯
cd admin-frontend && npm run build && serve -s dist
```

---

## ğŸ“Š ç›®å½•ç»“æ„å¯¹æ¯”

### å½“å‰ç»“æ„ï¼ˆåªæœ‰ C ç«¯ï¼‰

```
npc-backend/
â”œâ”€â”€ routes/
â”‚   â”œâ”€â”€ agents.js      # C ç«¯è·¯ç”±
â”‚   â””â”€â”€ users.js       # C ç«¯è·¯ç”±
```

### æ¨èç»“æ„ï¼ˆC ç«¯ + ç®¡ç†åå°ï¼‰

```
npc-backend/
â”œâ”€â”€ routes/
â”‚   â”œâ”€â”€ api/           # C ç«¯ API
â”‚   â”‚   â”œâ”€â”€ agents.js
â”‚   â”‚   â””â”€â”€ users.js
â”‚   â””â”€â”€ admin/         # ç®¡ç†åå° API
â”‚       â”œâ”€â”€ users.js
â”‚       â””â”€â”€ agents.js
â”œâ”€â”€ services/          # å…±äº«ä¸šåŠ¡é€»è¾‘
â””â”€â”€ repositories/      # å…±äº«æ•°æ®è®¿é—®
```

---

## âœ… æ€»ç»“

1. **æ¨èæ–¹æ¡ˆ**ï¼šMonorepo + å…±äº«åç«¯ï¼ˆæ–¹æ¡ˆä¸€ï¼‰
2. **æ ¸å¿ƒåŸåˆ™**ï¼š
   - C ç«¯å’Œç®¡ç†åå°å…±äº«åç«¯ä»£ç 
   - é€šè¿‡è·¯ç”±å‰ç¼€åŒºåˆ†ä¸åŒåº”ç”¨ï¼ˆ`/api/v1` vs `/api/admin`ï¼‰
   - ç‹¬ç«‹çš„å‰ç«¯é¡¹ç›®
   - ç‰¹æ®ŠæœåŠ¡å¯ä»¥ç‹¬ç«‹éƒ¨ç½²
3. **ä¼˜åŠ¿**ï¼š
   - ä»£ç å¤ç”¨æœ€å¤§åŒ–
   - éƒ¨ç½²ç®€å•
   - æ˜“äºç»´æŠ¤
   - åç»­å¯ä»¥é€æ­¥æ‹†åˆ†

---

## ğŸ”„ åç»­æ‰©å±•

å¦‚æœé¡¹ç›®è§„æ¨¡æ‰©å¤§ï¼Œå¯ä»¥è€ƒè™‘ï¼š

1. **å¾®æœåŠ¡æ‹†åˆ†**ï¼šå°†æŸäº›åŠŸèƒ½æ‹†åˆ†ä¸ºç‹¬ç«‹æœåŠ¡
2. **API Gateway**ï¼šç»Ÿä¸€ç®¡ç†æ‰€æœ‰ API å…¥å£
3. **æœåŠ¡ç½‘æ ¼**ï¼šä½¿ç”¨ Istio ç­‰æœåŠ¡ç½‘æ ¼æŠ€æœ¯
4. **æ¶ˆæ¯é˜Ÿåˆ—**ï¼šå¼•å…¥ RabbitMQ/Kafka å¤„ç†å¼‚æ­¥ä»»åŠ¡

ä½†ç›®å‰é˜¶æ®µï¼Œ**æ–¹æ¡ˆä¸€å·²ç»è¶³å¤Ÿ**ï¼Œé¿å…è¿‡åº¦è®¾è®¡ã€‚

