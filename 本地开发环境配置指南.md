# 本地开发环境配置指南

> **文档版本**：v1.0  
> **最后更新**：2025-01-XX  
> **适用系统**：Windows 10/11

---

## 📋 概述

本文档帮助你在本地配置开发环境，确保项目能在本地正常运行。云端部署使用 Docker，而本地开发需要手动配置数据库和环境变量。

---

## ✅ 前置条件检查

在开始配置之前，请确认：

- [ ] **Node.js** v18+ 已安装
- [ ] **MySQL** 8.0+ 已安装并运行
- [ ] **npm** 9+ 已安装
- [ ] 知道 **MySQL root 密码**

---

## 🔧 配置步骤

### 步骤 1：安装依赖

在项目根目录和子目录中安装依赖：

```bash
# 安装根目录依赖（用于一键启动）
npm install

# 安装后端依赖
cd npc-backend
npm install

# 安装前端依赖
cd ../npc-frontend
npm install
```

---

### 步骤 2：配置后端环境变量

后端支持两种配置方式：**YAML 配置文件**（推荐）或 **.env 文件**。

#### 方式 A：使用 YAML 配置文件（推荐）

编辑 `npc-backend/config.yaml`：

```yaml
# 服务器配置
server:
  port: 8000

# 数据库配置
database:
  host: localhost
  port: 3306
  user: root
  password: "你的MySQL密码"  # ⚠️ 请填写你的 MySQL root 密码
  name: npc_db

# LLM 提供商配置
llm:
  # OpenRouter 配置（推荐）
  # 支持多个 API Key，用逗号分隔，系统会自动故障转移
  openrouter:
    enabled: true
    api_key: "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,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"  # ⚠️ 多个 API Key 用逗号分隔
  # OpenAI 配置（可选）
  openai:
    enabled: false
    api_key: ""
  
  # DeepSeek 配置（可选）
  deepseek:
    enabled: false
    api_key: ""
```

**重要配置项**：
- `database.password`: 你的 MySQL root 密码
- `llm.openrouter.api_key`: OpenRouter API Key（必需，用于 AI 对话）

#### 方式 B：使用 .env 文件（备选）

在 `npc-backend` 目录下创建 `.env` 文件：

```env
# 服务器配置
PORT=8000

# 数据库配置（重要！）
DB_HOST=localhost
DB_PORT=3306
DB_USER=root
DB_PASSWORD=你的MySQL密码    # ⚠️ 请填写你的 MySQL root 密码
DB_NAME=npc_db

# LLM 配置（必需）
OPENROUTER_API_KEY=你的OpenRouter_API_Key  # ⚠️ 请填写你的 API Key
ENABLE_OPENROUTER=true

# 其他 LLM（可选）
OPENAI_API_KEY=
ENABLE_OPENAI=false
DEEPSEEK_API_KEY=
ENABLE_DEEPSEEK=false
```

---

### 步骤 3：初始化数据库

在 `npc-backend` 目录下运行：

```bash
npm run db:init
```

**预期输出**：
```
🚀 Starting database initialization...
📡 Connecting to MySQL server...
✅ Connected to MySQL server
📖 Reading SQL file...
✅ SQL file read successfully
⚙️  Executing SQL statements...
✅ SQL statements executed successfully
🔍 Verifying tables...
✅ Tables created: users, agents, events, sessions
🎉 Database initialization completed!
```

**如果失败**：
- 检查 MySQL 服务是否运行：`net start MySQL`（Windows）
- 检查密码是否正确
- 检查 MySQL 端口是否为 3306

---

### 步骤 4：配置前端环境变量

在 `npc-frontend` 目录下创建 `.env` 文件：

```env
# 前端 API 配置
# 本地开发：使用 http://localhost:8000
# 如果后端在不同端口，请修改为对应端口
VITE_API_BASE_URL=http://localhost:8000

# API 模式（可选）
# mock: 使用 Mock 数据（不连接后端）
# http: 使用真实后端 API（默认）
VITE_API_MODE=http
```

**说明**：
- `VITE_API_BASE_URL`: 后端 API 地址，本地开发使用 `http://localhost:8000`
- `VITE_API_MODE`: 可选 `mock`（Mock 数据）或 `http`（真实 API）

---

### 步骤 5：启动服务

#### 方式 A：一键启动（推荐）

在项目根目录运行：

```bash
npm run dev
```

这将同时启动：
- 后端服务：http://localhost:8000
- 前端服务：http://localhost:3000

#### 方式 B：分别启动

**终端 1 - 启动后端**：
```bash
cd npc-backend
npm run dev
```

**终端 2 - 启动前端**：
```bash
cd npc-frontend
npm run dev
```

---

## 🔍 验证配置

### 1. 检查后端是否启动成功

访问 http://localhost:8000，应该看到后端服务运行中的提示。

**检查后端日志**：
- 应该看到：`✅ Loaded configuration from config.yaml` 或 `✅ Loaded configuration from .env`
- 应该看到：`📊 Database Config: { host: 'localhost', port: 3306, ... }`
- 应该看到：`🚀 Server is running on port 8000`

### 2. 检查前端是否启动成功

访问 http://localhost:3000，应该看到前端页面。

**检查前端控制台**：
- 打开浏览器开发者工具（F12）
- 查看 Console，不应该有网络错误
- 查看 Network，API 请求应该指向 `http://localhost:8000`

### 3. 测试功能

1. **注册/登录**：创建用户账号
2. **创建 NPC**：创建一个测试 NPC
3. **发送消息**：与 NPC 对话，测试 AI 回复

---

## ❓ 常见问题

### 问题 1：数据库连接失败

**错误信息**：
```
❌ Database Query Error: connect ECONNREFUSED ::1:3306
```

**解决方案**：
1. 检查 MySQL 服务是否运行：
   ```bash
   # Windows PowerShell
   Get-Service MySQL
   ```
2. 检查 MySQL 端口：
   ```bash
   netstat -an | findstr 3306
   ```
3. 检查密码是否正确（在 `config.yaml` 或 `.env` 中）
4. 尝试使用 `127.0.0.1` 而不是 `localhost`（修改 `DB_HOST`）

---

### 问题 2：API Key 未配置

**错误信息**：
```
API_KEY_MISSING: OpenRouter API Key is not configured
```

**解决方案**：
1. 检查 `config.yaml` 或 `.env` 中是否配置了 `OPENROUTER_API_KEY`
2. 确保 API Key 格式正确（以 `sk-or-v1-` 开头）
3. 重启后端服务

---

### 问题 3：前端无法连接后端

**错误信息**：
```
Network Error: Failed to fetch
```

**解决方案**：
1. 检查后端是否启动（访问 http://localhost:8000）
2. 检查前端 `.env` 中的 `VITE_API_BASE_URL` 是否正确
3. 检查浏览器控制台的 CORS 错误（如果有，需要后端配置 CORS）
4. 重启前端服务（修改 `.env` 后需要重启）

---

### 问题 4：端口被占用

**错误信息**：
```
Error: listen EADDRINUSE: address already in use :::8000
```

**解决方案**：
1. 修改端口（在 `config.yaml` 或 `.env` 中修改 `PORT=8001`）
2. 或关闭占用端口的进程：
   ```bash
   # Windows PowerShell
   netstat -ano | findstr :8000
   taskkill /PID <进程ID> /F
   ```

---

### 问题 5：数据库表不存在

**错误信息**：
```
Table 'npc_db.users' doesn't exist
```

**解决方案**：
运行数据库初始化脚本：
```bash
cd npc-backend
npm run db:init
```

---

## 📝 配置检查清单

在开始开发前，请确认：

- [ ] ✅ Node.js v18+ 已安装
- [ ] ✅ MySQL 8.0+ 已安装并运行
- [ ] ✅ 后端依赖已安装（`cd npc-backend && npm install`）
- [ ] ✅ 前端依赖已安装（`cd npc-frontend && npm install`）
- [ ] ✅ 后端配置文件已创建（`config.yaml` 或 `.env`）
- [ ] ✅ MySQL 密码已配置
- [ ] ✅ OpenRouter API Key 已配置
- [ ] ✅ 数据库已初始化（`npm run db:init`）
- [ ] ✅ 前端 `.env` 已配置（`VITE_API_BASE_URL`）
- [ ] ✅ 后端服务启动成功（http://localhost:8000）
- [ ] ✅ 前端服务启动成功（http://localhost:3000）
- [ ] ✅ 功能测试通过（注册、创建 NPC、发送消息）

---

## 🔄 与云端配置的差异

### 云端（Docker）
- 使用 Docker Compose 管理所有服务
- MySQL 在容器中运行，使用服务名 `mysql` 连接
- 环境变量通过 `.env` 文件传递给容器
- 前端通过 Nginx 代理访问后端（`/api`）

### 本地（开发环境）
- 需要手动安装和配置 MySQL
- MySQL 在本地运行，使用 `localhost` 连接
- 可以使用 `config.yaml` 或 `.env` 配置
- 前端直接访问后端（`http://localhost:8000`）

---

## 📚 相关文档

- [后端 README](./npc-backend/README.md) - 后端详细说明
- [前端 README](./npc-frontend/README.md) - 前端详细说明
- [数据库配置指南](./npc-backend/docs/DATABASE_SETUP.md) - 数据库设置说明
- [部署指南](./DEPLOYMENT.md) - 生产环境部署说明

---

## 💡 提示

1. **开发时建议使用 `config.yaml`**：配置更清晰，易于管理
2. **API Key 安全**：不要将 API Key 提交到 Git，使用 `.gitignore` 排除配置文件
3. **数据库备份**：开发前建议备份数据库，避免数据丢失
4. **日志查看**：开发时注意查看后端控制台日志，有助于排查问题

---

**配置完成后，就可以开始本地开发了！** 🎉

