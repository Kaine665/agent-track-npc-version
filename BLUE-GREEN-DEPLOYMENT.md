# è“ç»¿éƒ¨ç½²ä½¿ç”¨æŒ‡å—

## æ¦‚è¿°

è“ç»¿éƒ¨ç½²ï¼ˆBlue-Green Deploymentï¼‰æ˜¯ä¸€ç§é›¶åœæœºéƒ¨ç½²ç­–ç•¥ï¼Œå…è®¸ä½ åœ¨ç”Ÿäº§ç¯å¢ƒä¸­åŒæ—¶è¿è¡Œä¸¤ä¸ªç‰ˆæœ¬çš„æœåŠ¡ï¼Œç¡®è®¤æ–°ç‰ˆæœ¬æ— è¯¯åå†åˆ‡æ¢æµé‡ã€‚

## è„šæœ¬è¯´æ˜

### 1. `deploy-blue-green.sh` - éƒ¨ç½²æ–°ç‰ˆæœ¬
- **åŠŸèƒ½**ï¼šéƒ¨ç½²æ–°ç‰ˆæœ¬åˆ°å¤‡ç”¨ç«¯å£ï¼ˆBlue/Greenï¼‰
- **ç”¨æ³•**ï¼š`./deploy-blue-green.sh [åˆ†æ”¯å]`
- **ç¤ºä¾‹**ï¼š`./deploy-blue-green.sh v1.5`
- **è¯´æ˜**ï¼š
  - è‡ªåŠ¨æ£€æµ‹å½“å‰è¿è¡Œçš„æ˜¯ Blue è¿˜æ˜¯ Green ç¯å¢ƒ
  - å°†æ–°ç‰ˆæœ¬éƒ¨ç½²åˆ°å¦ä¸€ä¸ªç¯å¢ƒ
  - Blue ç¯å¢ƒï¼šç«¯å£ 8000ï¼ˆåç«¯ï¼‰ã€3000ï¼ˆå‰ç«¯ï¼‰
  - Green ç¯å¢ƒï¼šç«¯å£ 8001ï¼ˆåç«¯ï¼‰ã€3001ï¼ˆå‰ç«¯ï¼‰

### 2. `switch-to-green.sh` - åˆ‡æ¢æµé‡åˆ° Green
- **åŠŸèƒ½**ï¼šå°† Nginx æµé‡åˆ‡æ¢åˆ° Green ç¯å¢ƒ
- **ç”¨æ³•**ï¼š`./switch-to-green.sh`
- **è¯´æ˜**ï¼šæ›´æ–° Nginx é…ç½®ï¼ŒæŒ‡å‘ Green ç¯å¢ƒçš„å®¹å™¨

### 3. `switch-to-blue.sh` - åˆ‡æ¢æµé‡åˆ° Blue
- **åŠŸèƒ½**ï¼šå°† Nginx æµé‡åˆ‡æ¢å› Blue ç¯å¢ƒ
- **ç”¨æ³•**ï¼š`./switch-to-blue.sh`
- **è¯´æ˜**ï¼šæ¢å¤ Nginx é…ç½®ï¼ŒæŒ‡å‘ Blue ç¯å¢ƒï¼ˆdocker-compose æœåŠ¡ï¼‰

### 4. `rollback-to-blue.sh` - å›æ»šåˆ° Blue
- **åŠŸèƒ½**ï¼šå¿«é€Ÿå›æ»šåˆ° Blue ç¯å¢ƒ
- **ç”¨æ³•**ï¼š`./rollback-to-blue.sh`
- **è¯´æ˜**ï¼šåˆ‡æ¢æµé‡ + å¯é€‰åœæ­¢ Green ç¯å¢ƒ

### 5. `cleanup-old-version.sh` - æ¸…ç†æ—§ç‰ˆæœ¬
- **åŠŸèƒ½**ï¼šæ¸…ç†ä¸å†ä½¿ç”¨çš„æ—§ç‰ˆæœ¬å®¹å™¨å’Œé•œåƒ
- **ç”¨æ³•**ï¼š`./cleanup-old-version.sh`
- **è¯´æ˜**ï¼šç¡®è®¤æ–°ç‰ˆæœ¬è¿è¡Œæ­£å¸¸åï¼Œé‡Šæ”¾èµ„æº

## ä½¿ç”¨æµç¨‹

### ç¬¬ä¸€æ¬¡éƒ¨ç½²æ–°ç‰ˆæœ¬

```bash
# 1. éƒ¨ç½²æ–°ç‰ˆæœ¬åˆ° Green ç¯å¢ƒ
./deploy-blue-green.sh v1.5

# 2. æµ‹è¯•æ–°ç‰ˆæœ¬ï¼ˆé€šè¿‡ç«¯å£ 8001 å’Œ 3001ï¼‰
curl http://localhost:8001/api/v1/health
# æµè§ˆå™¨è®¿é—®: http://your-server-ip:3001

# 3. ç¡®è®¤æ— è¯¯åï¼Œåˆ‡æ¢æµé‡åˆ° Green
./switch-to-green.sh

# 4. æµ‹è¯•ç”Ÿäº§ç¯å¢ƒï¼ˆé€šè¿‡ Nginxï¼Œç«¯å£ 80ï¼‰
curl http://your-server-ip/api/v1/health

# 5. ç¡®è®¤ä¸€åˆ‡æ­£å¸¸åï¼Œæ¸…ç†æ—§ç‰ˆæœ¬
./cleanup-old-version.sh
```

### å†æ¬¡éƒ¨ç½²æ–°ç‰ˆæœ¬ï¼ˆæ­¤æ—¶ Green æ˜¯ç”Ÿäº§ç¯å¢ƒï¼‰

```bash
# 1. éƒ¨ç½²æ–°ç‰ˆæœ¬åˆ° Blue ç¯å¢ƒï¼ˆè‡ªåŠ¨æ£€æµ‹ï¼‰
./deploy-blue-green.sh main

# 2. æµ‹è¯•æ–°ç‰ˆæœ¬ï¼ˆé€šè¿‡ç«¯å£ 8000 å’Œ 3000ï¼‰
curl http://localhost:8000/api/v1/health

# 3. åˆ‡æ¢æµé‡åˆ° Blue
./switch-to-blue.sh

# 4. æ¸…ç†æ—§ç‰ˆæœ¬ï¼ˆGreenï¼‰
./cleanup-old-version.sh
```

### å¿«é€Ÿå›æ»š

å¦‚æœæ–°ç‰ˆæœ¬æœ‰é—®é¢˜ï¼Œå¯ä»¥å¿«é€Ÿå›æ»šï¼š

```bash
# å›æ»šåˆ° Blue ç¯å¢ƒ
./rollback-to-blue.sh

# æˆ–å›æ»šåˆ° Green ç¯å¢ƒï¼ˆéœ€è¦æ‰‹åŠ¨åˆ‡æ¢ï¼‰
./switch-to-green.sh
```

## ç¯å¢ƒè¯´æ˜

### Blue ç¯å¢ƒ
- **åç«¯ç«¯å£**ï¼š8000
- **å‰ç«¯ç«¯å£**ï¼š3000
- **å®¹å™¨å**ï¼š`npc-backend`, `npc-frontend`ï¼ˆdocker-compose ç®¡ç†ï¼‰
- **ç½‘ç»œ**ï¼šé€šè¿‡ docker-compose ç½‘ç»œè®¿é—®

### Green ç¯å¢ƒ
- **åç«¯ç«¯å£**ï¼š8001
- **å‰ç«¯ç«¯å£**ï¼š3001
- **å®¹å™¨å**ï¼š`npc-backend-green`, `npc-frontend-green`
- **ç½‘ç»œ**ï¼šåŠ å…¥ç›¸åŒçš„ Docker ç½‘ç»œ

## æ³¨æ„äº‹é¡¹

1. **æ•°æ®åº“å…±äº«**ï¼šä¸¤ä¸ªç¯å¢ƒå…±äº«åŒä¸€ä¸ª MySQL æ•°æ®åº“
2. **ç«¯å£å†²çª**ï¼šç¡®ä¿ç«¯å£ 8000ã€8001ã€3000ã€3001 æœªè¢«å ç”¨
3. **ç½‘ç»œè¦æ±‚**ï¼šGreen ç¯å¢ƒå®¹å™¨éœ€è¦åŠ å…¥ä¸ Nginx ç›¸åŒçš„ Docker ç½‘ç»œ
4. **å¤‡ä»½é…ç½®**ï¼šåˆ‡æ¢æµé‡å‰ä¼šè‡ªåŠ¨å¤‡ä»½ Nginx é…ç½®
5. **å¥åº·æ£€æŸ¥**ï¼šéƒ¨ç½²è„šæœ¬ä¼šè‡ªåŠ¨è¿›è¡Œå¥åº·æ£€æŸ¥

## æ•…éšœæ’æŸ¥

### æ–°ç‰ˆæœ¬æ— æ³•å¯åŠ¨
```bash
# æŸ¥çœ‹æ—¥å¿—
docker logs npc-backend-green
docker logs npc-frontend-green
```

### Nginx é…ç½®é”™è¯¯
```bash
# æµ‹è¯•é…ç½®
docker exec npc-nginx nginx -t

# æŸ¥çœ‹å¤‡ä»½é…ç½®
ls -la nginx/conf.d/default.conf.backup.*
```

### ç½‘ç»œé—®é¢˜
```bash
# æ£€æŸ¥å®¹å™¨ç½‘ç»œ
docker network inspect agent-track-npc-version_npc-network

# æ£€æŸ¥å®¹å™¨æ˜¯å¦åœ¨åŒä¸€ç½‘ç»œ
docker inspect npc-backend-green | grep NetworkMode
docker inspect npc-nginx | grep NetworkMode
```

## æƒé™è®¾ç½®

é¦–æ¬¡ä½¿ç”¨å‰ï¼Œéœ€è¦æ·»åŠ æ‰§è¡Œæƒé™ï¼š

```bash
chmod +x deploy-blue-green.sh
chmod +x switch-to-green.sh
chmod +x switch-to-blue.sh
chmod +x rollback-to-blue.sh
chmod +x cleanup-old-version.sh
```

---

## ğŸ”„ æœåŠ¡é‡å¯æœ€ä½³å®è·µ

**é‡è¦ï¼šæ°¸è¿œä¸è¦ç›´æ¥é‡å¯ç”Ÿäº§ç¯å¢ƒï¼Œä½¿ç”¨è“ç»¿éƒ¨ç½²ç­–ç•¥å®ç°é›¶åœæœºæ›´æ–°ã€‚**

### æ ‡å‡†é‡å¯æµç¨‹

```bash
# 1. æ£€æŸ¥å½“å‰ç”Ÿäº§ç¯å¢ƒ
docker ps | grep "npc-backend"

# 2. ä¿®æ”¹é…ç½®æˆ–ä»£ç 
nano .env
# æˆ–
git pull origin main

# 3. é‡å¯å¤‡ç”¨ç¯å¢ƒï¼ˆç”¨æˆ·ä¸å—å½±å“ï¼‰
# å¦‚æœå½“å‰ç”Ÿäº§æ˜¯ Blueï¼Œé‡å¯ Green
docker restart npc-backend-green npc-frontend-green

# å¦‚æœå½“å‰ç”Ÿäº§æ˜¯ Greenï¼Œé‡å¯ Blue
docker-compose restart backend frontend

# 4. æµ‹è¯•å¤‡ç”¨ç¯å¢ƒ
curl http://localhost:8001/api/v1/health  # Green
# æˆ–
curl http://localhost:8000/api/v1/health  # Blue

# 5. åˆ‡æ¢æµé‡åˆ°æ›´æ–°åçš„ç¯å¢ƒï¼ˆ<1ç§’ï¼Œå‡ ä¹æ— æ„ŸçŸ¥ï¼‰
./switch-to-green.sh  # æˆ– ./switch-to-blue.sh

# 6. ç°åœ¨å¯ä»¥æ›´æ–°å¦ä¸€ä¸ªç¯å¢ƒäº†ï¼ˆå¯é€‰ï¼‰
```

**è¯¦ç»†è¯´æ˜è¯·æŸ¥çœ‹ï¼š[æœåŠ¡é‡å¯æœ€ä½³å®è·µ](./æœåŠ¡é‡å¯æœ€ä½³å®è·µ.md)**

## ä¸åŸæœ‰è„šæœ¬çš„åŒºåˆ«

- **`update-production.sh`**ï¼šç›´æ¥æ›´æ–°å½“å‰è¿è¡Œçš„æœåŠ¡ï¼ˆæ»šåŠ¨æ›´æ–°ï¼‰
- **`deploy-blue-green.sh`**ï¼šéƒ¨ç½²æ–°ç‰ˆæœ¬åˆ°å¤‡ç”¨ç¯å¢ƒï¼Œå¯ä»¥æµ‹è¯•åå†åˆ‡æ¢

å»ºè®®ï¼š
- é‡è¦æ›´æ–°ï¼šä½¿ç”¨è“ç»¿éƒ¨ç½²
- å°æ›´æ–°ï¼šä½¿ç”¨æ»šåŠ¨æ›´æ–°

